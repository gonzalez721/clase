<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="theme-color" content="#000000">
<title>Manilla NFC - América de Cali | Login</title>
<link href="/static/favicon.ico" rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'america-red': '#D32F2F',
                        'america-dark': '#111111',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style id="qr-video-controls-hide">
    </style>
    <style id="tribuna-select-style">
      /* Solo para el select de TRIBUNA */
      #seatTribuna {
        -webkit-appearance: none; -moz-appearance: none; appearance: none;
        background: linear-gradient(180deg, rgba(31,41,55,.85), rgba(17,24,39,.95));
        color: #fff;
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 0.65rem 2.25rem 0.65rem 0.9rem;
        font-weight: 600;
        line-height: 1.2;
        box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 10px 18px rgba(0,0,0,.35);
        transition: border-color .2s ease, box-shadow .2s ease, background .2s ease, transform .06s ease;
      }
      #seatTribuna:hover { border-color: #4B5563; }
      #seatTribuna:focus { outline: none; border-color: #D32F2F; box-shadow: 0 0 0 3px rgba(211,47,47,.35), inset 0 1px 0 rgba(255,255,255,.06); }
      #seatTribuna:active { transform: translateY(1px); }
      #seatTribuna:disabled { opacity: .6; cursor: not-allowed; }
      #seatTribuna::-ms-expand { display: none; } /* IE arrow */
      #seatTribuna option { background: #0B1220; color: #fff; }
      /* Oculta cualquier overlay/controles por defecto del <video> en iOS Safari */
      #qrVideo::-webkit-media-controls-start-playback-button,
      #qrVideo::-webkit-media-controls,
      video::-webkit-media-controls {
        display: none !important;
        -webkit-appearance: none;
        opacity: 0 !important; /* evita destellos */
      }
      /* Clase para ocultar el video hasta que la cámara esté lista */
      #qrVideo.media-hidden { opacity: 0; }
    </style>


<style id="button-compact-style">
  /* Botones compactos, adaptados al contenido */
  button, .btn{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .35rem;
    max-width: 100%;
    min-width: auto;
    min-height: 28px;
    padding: .25rem .5rem;
    border-radius: 8px;
    line-height: 1.2;
    font-size: 0.78rem !important;
    font-weight: 600;
  }
  button span, .btn span, button .label, .btn .label{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: block;
  }
  /* Ajuste de paddings */
  .py-5:where(button, .btn){padding-top:.35rem!important;padding-bottom:.35rem!important}
  .py-4:where(button, .btn){padding-top:.3rem!important;padding-bottom:.3rem!important}
  .py-3:where(button, .btn){padding-top:.25rem!important;padding-bottom:.25rem!important}
  .px-6:where(button, .btn){padding-left:.55rem!important;padding-right:.55rem!important}
  .px-5:where(button, .btn){padding-left:.5rem!important;padding-right:.5rem!important}
  .px-4:where(button, .btn){padding-left:.45rem!important;padding-right:.45rem!important}
  /* Radios normalizados más compactos */
  button[class~="rounded-3xl"], .btn[class~="rounded-3xl"]{border-radius:.9rem!important}
  button[class~="rounded-2xl"], .btn[class~="rounded-2xl"]{border-radius:.75rem!important}
  button[class~="rounded-xl"], .btn[class~="rounded-xl"]{border-radius:.65rem!important}
</style>
<style id="global-oneline-fix">
  /* Chips / Pills / Dash-chip: 1 línea + elipsis en todo lado */
  #sectionNav .chip, .chip, .promo-chip, .promo-pill, .dash-chip, [data-chip],
  #promoQuickRow button, #promoQuickRow .btn {
    display:inline-flex !important;
    align-items:center;
    gap:.45rem;
    max-width:100%;
    white-space:nowrap !important;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  #sectionNav .chip *, .chip *, .promo-chip *, .promo-pill *, .dash-chip * {
    white-space:inherit !important; /* heredan nowrap del padre */
  }

  /* Evita que hijos flex empujen y causen saltos/overflow */
  .section-nav, #sectionNav, #promoQuickRow, #promosContainer, #engagementSection{ min-width:0; }
  .section-nav *, #sectionNav *, #promoQuickRow *, #promosContainer *, #engagementSection *{ min-width:0; }

  /* Cabeceras y títulos dentro de cards: elipsis si no caben */
  .card-clean h2, .card-clean h3,
  .dash-card h2, .dash-card .font-medium,
  .promo-card h3 {
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
</style>
    <script id="profile-script">
    (function() {
      const PROFILE_KEY = 'userProfile';
      let profileModal = null;
      let profileButton = null;
      let profileQuickAction = null;
      let profileAvatar = null;
      let closeProfileModal = null;
      let profileForm = null;
      let profileImage = null;
      let profilePreview = null;
      let profileGreeting = null;
      let profileInitial = null;
      let profileAvatarImg = null;

      function loadProfile() {
        const profile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || {
          firstName: 'Valentina',
          lastName: '',
          age: '',
          jersey: '',
          idol: '',
          stand: '',
          phone: '',
          document: '',
          image: null
        };
        return profile;
      }

      function saveProfile(profile) {
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
        updateProfileDisplay(profile);
      }

      function updateProfileDisplay(profile) {
        if (profileGreeting) profileGreeting.textContent = `¡Vamos, ${profile.firstName || 'Hincha'}!`;

        // Metadatos compactos en el header (camiseta, ídolo, tribuna)
        const meta = [];
        if (profile.jersey) meta.push(`Camiseta #${profile.jersey}`);
        if (profile.idol) meta.push(`Ídolo: ${profile.idol}`);
        if (profile.stand) meta.push(`Tribuna: ${profile.stand}`);
        const metaEl = document.getElementById('profileMeta');
        if (metaEl) metaEl.textContent = meta.join(' • ');

        // Avatar / Inicial
        if (profile.image && profileAvatarImg && profileInitial) {
          profileAvatarImg.src = profile.image;
          profileAvatarImg.classList.remove('hidden');
          profileInitial.classList.add('hidden');
        } else {
          if (profileInitial) profileInitial.textContent = (profile.firstName||'U').charAt(0).toUpperCase();
          if (profileInitial) profileInitial.classList.remove('hidden');
          if (profileAvatarImg) profileAvatarImg.classList.add('hidden');
        }
      }

      // Cropper integration
      let cropper = null;
      let croppedDataUrl = null;
      const cropperModalEl = () => document.getElementById('cropperModal');
      const cropperImageEl = () => document.getElementById('cropperImage');
      const cropperApplyBtn = () => document.getElementById('cropperApply');
      const cropperCancelBtn = () => document.getElementById('cropperCancel');

      function destroyCropper(){ if (cropper){ try { cropper.destroy(); } catch(_){} cropper = null; } }

      function openCropperWith(dataUrl){
        const modal = cropperModalEl(); const img = cropperImageEl();
        if (!modal || !img) return;
        img.src = dataUrl;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        // Delay to ensure image rendered
        setTimeout(()=>{
          try {
            cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 1, background: false });
          } catch(_) {}
        }, 20);
      }

      function handleImageChange(e) {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
          const dataUrl = evt.target.result;
          openCropperWith(dataUrl);
        };
        reader.readAsDataURL(file);
      }

      function onProfileSubmit(e) {
        e.preventDefault(); // ← evita recarga
        const profile = loadProfile();
        profile.firstName = (document.getElementById('profileFirstName')?.value || '').trim() || 'Usuario';
        profile.lastName  = (document.getElementById('profileLastName')?.value  || '').trim();
        profile.age       = (document.getElementById('profileAge')?.value       || '').trim();
        profile.jersey    = (document.getElementById('profileJersey')?.value    || '').trim();
        profile.idol      = (document.getElementById('profileIdol')?.value      || '').trim();
        profile.stand     = (document.getElementById('profileStand')?.value     || '').trim();
        profile.phone     = (document.getElementById('profilePhone')?.value     || '').trim();
        profile.document  = (document.getElementById('profileDocument')?.value  || '').trim();

        const persist = () => { saveProfile(profile); croppedDataUrl = null; };
        if (croppedDataUrl) {
          profile.image = croppedDataUrl;
          persist();
        } else if (profileImage && profileImage.files && profileImage.files[0]) {
          const reader = new FileReader();
          reader.onload = function(evt) { profile.image = evt.target.result; persist(); };
          reader.readAsDataURL(profileImage.files[0]);
        } else { persist(); }

        profileModal?.classList.add('hidden');
        showToast('Perfil actualizado', 'success');
      }

      function openProfileModal() {
        const profile = loadProfile();
        const first = document.getElementById('profileFirstName');
        const last  = document.getElementById('profileLastName');
        const age   = document.getElementById('profileAge');
        const jersey= document.getElementById('profileJersey');
        const idol  = document.getElementById('profileIdol');
        const stand = document.getElementById('profileStand');
        const phone = document.getElementById('profilePhone');
        const doc   = document.getElementById('profileDocument');
        if (first) first.value = profile.firstName || '';
        if (last)  last.value  = profile.lastName  || '';
        if (age)   age.value   = profile.age       || '';
        if (jersey) jersey.value = profile.jersey  || '';
        if (idol)   idol.value   = profile.idol    || '';
        if (stand)  stand.value  = profile.stand   || '';
        if (phone) phone.value = profile.phone     || '';
        if (doc)   doc.value   = profile.document  || '';

        if (profilePreview) profilePreview.innerHTML = '';
        if (profile.image && profilePreview) {
          const img = document.createElement('img');
          img.src = profile.image;
          img.classList.add('w-full','h-full','object-cover');
          profilePreview.appendChild(img);
        } else if (profilePreview) {
          profilePreview.textContent = (profile.firstName||'U').charAt(0).toUpperCase();
        }

        profileModal?.classList.remove('hidden');
        profileModal?.classList.add('flex');
        window.trapFocus?.(profileModal);
        feather.replace();
      }

      // Exponer apertura de perfil para menú global
      window.openProfileModal = openProfileModal;

      document.addEventListener('DOMContentLoaded', () => {
        profileModal      = document.getElementById('profileModal');
        profileButton     = document.getElementById('profileButton');
        profileQuickAction= document.getElementById('dashboardProfileCta');
        profileAvatar     = document.getElementById('profileAvatar');
        closeProfileModal = document.getElementById('closeProfileModal');
        profileForm       = document.getElementById('profileForm');
        profileImage      = document.getElementById('profileImage');
        profilePreview    = document.getElementById('profilePreview');
        profileGreeting   = document.getElementById('profileGreeting');
        profileInitial    = document.getElementById('profileInitial');
        profileAvatarImg  = document.getElementById('profileAvatarImg');

        // ← REGISTRAR LISTENERS AQUÍ (ya hay nodos)
        profileImage?.addEventListener('change', handleImageChange);
        profileForm?.addEventListener('submit', onProfileSubmit);

        // Cropper modal controls
        cropperApplyBtn()?.addEventListener('click', () => {
          if (!cropper) return;
          try {
            // Obtén el recorte cuadrado
            const square = cropper.getCroppedCanvas({ width: 256, height: 256, imageSmoothingQuality: 'high' });
            // Dibuja un PNG con máscara circular para preservar transparencia
            const mask = document.createElement('canvas');
            mask.width = 256; mask.height = 256;
            const ctx = mask.getContext('2d');
            ctx.clearRect(0,0,256,256);
            ctx.save();
            ctx.beginPath();
            ctx.arc(128, 128, 128, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
            ctx.drawImage(square, 0, 0, 256, 256);
            ctx.restore();
            croppedDataUrl = mask.toDataURL('image/png');
            // Actualiza la vista previa circular
            if (profilePreview){
              profilePreview.innerHTML = '';
              const img = document.createElement('img');
              img.src = croppedDataUrl; img.classList.add('w-full','h-full','object-cover');
              profilePreview.appendChild(img);
            }
          } catch(_) {}
          const m = cropperModalEl(); if (m){ m.classList.add('hidden'); m.classList.remove('flex'); }
          destroyCropper();
        });
        const closeCropper = () => { const m=cropperModalEl(); if (m){ m.classList.add('hidden'); m.classList.remove('flex'); } destroyCropper(); };
        cropperCancelBtn()?.addEventListener('click', closeCropper);
        cropperModalEl()?.addEventListener('click', (e)=>{ if (e.target === cropperModalEl()) closeCropper(); });

        profileButton?.addEventListener('click', openProfileModal);
        profileQuickAction?.addEventListener('click', openProfileModal);
        profileAvatar?.addEventListener('click', openProfileModal);
        closeProfileModal?.addEventListener('click', () => {
          profileModal?.classList.add('hidden');
          profileModal?.classList.remove('flex');
          window.releaseFocus?.();
        });
        document.getElementById('cancelProfileModal')?.addEventListener('click', () => {
          profileModal?.classList.add('hidden');
          profileModal?.classList.remove('flex');
          window.releaseFocus?.();
        });
        profileModal?.addEventListener('click', (e) => {
          if (e.target === profileModal) {
            profileModal.classList.add('hidden');
            profileModal.classList.remove('flex');
            window.releaseFocus?.();
          }
        });

        const profile = loadProfile();
        updateProfileDisplay(profile);
      });
    })();
    </script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<!-- Cropper.js for image cropping -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<style id="cropper-circle-style">
  /* Hacer circular el área de recorte visual */
  #cropperModal .cropper-view-box, 
  #cropperModal .cropper-face { border-radius: 50% !important; }
  /* Opcional: reforzar el aro y sombreado */
  #cropperModal .cropper-view-box { outline: 2px solid rgba(255,255,255,.85); }
  #cropperModal .cropper-dashed, 
  #cropperModal .cropper-center { display: none !important; }
</style>
<style id="moment-cropper-style">
  #momentCropperModal .cropper-view-box { border-radius: 10px !important; outline: 2px solid rgba(255,255,255,.6); }
  #momentCropperModal .cropper-dashed, #momentCropperModal .cropper-center { display: none !important; }
  .aspect-btn.ring-2.ring-america-red { box-shadow: 0 0 0 2px rgba(211,47,47,.35); }
  .aspect-btn { transition: transform .06s ease; }
  .aspect-btn:active { transform: translateY(1px); }
  #momentCropperModal .cropper-container { max-height: 70vh; }
</style>
<!-- UI Harmonization -->
<!-- ...existing code... -->
<style id="harmonize-ui">
  :root{
    --primary: #D32F2F;
    --primary-700: #b91c1c;
    --surface: #0B0F19;
    --surface-2: #141414;
    --surface-3: #0f1012;
    --panel: #151515;
    --panel-2: #101010;
    --border: #2c2c2c;
    --muted: #9b9b9b;
    --text: #E5E7EB;
    --radius: 16px;
    --space-1: .25rem; --space-2: .5rem; --space-3: .75rem; --space-4: 1rem; --space-6: 1.5rem;
    --font-size-base: 16px;
    --line-height-base: 1.5;
    --shadow-soft: 0 8px 32px rgba(0,0,0,0.18), 0 1.5px 0 rgba(255,255,255,0.04) inset;
    --shadow-btn: 0 2px 12px rgba(211,47,47,0.13), 0 1.5px 0 rgba(255,255,255,0.06) inset;
    --transition: all 180ms cubic-bezier(0.22, 1, 0.36, 1);
    /* Cambia el fondo glass a opaco o menos transparente */
    --glass-bg: #18181b; /* antes: rgba(18,18,22,0.68) */
    --glass-blur: blur(8px) saturate(1.08); /* opcional: menos blur */
    --glass-border: 1.5px solid rgba(255,255,255,0.10);
    --glass-light: linear-gradient(90deg,rgba(255,255,255,0.08) 0%,rgba(255,255,255,0.02) 100%);
  }
  html, body{
    font-size: var(--font-size-base);
    line-height: var(--line-height-base);
    font-family: 'Inter', 'Inter Display', sans-serif;
    background: #000 !important;
    color: var(--text);
    letter-spacing: 0.01em;
    min-height: 100vh;
    scroll-behavior: smooth;
  }
  /* Responsive container for the authentication panel */
  .auth-shell {
    width: min(100%, clamp(22rem, 90vw, 44rem));
    margin: 0 auto;
  }
  /* Glassmorphism cards/panels */
  .bg-america-dark\/90, .bg-america-dark\/95, .bg-gray-900.rounded-xl, .glass-card {
    border-radius: var(--radius) !important;
    border: var(--glass-border) !important;
    background: var(--glass-bg) !important;
    box-shadow: var(--shadow-soft) !important;
    backdrop-filter: var(--glass-blur) !important;
    -webkit-backdrop-filter: var(--glass-blur) !important;
    padding: 1.7rem !important;
    position: relative;
    overflow: hidden;
    transition: var(--transition);
  }
  /* Light accent line */
  [class*="bg-gray-900"]::before, .glass-card::before {
    content: "";
    display: block;
    position: absolute;
    top: 0; left: 0; right: 0; height: 2.5px;
    background: var(--glass-light);
    border-radius: 99px;
    pointer-events: none;
    z-index: 2;
  }
  /* Premium CTA button */
  button[class*="bg-america-red"], a[class*="bg-america-red"]{
    background: linear-gradient(90deg, #D32F2F 70%, #b91c1c 100%) !important;
    border: 1.5px solid rgba(127, 29, 29, .65) !important;
    color: #fff !important;
    font-size: 1.08rem;
    font-weight: 800;
    border-radius: 18px !important;
    box-shadow: var(--shadow-btn) !important;
    padding: 1.1rem 1.7rem !important;
    letter-spacing: 0.02em;
    transition: var(--transition);
    min-height: 52px;
    position: relative;
    overflow: hidden;
  }
  button[class*="bg-america-red"]:hover, a[class*="bg-america-red"]:hover{
    filter: brightness(1.07) saturate(1.08);
    box-shadow: 0 8px 32px rgba(211,47,47,0.18);
    transform: translateY(-2.5px) scale(1.018);
  }
  button[class*="bg-america-red"]:active, a[class*="bg-america-red"]:active{
    filter: brightness(0.97);
    transform: translateY(1.5px) scale(0.98);
  }
  button[class*="bg-america-red"]:focus-visible{
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(211,47,47,.38), var(--shadow-btn) !important;
  }
  /* Secondary/tertiary buttons */
  button[class*="bg-gray-800"], a[class*="bg-gray-800"], button[class*="bg-gray-900"], a[class*="bg-gray-900"]{
    background: linear-gradient(90deg, #18181b 70%, #23232b 100%) !important;
    border: 1.5px solid var(--border) !important;
    color: #fff !important;
    border-radius: 15px !important;
    font-size: 1.01rem;
    font-weight: 600;
    box-shadow: var(--shadow-soft) !important;
    padding: 0.85rem 1.35rem !important;
    min-height: 48px;
    transition: var(--transition);
  }
  button[class*="bg-gray-800"]:hover, a[class*="bg-gray-800"]:hover,
  button[class*="bg-gray-900"]:hover, a[class*="bg-gray-900"]:hover{
    filter: brightness(1.05);
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    transform: translateY(-1.5px) scale(1.012);
  }
  button[class*="bg-gray-800"]:active, a[class*="bg-gray-800"]:active,
  button[class*="bg-gray-900"]:active, a[class*="bg-gray-900"]:active{
    filter: brightness(0.98);
    transform: translateY(1px) scale(0.98);
  }
  button:focus-visible, .btn:focus-visible{
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(211,47,47,.32), var(--shadow-soft) !important;
  }
  /* Inputs premium */
  input[type="text"], input[type="number"], input[type="tel"], input[type="email"], input[type="password"], select, textarea{
    background: rgba(24,24,28,0.82) !important;
    border: 1.5px solid var(--border) !important;
    border-radius: 12px !important;
    color: var(--text) !important;
    font-size: 1.01rem;
    font-weight: 500;
    padding: 0.85rem 1.1rem !important;
    transition: border-color 180ms ease, box-shadow 180ms ease;
    min-height: 46px;
    box-shadow: 0 1.5px 0 rgba(255,255,255,0.04) inset;
    backdrop-filter: blur(6px);
  }
  input:focus, select:focus, textarea:focus{
    outline: none !important;
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 3px rgba(211,47,47,.32) !important;
  }
  /* Fancy select */
  .fancy-select{
    -webkit-appearance: none; -moz-appearance: none; appearance: none;
    background: rgba(24,24,28,0.82) !important;
    border: 1.5px solid var(--border) !important;
    border-radius: 12px !important;
    color: var(--text) !important;
    font-size: 1.01rem;
    padding: 0.85rem 2.2rem 0.85rem 1.1rem !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 18px 18px;
    cursor: pointer;
    box-shadow: 0 1.5px 0 rgba(255,255,255,0.04) inset;
    transition: var(--transition);
  }
  .fancy-select:hover{ border-color:#4B5563 !important; }
  .fancy-select:active{ transform: translateY(1px); }
  .fancy-select:disabled{ opacity:.6; cursor:not-allowed; }
  .fancy-select::-ms-expand{ display:none; }
  /* Toast premium */
  #toast {
    background: rgba(24,24,28,0.92) !important;
    border: 1.5px solid var(--border) !important;
    color: #fff !important;
    font-size: 1.01rem;
    border-radius: 16px !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18) !important;
    min-width: 220px;
    min-height: 48px;
    transition: var(--transition);
    backdrop-filter: blur(8px);
    max-width: 90vw;
    font-size: 1rem;
    padding: 0.9rem 1.2rem !important;
    border-radius: 14px !important;
  }
  /* Skeletons */
  .skeleton{
    background: linear-gradient(90deg,#333 25%,#444 50%,#333 75%);
    border-radius: 10px;
    animation: pulse 1.5s infinite;
    min-height: 26px;
  }
  @keyframes pulse{0%{opacity:.6}50%{opacity:.3}100%{opacity:.6}}
  /* Focus visible for all interactive elements */
  a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible{
    outline: 2px solid var(--primary);
    outline-offset: 2px;
    box-shadow: 0 0 0 3px rgba(211,47,47,.25);
  }
  /* Minimum text size */
  body, input, button, select, textarea, .text-sm, .text-base, .text-lg, .text-xl{
    font-size: 16px !important;
    line-height: 1.5 !important;
  }
  /* Responsive: ensure touch targets >=44px */
  button, .btn, input, select{
    min-height: 46px !important;
    min-width: 44px;
    font-size: 1rem;
  }
  /* Responsive modal */
  #profileModal > div,
  #familyModal > div,
  #topUpModal > div,
  #verificationModal > div,
  #redeemModal > div,
  #triviaModal > div,
  #foodModal > div,
  #mapModal > div,
  #eventsModal > div,
  #showModal > div,
  #flashModal > div,
  #dailyChallengeModal > div,
  #experiencesModal > div,
  #iosNfcModal > div {
    max-width: 98vw;
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto;
    border-radius: 18px !important;
    padding: 1.2rem 0.7rem !important;
  }
  @media (min-width: 640px){
    #profileModal > div,
    #familyModal > div,
    #topUpModal > div,
    #verificationModal > div,
    #redeemModal > div,
    #triviaModal > div,
    #foodModal > div,
    #mapModal > div,
    #eventsModal > div,
    #showModal > div,
    #flashModal > div,
    #dailyChallengeModal > div,
    #experiencesModal > div,
    #iosNfcModal > div {
      max-width: 480px;
      padding: 2.2rem 2rem !important;
    }
  }
  /* Micro-animations for interactive elements */
  button, .btn, a, input, select{
    transition: var(--transition);
  }
  /* Hide scrollbars for horizontal nav */
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  /* Premium icon style */
  i[data-feather] {
    stroke-width: 2.1px !important;
    opacity: 0.93;
    filter: drop-shadow(0 1.5px 0 rgba(255,255,255,0.08));
  }
  /* Premium title style */
  h1, h2, h3, .font-bold, .font-extrabold {
    font-family: 'Inter Display', 'Inter', sans-serif;
    font-weight: 800 !important;
    letter-spacing: 0.01em;
  }
  /* Responsive grid for promos and engagement */
  #promosSection #promosContainer,
  #engagementSection {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.2rem;
  }
  @media (min-width: 640px){
    #promosSection #promosContainer,
    #engagementSection {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (min-width: 1024px){
    #promosSection #promosContainer,
    #engagementSection {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  /* Responsive header/footer */
  body:not(.dashboard-mode) header,
  body:not(.dashboard-mode) footer {
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }
  /* Responsive for login section */
  @media (max-width: 480px){
    .bg-america-dark\/90, .bg-america-dark\/95, .bg-gray-900.rounded-xl {
      padding: 1.1rem !important;
    }
  }
  /* Responsive modal close button */
  button[aria-label="Cerrar"], .p-2.rounded-lg {
    min-width: 36px;
    min-height: 36px;
    font-size: 1.2rem;
  }
  /* Responsive toast */
  #toast {
    max-width: 90vw;
    font-size: 1rem;
    padding: 0.9rem 1.2rem !important;
    border-radius: 14px !important;
  }
</style>
<!-- ...existing code... -->
<style>
    .progress-bar{height:8px;border-radius:4px;background-color:#333}
    .progress-fill{height:100%;border-radius:4px;background-color:#D32F2F;transition:width .5s ease}
    .skeleton{background-color:#333;border-radius:8px;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{opacity:.6}50%{opacity:.3}100%{opacity:.6}}
    .promo-chip{transition:all .2s ease}
    .promo-chip:hover{transform:translateY(-2px)}
  </style>
  <style id="dashboard-sections-style">
    /* Anchors reserve offset for sticky header */
    .dash-anchor{ position: relative; top: -72px; height: 0; }
    .dash-section-title{ display:flex; align-items:center; gap:.5rem; font-weight:800; font-size:1.1rem; letter-spacing:.2px; position:relative; }
    /* Marcador circular minimal, neutro */
    .dash-section-title::before{ content:""; display:inline-block; width:.6rem; height:.6rem; border:2px solid var(--border); border-radius:50%; }
    /* Regla sutil hacia la derecha del título */
    .dash-section-title::after{ content:""; flex:1; height:1px; background: var(--border); margin-left:.75rem; opacity:.8; }
    .dash-section-sub{ font-size:.82rem; color:#9CA3AF; }
    /* Chips nav */
    #sectionNav { position: sticky; top: 56px; z-index: 8; background: rgba(0,0,0,.45); backdrop-filter: blur(4px); border-bottom: 1px solid #2b3340; }
    #sectionNav .chip { white-space:nowrap; border:1px solid var(--border); background: #0b1220; }
    #sectionNav .chip.active { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(211,47,47,.25); }
    @media (max-width: 640px){ #sectionNav{ top: 52px; } }
    /* Igualar alturas de tarjetas dentro de grids para cuadrícula limpia */
    .grid .bg-gray-900.rounded-xl{ height:100%; }
    /* Separación vertical uniforme entre secciones */
    main > header + section{ margin-top: var(--space-4); }
    #eventsSection .bg-gray-900.rounded-xl{ padding: var(--space-4) !important; }
  </style>
  <style id="home-clean-style">
    /* Limpieza y orden general del Home */
    body.dashboard-mode main{ gap: var(--space-6); }
    /* Espaciado vertical consistente entre bloques */
    body.dashboard-mode main > header{ margin-top: var(--space-6); margin-bottom: var(--space-3); }
    body.dashboard-mode section{ margin-top: var(--space-3); margin-bottom: var(--space-6); }
    /* Títulos de sección más claros y ordenados */
    .dash-section-title{ margin-bottom: .35rem; }
    .dash-section-sub{ margin-left: .5rem; }
    /* Tarjetas con padding uniforme y contenido alineado */
    .card-clean{ padding: 16px !important; border-radius: var(--radius) !important; }
    .card-clean h2, .card-clean h3{ margin-bottom: .35rem; letter-spacing: .2px; }
    .card-clean p{ margin: .25rem 0; }
    /* Grids uniformes en secciones con cards */
    #promosSection #promosContainer{ display: grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap: 16px; align-items: stretch; }
    #engagementSection{ gap: 16px !important; }
    #summaryGrid > div{ height:100%; }
    #summaryGrid > div .progress-bar{ margin-top: 6px; }
    #summaryGrid > div p{ margin: .15rem 0; }
    /* Cupones rápidos (píldoras) */
    .promo-pill{ background:#141414; border:1px solid var(--border); color:#fff; padding:8px 12px; border-radius:999px; font-size:.9rem; white-space:nowrap; }
    .promo-pill i{ width:14px; height:14px; opacity:.9; }
    .promo-pill:hover{ background:#151515; border-color:#3a3a3a; }
    /* Chips de navegación: separación inferior para no apilar visualmente con el contenido */
    #sectionNav{ margin-bottom: .5rem; padding-bottom: .25rem; }
    /* Badges compactos */
    #dailyChallengeStatus{ padding: 4px 10px; border-radius: 999px; font-weight: 600; }
    /* Tipografía fina para metadatos */
    #profileMeta{ opacity: .85; }
    /* Botones dentro de cards con tamaño y densidad uniforme */
    .card-clean button{ padding: 10px 14px !important; border-radius: 12px !important; }
    /* Igualar alto de tarjetas en grids para mayor orden */
    #engagementSection > div, #promosSection #promosContainer > div{ height: 100%; }
    /* Reduce ruido en sombras (más suave) */
    [class*="bg-gray-900"].rounded-xl{ box-shadow: 0 6px 14px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.03) !important; }
    /* En móvil: más aire entre secciones y tarjetas con padding algo mayor */
    @media (max-width:640px){
      body.dashboard-mode section{ margin-top: var(--space-4); margin-bottom: var(--space-6); }
      .card-clean{ padding: 18px !important; }
    }
  </style>
  <style id="header-dynamic-style">
    /* Barra superior en gris oscuro para más profundidad */
    header { background: linear-gradient(180deg, #161616, #121212) !important; border-bottom: 1px solid var(--border) !important; transition: background-color .2s ease; }
  </style>
  <style id="responsive-tweaks">
    /* Utilidad: ocultar scrollbars visuales en contenedores horizontales */
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  
    /* Ajustes móviles */
    @media (max-width: 640px){
      /* Header compacto */
      header .py-4, header .py-3 { padding-top: .6rem !important; padding-bottom: .6rem !important; }
      #profileGreeting { font-size: 0.95rem !important; }
      #profileMeta, header .text-xs { font-size: 0.68rem !important; }
      /* Chips nav más grandes para tacto y mejor separación */
      #sectionNav .chip { padding: .45rem .75rem !important; font-size: .82rem !important; }
      #sectionNav { top: 54px !important; }
      /* Cards más contenidas en padding */
      .bg-gray-900.rounded-xl { padding: 1rem !important; }
      /* Botones táctiles mínimos 40px */
      button { min-height: 40px; }
      .rounded-xl { border-radius: 12px; }
      /* Tipografías de títulos de sección */
      .dash-section-title { font-size: 1rem; }
      /* Ajuste para modales */
      .modal > div, #profileModal > div, #familyModal > div, #topUpModal > div, #verificationModal > div, #redeemModal > div, #triviaModal > div, #foodModal > div, #mapModal > div, #eventsModal > div, #showModal > div, #flashModal > div, #dailyChallengeModal > div, #experiencesModal > div, #iosNfcModal > div {
        max-width: 100vw !important;
        width: 100vw !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
    }
    @media (min-width: 1280px){
      .dash-section-title { font-size: 1.2rem; }
      #sectionNav { top: 64px; }
    }
  </style>
  <style id="uber-buttons">
    /* Estilo minimalista tipo Uber para TODOS los botones del Home (dashboard) */
    body.dashboard-mode button,
    body.dashboard-mode .btn {
      background: linear-gradient(180deg, #1a1a1a, #121212) !important;
      color: #ffffff !important;
      border: 1px solid #2c2c2c !important;
      border-radius: 14px !important;
      box-shadow: 0 1px 0 rgba(255,255,255,.03) inset, 0 6px 12px rgba(0,0,0,.35) !important;
      text-transform: none !important;
      letter-spacing: .1px !important;
      transition: background-color .18s ease, border-color .18s ease, box-shadow .18s ease, transform .06s ease !important;
    }
    body.dashboard-mode button:hover,
    body.dashboard-mode .btn:hover {
      background: linear-gradient(180deg, #1a1212, #130e0e) !important;
      border-color: rgba(211,47,47,.45) !important;
      color: #ffffff !important;
      box-shadow: 0 0 0 2px rgba(211,47,47,.12) !important;
    }
    body.dashboard-mode button:active,
    body.dashboard-mode .btn:active {
      background: linear-gradient(180deg, #2a1717, #1a1111) !important;
      border-color: rgba(211,47,47,.6) !important;
    }
    /* Chips de navegación: mantener hover minimal sin rojo de relleno */
    body.dashboard-mode #sectionNav .chip:hover{
      background: #151515 !important;
      border-color: #2f2f2f !important;
      box-shadow: none !important;
      color: #e5e7eb !important;
    }
    body.dashboard-mode button i,
    body.dashboard-mode .btn i { color: #ffffff !important; opacity: .92; }
    /* Chips de navegación: pill oscuro neutro con activo borde rojo fino */
    #sectionNav .chip { background: #121212 !important; border: 1px solid #2a2a2a !important; color: #e5e7eb !important; border-radius: 16px !important; }
    #sectionNav .chip.active { border-color: var(--primary) !important; box-shadow: 0 0 0 2px rgba(211,47,47,.25) !important; }
    /* Botones de cierre redondos más discretos */
    body.dashboard-mode button[aria-label="Cerrar"],
    body.dashboard-mode #closeMainMenu,
    body.dashboard-mode #closeMapModal,
    body.dashboard-mode #closeFoodModal,
    body.dashboard-mode #closeEventsModal { background: #0f141f !important; border-color: #263044 !important; }
  </style>
  <style id="main-menu-modern-style">
    /* Modernizar el menú lateral: filas sobrias, consistentes con el resto */
    #mainMenuModal .menu-item{
      display: flex; align-items: center; gap: 10px;
      width: 100%;
      background: #0f0f0f !important;
      color: #ffffff !important;
      border: 1px solid #1d1d1d !important;
      border-radius: 12px !important;
      padding: 12px 14px !important;
      font-weight: 500; letter-spacing: .2px;
      box-shadow: none !important;
    }
    #mainMenuModal .menu-item:hover{ background:#141414 !important; border-color:#2a2a2a !important; }
    #mainMenuModal .menu-item:active{ background:#0b0b0b !important; }
    #mainMenuModal .menu-item:focus-visible{
      outline: none !important; box-shadow: 0 0 0 2px rgba(211,47,47,.35) !important;
    }
    #mainMenuModal .menu-item i{ width:18px; height:18px; color:#ffffff !important; opacity:.92; margin-right: 2px; }
    /* Separación visual discreta entre ítems */
    #mainMenuModal .space-y-1 > .menu-item{ margin-top: .25rem; }
    /* Variante de peligro para cerrar sesión */
    #mainMenuModal .menu-item[data-action="logout"]{
      background: #0f0f0f !important; color: #ffffff !important;
      border-color:#2a2a2a !important;
    }
    #mainMenuModal .menu-item[data-action="logout"]:hover{ border-color:#3a3a3a !important; }
  </style>
<style id="map-style">
    .poi { transition: transform .12s ease; }
    .poi:hover { transform: scale(1.04); }
    .seg { cursor: pointer; transition: opacity .2s ease, filter .2s ease; stroke: #0e0e0e; stroke-width: 2; }
    .seg:hover { filter: brightness(1.03); }
    .seg.dim { opacity: .25; }
    .seg.active { stroke: #D32F2F; stroke-width: 3; }
    .floor-btn.active{ border-color:#D32F2F !important; box-shadow: 0 0 0 2px rgba(211,47,47,.25) inset; }
    /* Emociones */
    .poi.mural circle:first-child{ fill:#ffffff; }
    .poi.passion circle:first-child{ fill:#D32F2F; }
    .poi.debut circle:first-child{ fill:#ffffff; }
    /* Ruta familiar */
    #familyRoute{ stroke:#D32F2F; stroke-width:4; fill:none; stroke-dasharray:10 7; }
    #familyFootsteps circle{ fill:#ffffff; opacity:.85; }
    #familyFootsteps circle:nth-child(odd){ opacity:.55; }
  </style>
  <style>
    #eventsScroll { -webkit-overflow-scrolling: touch; }
  </style>
<style>
        .nfc-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }
        .toast {
            transition: all 0.3s ease;
        }
    </style>
<style id="page-bg-var">
:root{ --page-bg:url('https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?auto=format&fit=crop&w=2000&q=80'); }
html,body{ background:#05070f !important; }
</style>
<style id="bg-blur-style">
  /* Blur del fondo usando variable CSS para la imagen */
  html, body { height: 100%; }
  body { position: relative; }
  body::before {
    content: "";
    position: fixed; /* cubre toda la ventana */
    inset: 0;
    background-image: linear-gradient(135deg, rgba(2,6,23,0.92), rgba(76,29,149,0.35), rgba(15,23,42,0.9)), var(--page-bg);
    background-size: cover;
    background-position: center;
    opacity: 0.9 !important;
    filter: blur(6px) saturate(1.15) brightness(0.75);
    transform: scale(1.04);
    z-index: 0;
    pointer-events: none;
  }
  /* Asegura que el contenido quede por encima del fondo borroso */
  body > * { position: relative; z-index: 1; }
  /* Canvas animado: entre el blur y el contenido */
  body > canvas#devilsCanvas{ position: fixed !important; inset: 0; z-index: 0 !important; pointer-events: none; opacity: 0.05; }
  @media (prefers-reduced-motion: reduce){ body > canvas#devilsCanvas{ display:none !important; } }
</style>
  <style id="dashboard-bg-override">
  /* Mantener la imagen de fondo y el blur también en el dashboard */
  body.dashboard-mode {
    background-color: transparent !important;
  }
  body.dashboard-mode::before { display: block !important; }
  </style>
  <style id="modal-responsive-style">
    /* Unificar comportamiento responsive de todos los modales */
    #profileModal > div,
    #familyModal > div,
    #topUpModal > div,
    #verificationModal > div,
    #redeemModal > div,
    #triviaModal > div,
    #foodModal > div,
    #mapModal > div,
    #eventsModal > div,
    #showModal > div,
    #flashModal > div,
    #dailyChallengeModal > div,
    #experiencesModal > div,
    #iosNfcModal > div {
      max-height: 92vh;
      width: 100%;
      overflow-y: auto; /* si el contenido crece, permite scroll */
    }
    /* Cabeceras pegajosas para que el botón cerrar no se pierda */
    #profileModal .border-b,
    #familyModal .border-b,
    #topUpModal .border-b,
    #foodModal .border-b,
    #mapModal .border-b,
    #eventsModal .border-b,
    #dailyChallengeModal .border-b,
    #experiencesModal .border-b,
    #triviaModal .border-b,
    #flashModal .border-b {
      position: sticky; top: 0; z-index: 2; background: rgba(11,15,25,.96);
      backdrop-filter: saturate(1.1) blur(2px);
    }
    /* En pantallas chicas, estilo bottom-sheet (sin bordes redondeados) */
    @media (max-width: 640px){
      #profileModal > div,
      #familyModal > div,
      #topUpModal > div,
      #verificationModal > div,
      #redeemModal > div,
      #triviaModal > div,
      #foodModal > div,
      #mapModal > div,
      #eventsModal > div,
      #showModal > div,
      #flashModal > div,
      #dailyChallengeModal > div,
      #experiencesModal > div,
      #iosNfcModal > div { border-radius: 0 !important; }
    }
  </style>
  <style>
    /* Animación de resultado */
    .pop-in { animation: pop-in 0.6s ease-out; }
    @keyframes pop-in { 0% { transform: scale(0.6); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    /* Bloqueo de pantalla al mostrar overlay global */
    body.screen-locked { overflow: hidden; touch-action: none; overscroll-behavior: contain; }

    /* Asegurar que el QR scanner y overlay estén siempre al frente */
    #qrModal {
      z-index: 100 !important; /* más alto que otros modales */
    }
    #qrResultOverlay {
      z-index: 110 !important; /* aún más alto, para animaciones de resultado */
    }
  </style>
<style id="quick-pretty-pass">
  /* Quick visual polish focused on the login screen */

  #loginSection{
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
  }
  #loginSection [class*="bg-america-dark"]{ border-radius: 18px !important; box-shadow: 0 20px 60px rgba(0,0,0,.35) !important; }
  #loginSection h1{ letter-spacing:.2px; line-height:1.18; }
  #loginSection p{ color:#d1d5db; }
  /* Logo subtle ring */
  .logo-ring{ position:relative; }
  .logo-ring::after{ content:""; position:absolute; inset:-6px; border-radius:999px; background: radial-gradient( circle at 30% 30%, rgba(255,255,255,.14), rgba(211,47,47,.24) 50%, transparent 60% ); filter: blur(10px); z-index:0; }
  .logo-ring > *{ position:relative; z-index:1; }
  /* Divider styling */
  .divider span{ font-size:.85rem; color:#9ca3af; }
  .divider .border-t{ border-color:#2f2f2f !important; }
  /* Steps: nicer numbered tokens */
  #loginSection .step{
    display:flex; gap:.75rem; align-items:flex-start;
  }
  #loginSection .step .num{
    width: 34px; height: 34px; border-radius: 10px; flex: 0 0 34px;
    display:grid; place-items:center; font-weight:800;
    background: linear-gradient(180deg,#d32f2f,#b91c1c);
    box-shadow: 0 6px 18px rgba(211,47,47,.26), inset 0 1px 0 rgba(255,255,255,.06);
  }
  #loginSection .step p{ margin-top:.15rem; }
  /* Cards inside helper sections */
  #loginSection .bg-gray-900.rounded-xl{ border-radius:16px !important; border-color:#242424 !important; background:#101010 !important; }
  /* Footer links */
  footer a{ transition: color .18s ease; }
  footer a:hover{ color:#e5e7eb !important; }
  /* Manual input field refinement */
  #manualInputSection input{ letter-spacing:.3px; font-variant-numeric: tabular-nums; }
  /* QR modal frame subtle glow */
  #qrModal .rounded-xl{ box-shadow: 0 18px 50px rgba(0,0,0,.45) !important; }
  #qrModal [class*="border-white"]{ box-shadow: 0 0 0 1px rgba(255,255,255,.4) inset; }
</style>
<style id="minimal-dashboard-refresh">
  :root {
    --dash-max-width: 1120px;
    --dash-shell-pad: clamp(1rem, 3vw, 2.5rem);
    --dash-shell-pad-mobile: 1.1rem;
    --dash-card-bg: rgba(12, 17, 27, 0.78);
    --dash-card-border: rgba(148, 163, 184, 0.18);
    --dash-card-shadow: 0 28px 60px rgba(4, 10, 20, 0.35);
    --dash-text-muted: #94a3b8;
  }
  @media (max-width: 640px) {
    :root { --dash-shell-pad: var(--dash-shell-pad-mobile); }
  }
  body.dashboard-mode {
    background: radial-gradient(circle at 20% 20%, rgba(211,47,47,0.12), transparent 55%),
                radial-gradient(circle at 80% 0%, rgba(211,47,47,0.18), transparent 50%),
                #05070f;
  }
  body.dashboard-mode::before {
    background: radial-gradient(circle at 50% -10%, rgba(248,113,113,0.18), transparent 55%) !important;
  }
  .dashboard-topbar {
    position: sticky;
    top: 0;
    z-index: 40;
    background: rgba(8, 12, 24, 0.88);
    backdrop-filter: blur(18px);
    border-bottom: 1px solid rgba(148, 163, 184, 0.18);
    padding: 0.85rem calc(var(--dash-shell-pad));
  }
  .dashboard-topbar__inner {
    max-width: var(--dash-max-width);
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem 1.5rem;
    flex-wrap: wrap;
  }
  .dashboard-topbar__avatar {
    width: 46px;
    height: 46px;
    border-radius: 16px;
    display: grid;
    place-items: center;
    font-weight: 700;
    background: linear-gradient(135deg, rgba(211,47,47,0.92), rgba(248,113,113,0.28));
    border: 1px solid rgba(248,113,113,0.45);
    color: #fff;
    box-shadow: 0 12px 28px rgba(211,47,47,0.32);
    cursor: pointer;
    overflow: hidden;
    transition: transform .18s ease, box-shadow .25s ease;
  }
  .dashboard-topbar__avatar:hover { transform: translateY(-1px); box-shadow: 0 16px 34px rgba(211,47,47,0.4); }
  .dashboard-topbar__avatar img { width: 100%; height: 100%; object-fit: cover; }
  .dashboard-topbar__meta {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    min-width: 0;
  }
  .dashboard-topbar__meta h1 { font-size: clamp(1.05rem, 0.8vw + 1rem, 1.35rem); font-weight: 600; }
  .dashboard-topbar__meta p { color: var(--dash-text-muted); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .dashboard-topbar__date { color: rgba(148,163,184,0.75); font-size: 0.78rem; }
  .icon-button {
    width: 42px;
    height: 42px;
    display: grid;
    place-items: center;
    border-radius: 14px;
    background: rgba(15, 23, 42, 0.55);
    border: 1px solid rgba(148, 163, 184, 0.24);
    transition: transform .15s ease, background .2s ease, border-color .2s ease;
  }
  .icon-button:hover, .icon-button:focus-visible {
    transform: translateY(-1px);
    background: rgba(211,47,47,0.22);
    border-color: rgba(248,113,113,0.45);
    outline: none;
  }
  .dashboard-shell {
    width: min(100%, var(--dash-max-width));
    margin: 0 auto;
    padding: clamp(1.5rem, 2vw + 1.1rem, 2.75rem) calc(var(--dash-shell-pad)) clamp(5.5rem, 6vw, 6.5rem);
    display: flex;
    flex-direction: column;
    gap: clamp(1.5rem, 1vw + 1.4rem, 2.5rem);
  }
  @media (max-width: 640px) {
    .dashboard-shell { padding: 1.35rem var(--dash-shell-pad) 4.75rem; }
  }
  .section-nav {
    margin-inline: calc(-1 * var(--dash-shell-pad));
    padding-inline: var(--dash-shell-pad);
  }
  #sectionNav {
    position: sticky;
    top: 4.6rem;
    background: linear-gradient(90deg, rgba(8,12,24,0.92) 0%, rgba(8,12,24,0) 100%);
    z-index: 20;
    padding-block: 0.75rem;
  }
  #sectionNav .chip {
    background: rgba(15,23,42,0.55);
    color: #e2e8f0;
    border: 1px solid rgba(148,163,184,0.22);
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-weight: 600;
    font-size: 0.78rem;
    transition: background .2s ease, color .2s ease, border-color .2s ease;
    backdrop-filter: blur(12px);
  }
  #sectionNav .chip:hover { background: rgba(211,47,47,0.18); border-color: rgba(248,113,113,0.38); }
  #sectionNav .chip.active, #sectionNav .chip:focus-visible {
    background: rgba(211,47,47,0.28);
    border-color: rgba(248,113,113,0.55);
    color: #fff;
    outline: none;
  }
  .dash-section-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.6rem 1rem;
  }
  .dash-section-title {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    font-size: clamp(1.1rem, 0.9vw + 1rem, 1.4rem);
    font-weight: 600;
    letter-spacing: 0.01em;
  }
  .dash-section-title i { width: 1.1rem; height: 1.1rem; }
  .dash-section-sub { color: var(--dash-text-muted); font-size: 0.86rem; }
  .dash-grid { display: grid; gap: clamp(1rem, 1vw + 0.8rem, 1.75rem); }
  .dash-grid--summary { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  .dash-grid--two { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .dash-card {
    position: relative;
    background: var(--dash-card-bg);
    border: 1px solid var(--dash-card-border);
    border-radius: 20px;
    padding: clamp(1.25rem, 1vw + 1.15rem, 1.9rem);
    box-shadow: var(--dash-card-shadow);
    backdrop-filter: blur(22px);
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }
  .dash-card__header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem; }
  .dash-card h2, .dash-card .font-medium { color: #f8fafc; }
  .dash-card p, .dash-card .text-gray-400 { color: var(--dash-text-muted) !important; }
  .dash-chip {
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: rgba(211,47,47,0.18);
    border: 1px solid rgba(211,47,47,0.35);
    color: #fecaca;
    letter-spacing: 0.02em;
  }
  .dash-chip.positive { background: rgba(34,197,94,0.16); border-color: rgba(34,197,94,0.35); color: #bbf7d0; }
  .dash-chip.negative { background: rgba(248,113,113,0.12); border-color: rgba(248,113,113,0.32); color: #fecaca; }
  .dash-card--wide { gap: 1.25rem; }
  @media (min-width: 1024px) {
    .dash-grid--summary .dash-card--wide { grid-column: span 2; }
  }
  .sparkline-wrapper { position: relative; width: 100%; }
  .sparkline { width: 100%; aspect-ratio: 16 / 7; display: block; }
  .sparkline svg { width: 100%; height: 100%; overflow: visible; }
  .sparkline line { stroke: rgba(148,163,184,0.25); stroke-width: 1; }
  .sparkline path.sparkline-area { fill: url(#attendanceGradient); opacity: 0.7; }
  .sparkline path.sparkline-line { fill: none; stroke: #ef4444; stroke-width: 2.4; stroke-linecap: round; stroke-linejoin: round; }
  .sparkline circle { fill: #ef4444; stroke: #0b0f19; stroke-width: 2; pointer-events: none; }
  .sparkline-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.85rem;
    font-size: 0.85rem;
    color: var(--dash-text-muted);
  }
  .sparkline-summary dt {
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: 0.68rem;
    color: rgba(148,163,184,0.7);
  }
  .sparkline-summary dd { font-size: 1rem; color: #f8fafc; font-weight: 600; margin-top: 0.25rem; }
  .sparkline-labels {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-size: 0.72rem;
    color: rgba(148,163,184,0.7);
  }
  .sparkline-labels span { display: inline-flex; align-items: center; gap: 0.35rem; }
  .sparkline-labels span::before { content: ''; width: 6px; height: 6px; border-radius: 999px; background: #ef4444; opacity: 0.7; }
  .sparkline-labels strong { color: #f8fafc; font-weight: 600; }
  #promoQuickRow { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.35rem; scroll-snap-type: x mandatory; }
  #promoQuickRow > * { scroll-snap-align: start; }
  #promosContainer, #engagementSection { width: 100%; }
  body.dashboard-mode .bg-gray-900 { background: var(--dash-card-bg) !important; border-color: var(--dash-card-border) !important; }
  body.dashboard-mode .border-gray-800 { border-color: var(--dash-card-border) !important; }
  body.dashboard-mode .btn-3d-red,
  body.dashboard-mode .btn-3d-dark,
  body.dashboard-mode .card-3d {
    box-shadow: none !important;
    transform: none !important;
  }
  body.dashboard-mode .btn-3d-red {
    background: linear-gradient(135deg, rgba(211,47,47,0.9), rgba(211,47,47,0.72)) !important;
    border: 1px solid rgba(248,113,113,0.45) !important;
  }
  body.dashboard-mode .btn-3d-dark {
    background: rgba(15,23,42,0.75) !important;
    border: 1px solid rgba(148,163,184,0.25) !important;
  }
  body.dashboard-mode .btn-3d-red:hover,
  body.dashboard-mode .btn-3d-red:active,
  body.dashboard-mode .btn-3d-dark:hover,
  body.dashboard-mode .btn-3d-dark:active {
    filter: none !important;
  }
  #toast {
    background: rgba(15,23,42,0.85) !important;
    border-color: rgba(148,163,184,0.3) !important;
    backdrop-filter: blur(16px);
  }
  #liveAlerts {
    right: 1.5rem;
    top: 1.5rem;
    max-width: min(100%, 320px);
  }
  #liveAlerts > div {
    backdrop-filter: blur(16px);
    border-radius: 18px;
    border: 1px solid rgba(148,163,184,0.22);
    box-shadow: 0 24px 60px rgba(7,12,20,0.45);
  }
  @media (max-width: 768px) {
    #liveAlerts { left: 50%; right: auto; transform: translateX(-50%); width: min(92vw, 360px); }
  }
  body.dashboard-mode footer {
    border-top: 1px solid rgba(148,163,184,0.12);
    background: rgba(7,11,20,0.82);
    backdrop-filter: blur(18px);
    margin-top: auto;
    padding: 1.5rem var(--dash-shell-pad);
    color: rgba(203,213,225,0.78);
  }
  body.dashboard-mode footer a { color: inherit; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { scrollbar-width: none; }
</style>
<style id="chip-nowrap-fix">
  /* Fuerza una sola línea en los chips del nav */
  #sectionNav .chip,
  #sectionNav .chip * {
    white-space: nowrap !important; /* evita saltos de línea */
  }
  #sectionNav .chip {
    overflow: hidden;                /* oculta desbordes */
    text-overflow: ellipsis;         /* (opcional) agrega … si no cabe */
    min-width: max-content;          /* ancho ajustado al contenido */
    padding: 0.45rem 0.9rem !important; /* aire horizontal consistente */
  }
  /* Ajuste fino para móviles (iPhone 12 ~390px de ancho) */
  @media (max-width: 400px){
    #sectionNav .chip { font-size: 0.82rem !important; padding: 0.4rem 0.8rem !important; }
  }
</style>
<style id="chip-overflow-fix">
  /* Asegurar que los chips no desborden texto */
  #sectionNav .chip {
    max-width: 120px;              /* ancho máximo */
    overflow: hidden;              /* oculta texto que exceda */
    text-overflow: ellipsis;       /* añade puntos suspensivos */
    white-space: nowrap !important;/* fuerza en una sola línea */
    display: inline-block;
    text-align: center;            /* centra el texto */
  }
  @media (max-width: 400px){
    #sectionNav .chip {
      max-width: 100px;            /* más estricto en pantallas pequeñas */
      font-size: 0.78rem !important;
    }
  }
</style>
</head>
<!-- Add Tailwind responsive utility classes to main containers and buttons -->
<body data-ui="neutral" class="bg-gradient-to-b from-america-dark to-red-900/20 text-white min-h-screen flex flex-col">
<canvas id="devilsCanvas" aria-hidden="true"></canvas>
<script>
// Animación sutil de diablos en el fondo (canvas #devilsCanvas)
(function() {
  const canvas = document.getElementById('devilsCanvas');
  if (!canvas) return;
  let dpr = window.devicePixelRatio || 1;
  let w = 0, h = 0, ctx = null;
  let devils = [];
  const devilCount = 12;
  const colors = ['#D32F2F', '#fff', '#b91c1c'];
  function resize() {
    dpr = window.devicePixelRatio || 1;
    w = window.innerWidth;
    h = window.innerHeight;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  function randomDevil() {
    const size = 32 + Math.random() * 32;
    return {
      x: Math.random() * w,
      y: Math.random() * h,
      vx: (Math.random() - 0.5) * 0.1,
      vy: (Math.random() - 0.5) * 0.1,
      size,
      color: colors[Math.floor(Math.random()*colors.length)],
      angle: Math.random() * Math.PI * 2,
      spin: (Math.random()-0.5) * 0.003
    }
  }
  function initDevils() {
    devils = [];
    for (let i=0;i<devilCount;i++) devils.push(randomDevil());
  }
  function drawDevil(d) {
    ctx.save();
    ctx.globalAlpha = 0.15;
    ctx.translate(d.x, d.y);
    ctx.rotate(d.angle);
    // Cuerpo (círculo)
    ctx.beginPath();
    ctx.arc(0, 0, d.size/2, 0, Math.PI*2);
    ctx.fillStyle = d.color;
    ctx.shadowColor = d.color;
    ctx.shadowBlur = 6;
    ctx.fill();
    ctx.shadowBlur = 0;
    // Cuernos
    ctx.save();
    ctx.rotate(-0.3);
    ctx.beginPath();
    ctx.moveTo(-d.size*0.18, -d.size*0.49);
    ctx.quadraticCurveTo(-d.size*0.27, -d.size*0.66, -d.size*0.09, -d.size*0.41);
    ctx.strokeStyle = d.color;
    ctx.lineWidth = 2.2;
    ctx.stroke();
    ctx.restore();
    ctx.save();
    ctx.rotate(0.3);
    ctx.beginPath();
    ctx.moveTo(d.size*0.18, -d.size*0.49);
    ctx.quadraticCurveTo(d.size*0.27, -d.size*0.66, d.size*0.09, -d.size*0.41);
    ctx.strokeStyle = d.color;
    ctx.lineWidth = 2.2;
    ctx.stroke();
    ctx.restore();
    // Ojos
    ctx.beginPath();
    ctx.arc(-d.size*0.18, -d.size*0.09, d.size*0.08, 0, Math.PI*2);
    ctx.arc(d.size*0.18, -d.size*0.09, d.size*0.08, 0, Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.globalAlpha = 0.18;
    ctx.fill();
    ctx.globalAlpha = 0.12;
    ctx.beginPath();
    ctx.arc(-d.size*0.18, -d.size*0.09, d.size*0.03, 0, Math.PI*2);
    ctx.arc(d.size*0.18, -d.size*0.09, d.size*0.03, 0, Math.PI*2);
    ctx.fillStyle = "#000";
    ctx.fill();
    ctx.restore();
  }
  function animate() {
    ctx.clearRect(0,0,w,h);
    for (const d of devils) {
      d.x += d.vx;
      d.y += d.vy;
      d.angle += d.spin;
      if (d.x < -d.size) d.x = w + d.size;
      if (d.x > w + d.size) d.x = -d.size;
      if (d.y < -d.size) d.y = h + d.size;
      if (d.y > h + d.size) d.y = -d.size;
      drawDevil(d);
    }
    requestAnimationFrame(animate);
  }
  function start() {
    resize();
    initDevils();
    animate();
  }
  window.addEventListener('resize', () => {
    resize();
    initDevils();
  });
  setTimeout(start, 200); // Espera a que canvas esté en DOM y tamaño correcto
})();
</script>
<script id="attendance-spark">
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('attendanceSpark');
    if (!container) return;
    const data = [29850, 31240, 30560, 32780, 33450, 34520];
    const labels = [
      'vs Pasto',
      'vs Envigado',
      'vs Junior',
      'vs Millonarios',
      'vs La Equidad',
      'vs Junior (Vuelta)'
    ];
    const max = Math.max(...data);
    const min = Math.min(...data);
    const range = max - min || 1;
    const width = 340;
    const height = 140;
    const pad = { top: 12, right: 12, bottom: 22, left: 12 };
    const step = data.length > 1 ? (width - pad.left - pad.right) / (data.length - 1) : 0;
    const points = data.map((value, index) => {
      const x = pad.left + step * index;
      const norm = (value - min) / range;
      const y = pad.top + (1 - norm) * (height - pad.top - pad.bottom);
      return { x, y, value, label: labels[index] || `Juego ${index + 1}` };
    });

    const ns = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(ns, 'svg');
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
    svg.setAttribute('preserveAspectRatio', 'none');
    svg.setAttribute('aria-hidden', 'true');

    const defs = document.createElementNS(ns, 'defs');
    const gradient = document.createElementNS(ns, 'linearGradient');
    gradient.id = 'attendanceGradient';
    gradient.setAttribute('x1', '0');
    gradient.setAttribute('y1', '0');
    gradient.setAttribute('x2', '0');
    gradient.setAttribute('y2', '1');
    const stopTop = document.createElementNS(ns, 'stop');
    stopTop.setAttribute('offset', '0%');
    stopTop.setAttribute('stop-color', '#dc2626');
    stopTop.setAttribute('stop-opacity', '0.65');
    const stopBottom = document.createElementNS(ns, 'stop');
    stopBottom.setAttribute('offset', '100%');
    stopBottom.setAttribute('stop-color', '#dc2626');
    stopBottom.setAttribute('stop-opacity', '0');
    gradient.append(stopTop, stopBottom);
    defs.appendChild(gradient);
    svg.appendChild(defs);

    const baseline = document.createElementNS(ns, 'line');
    baseline.setAttribute('x1', String(pad.left));
    baseline.setAttribute('x2', String(width - pad.right));
    baseline.setAttribute('y1', String(height - pad.bottom));
    baseline.setAttribute('y2', String(height - pad.bottom));
    svg.appendChild(baseline);

    const pathLine = points.map((p, idx) => `${idx === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
    const area = document.createElementNS(ns, 'path');
    area.setAttribute('d', `${pathLine} L ${points[points.length - 1].x} ${height - pad.bottom} L ${points[0].x} ${height - pad.bottom} Z`);
    area.setAttribute('class', 'sparkline-area');
    svg.appendChild(area);

    const line = document.createElementNS(ns, 'path');
    line.setAttribute('d', pathLine);
    line.setAttribute('class', 'sparkline-line');
    svg.appendChild(line);

    points.forEach((point) => {
      const dot = document.createElementNS(ns, 'circle');
      dot.setAttribute('cx', point.x);
      dot.setAttribute('cy', point.y);
      dot.setAttribute('r', '4');
      dot.setAttribute('data-label', point.label);
      dot.setAttribute('data-value', String(point.value));
      svg.appendChild(dot);
    });

    container.innerHTML = '';
    container.appendChild(svg);
    container.setAttribute('role', 'img');
    container.setAttribute('aria-label', `Asistencia en los últimos ${data.length} partidos. Máxima ${max.toLocaleString('es-CO')} aficionados, mínima ${min.toLocaleString('es-CO')}.`);

    const fmt = (value) => `${value.toLocaleString('es-CO')} hinchas`;
    const latestEl = document.getElementById('attendanceLatest');
    const avgEl = document.getElementById('attendanceAverage');
    const peakEl = document.getElementById('attendancePeak');
    const lastValue = data[data.length - 1];
    const avgValue = Math.round(data.reduce((acc, val) => acc + val, 0) / data.length);

    if (latestEl) latestEl.textContent = fmt(lastValue);
    if (avgEl) avgEl.textContent = fmt(avgValue);
    if (peakEl) peakEl.textContent = fmt(max);

    const changeEl = document.getElementById('attendanceChange');
    if (changeEl) {
      const change = ((lastValue - data[0]) / data[0]) * 100;
      const formatted = `${change >= 0 ? '+' : '−'}${Math.abs(change).toFixed(1)}%`;
      changeEl.textContent = formatted;
      changeEl.classList.toggle('positive', change >= 0);
      changeEl.classList.toggle('negative', change < 0);
    }

    const labelsEl = document.getElementById('attendanceSparkLabels');
    if (labelsEl) {
      labelsEl.innerHTML = labels.map((label, idx) => `<span><strong>${data[idx].toLocaleString('es-CO')}</strong> ${label}</span>`).join('');
    }
  });
</script>
<style id="ios-modal-fix">
  /* Prevent iOS Safari toolbar from showing busy image under the modal */
  #iosNfcBackdrop{ background: rgba(0,0,0,.88) !important; }
  body.screen-locked{ overflow:hidden; touch-action:none; overscroll-behavior:contain; }
  @supports(height:100dvh){
    #iosNfcModal, #iosNfcBackdrop{ min-height:100dvh; }
  }
</style>
<div id="loginSection" class="relative isolate min-h-screen overflow-x-hidden overflow-y-auto lg:overflow-hidden">
  <div class="absolute inset-0 -z-10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_left,_rgba(248,113,113,0.22),_transparent_55%)]"></div>
    <div class="absolute inset-0 bg-[linear-gradient(130deg,_rgba(2,6,23,0.92),_rgba(88,28,135,0.35),_rgba(15,23,42,0.9))]"></div>
    <div class="absolute inset-0 bg-cover bg-center opacity-40 mix-blend-screen" style="background-image: var(--page-bg);"></div>
    <div class="absolute inset-y-0 right-0 hidden w-2/3 bg-gradient-to-l from-black/70 to-transparent lg:block"></div>
  </div>
  <div class="relative mx-auto flex min-h-screen w-full max-w-6xl flex-col px-6 py-12 sm:px-10 lg:px-16">
    <div class="grid flex-1 items-start gap-12 py-6 lg:grid-cols-[1.08fr_minmax(0,1fr)] lg:items-center lg:py-12">
      <aside class="order-2 space-y-10 text-slate-100 lg:order-1">
        <div class="rounded-3xl border border-white/10 bg-white/10 p-8 shadow-2xl backdrop-blur-2xl">
          <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-white/70">
            <i data-feather="zap" class="h-4 w-4"></i>
            Experiencia premium
          </span>
          <h2 class="mt-6 text-4xl font-semibold leading-tight text-white sm:text-[2.6rem]">Tu acceso al Pascual, sin filas ni complicaciones.</h2>
          <p class="mt-4 text-base text-white/70">Recarga tu manilla, verifica tu QR y disfruta beneficios exclusivos diseñados para la hinchada escarlata.</p>
          <div class="mt-8 grid gap-4 sm:grid-cols-3">
            <div class="rounded-2xl border border-white/20 bg-black/30 px-4 py-5 text-white/80 shadow-lg backdrop-blur">
              <p class="text-xs uppercase tracking-[0.25em] text-white/50">Ingresos hoy</p>
              <p class="mt-2 text-3xl font-semibold text-white">12.542</p>
            </div>
            <div class="rounded-2xl border border-white/20 bg-black/30 px-4 py-5 text-white/80 shadow-lg backdrop-blur">
              <p class="text-xs uppercase tracking-[0.25em] text-white/50">Recargas activas</p>
              <p class="mt-2 text-3xl font-semibold text-white">386</p>
            </div>
            <div class="rounded-2xl border border-white/20 bg-black/30 px-4 py-5 text-white/80 shadow-lg backdrop-blur">
              <p class="text-xs uppercase tracking-[0.25em] text-white/50">Socios conectados</p>
              <p class="mt-2 text-3xl font-semibold text-white">1.204</p>
            </div>
          </div>
          <ul class="mt-6 space-y-3 text-sm text-white/70">
            <li class="flex gap-3">
              <span class="mt-1 flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200">
                <i data-feather="check" class="h-3.5 w-3.5"></i>
              </span>
              <span>Saldo y puntos actualizados en tiempo real con cada acceso.</span>
            </li>
            <li class="flex gap-3">
              <span class="mt-1 flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200">
                <i data-feather="check" class="h-3.5 w-3.5"></i>
              </span>
              <span>Verificación dual QR + NFC con alertas inteligentes.</span>
            </li>
            <li class="flex gap-3">
              <span class="mt-1 flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200">
                <i data-feather="check" class="h-3.5 w-3.5"></i>
              </span>
              <span>Beneficios y experiencias curadas para la familia escarlata.</span>
            </li>
          </ul>
          <div class="mt-6 flex flex-wrap gap-2">
            <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-black/40 px-4 py-1.5 text-xs font-medium uppercase tracking-[0.3em] text-white/70"><i data-feather="shield" class="h-4 w-4"></i>Acceso seguro</span>
            <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-black/40 px-4 py-1.5 text-xs font-medium uppercase tracking-[0.3em] text-white/70"><i data-feather="star" class="h-4 w-4"></i>Socio Platinum</span>
            <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-black/40 px-4 py-1.5 text-xs font-medium uppercase tracking-[0.3em] text-white/70"><i data-feather="activity" class="h-4 w-4"></i>Tiempo real</span>
          </div>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div class="rounded-3xl border border-white/10 bg-white/5 p-5 shadow-xl backdrop-blur-xl">
            <p class="text-xs uppercase tracking-[0.35em] text-white/60">Próximo partido</p>
            <div class="mt-4 flex items-center justify-between gap-4">
              <div>
                <p class="text-lg font-semibold text-white">América vs Nacional</p>
                <p class="text-sm text-white/60">Domingo · Pascual Guerrero</p>
              </div>
              <div class="rounded-2xl bg-gradient-to-br from-rose-500 to-red-600 px-4 py-3 text-center text-white shadow-lg">
                <p class="text-xs uppercase tracking-[0.4em] text-white/80">Kick-off</p>
                <p class="text-lg font-semibold">8:10 PM</p>
              </div>
            </div>
            <div class="mt-5 flex items-center justify-between text-xs uppercase tracking-[0.3em] text-white/60">
              <span class="inline-flex items-center gap-2"><i data-feather="map-pin" class="h-4 w-4"></i>Puerta 3</span>
              <span class="inline-flex items-center gap-2"><i data-feather="smartphone" class="h-4 w-4"></i>NFC listo</span>
            </div>
          </div>
          <div class="rounded-3xl border border-emerald-400/40 bg-gradient-to-br from-emerald-500/10 to-emerald-500/5 p-5 shadow-xl backdrop-blur-xl">
            <p class="text-xs uppercase tracking-[0.35em] text-emerald-200">Beneficio destacado</p>
            <h3 class="mt-4 text-xl font-semibold text-white">1 bebida cortesía en tribuna occidental.</h3>
            <p class="mt-3 text-sm text-emerald-100/80">Escanea tu manilla en los puntos aliados y reclámala antes del minuto 30.</p>
            <div class="mt-5 inline-flex items-center gap-2 text-sm font-semibold text-emerald-200">
              <i data-feather="gift" class="h-4 w-4"></i>
              Disponible hoy
            </div>
          </div>
        </div>
      </aside>
      <div class="order-1 w-full lg:order-2 lg:justify-self-end">
        <div role="main" class="auth-shell rounded-3xl border border-white/10 bg-slate-950/70 p-6 shadow-2xl backdrop-blur-xl sm:p-8">
          <div class="space-y-8">
            <div class="space-y-4 text-center">
              <div class="relative mx-auto flex h-24 w-24 items-center justify-center rounded-full bg-gradient-to-br from-rose-500 via-red-500 to-red-600 shadow-2xl ring-4 ring-white/10">
                <img alt="Logo América de Cali" class="h-16 w-16 rounded-full" src="https://images.seeklogo.com/logo-png/26/1/america-de-cali-logo-png_seeklogo-262007.png"/>
              </div>
              <p class="text-xs font-semibold uppercase tracking-[0.4em] text-white/50">América pass</p>
              <h1 class="text-3xl font-semibold leading-tight text-white sm:text-[2rem]">Activa tu acceso inteligente</h1>
              <p class="text-base text-white/70">Conecta tu manilla NFC al instante o utiliza un código alterno para continuar.</p>
            </div>
            <div class="space-y-6">
              <div class="space-y-3" id="nfcSection">
                <button aria-label="Escanear manilla NFC" class="flex w-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-rose-500 via-red-500 to-red-600 py-4 text-base font-semibold text-white shadow-lg transition hover:shadow-rose-500/40 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-300 nfc-pulse" id="nfcButton">
                  <i data-feather="radio" class="h-5 w-5"></i>
                  <span>Escanear manilla NFC</span>
                </button>
                <p class="hidden text-sm text-rose-200/80 text-center" id="nfcUnsupported">
                  Este dispositivo no soporta NFC, usa QR o código.
                </p>
              </div>
              <div class="flex items-center gap-3 text-white/50">
                <span class="h-px flex-1 bg-white/15"></span>
                <span class="text-xs uppercase tracking-[0.35em]">o</span>
                <span class="h-px flex-1 bg-white/15"></span>
              </div>
              <div class="grid gap-3" id="fallbackSection">
                <button aria-label="Escanear código QR" class="group flex w-full items-center justify-center gap-3 rounded-2xl border border-white/15 bg-white/5 py-3 text-sm font-medium text-white/80 transition hover:border-white/40 hover:text-white" id="qrButton">
                  <i data-feather="maximize-2" class="h-4 w-4"></i>
                  <span>Escanear código QR</span>
                </button>
                <button aria-label="Ingresar código manual" class="group flex w-full items-center justify-center gap-3 rounded-2xl border border-white/15 bg-white/5 py-3 text-sm font-medium text-white/80 transition hover:border-white/40 hover:text-white" id="manualButton">
                  <i data-feather="keypad" class="h-4 w-4"></i>
                  <span>Ingresar código manual</span>
                </button>
              </div>
              <div class="hidden space-y-3" id="manualInputSection">
                <div>
                  <label class="text-xs font-medium uppercase tracking-[0.3em] text-white/50" for="manualCode">Código manual</label>
                  <input aria-label="Código de acceso" class="mt-2 w-full rounded-2xl border border-white/15 bg-white/10 px-4 py-3 text-base text-white placeholder:text-white/30 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400/40" id="manualCode" placeholder="Ingresa tu código" type="text"/>
                </div>
                <button aria-label="Validar código" class="flex w-full items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-rose-500 via-red-500 to-red-600 py-3 text-base font-semibold text-white shadow-lg transition hover:shadow-rose-500/40" id="validateButton">
                  Validar código
                </button>
              </div>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-5 text-left text-sm text-white/70 shadow-inner shadow-white/5">
              <div class="flex items-center gap-2 text-white">
                <i data-feather="help-circle" class="h-5 w-5 text-rose-300"></i>
                <h2 class="text-base font-semibold">¿Cómo funciona?</h2>
              </div>
              <ol class="mt-4 space-y-3">
                <li class="flex gap-3">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-rose-500/20 text-sm font-semibold text-rose-200">1</span>
                  <p>Acerca tu manilla NFC al dispositivo y espera la vibración de confirmación.</p>
                </li>
                <li class="flex gap-3">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-rose-500/20 text-sm font-semibold text-rose-200">2</span>
                  <p>Verificamos tu identidad y sincronizamos tu saldo y beneficios.</p>
                </li>
                <li class="flex gap-3">
                  <span class="flex h-8 w-8 items-center justify-center rounded-xl bg-rose-500/20 text-sm font-semibold text-rose-200">3</span>
                  <p>Accede a tu dashboard personalizado con estadísticas en vivo.</p>
                </li>
              </ol>
            </div>
            <div class="flex flex-wrap items-center justify-between gap-3 border-t border-white/10 pt-4 text-sm text-white/60">
              <div class="flex flex-wrap gap-2">
                <span class="inline-flex items-center gap-1.5 rounded-full border border-white/15 px-3 py-1 text-xs font-medium text-white/60"><i data-feather="wifi" class="h-3.5 w-3.5"></i>Contactless</span>
                <span class="inline-flex items-center gap-1.5 rounded-full border border-white/15 px-3 py-1 text-xs font-medium text-white/60"><i data-feather="award" class="h-3.5 w-3.5"></i>Socio Elite</span>
              </div>
              <button id="profileButton" type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-sm font-semibold text-white/80 transition hover:border-white/40 hover:text-white">
                <i data-feather="user" class="h-4 w-4"></i>
                Personalizar perfil
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="mt-10 flex flex-col items-center gap-2 border-t border-white/10 pt-6 text-xs text-white/60 sm:flex-row sm:justify-between sm:text-sm">
      <div class="flex flex-wrap justify-center gap-x-6 gap-y-1">
        <a class="transition hover:text-white" href="#">Términos</a>
        <a class="transition hover:text-white" href="#">Privacidad</a>
        <a class="transition hover:text-white" href="#">Soporte</a>
      </div>
      <p>© 2024 América de Cali · Manilla NFC</p>
    </footer>
  </div>
</div>

<div aria-live="assertive" class="toast pointer-events-auto fixed inset-x-4 bottom-6 z-[140] hidden rounded-2xl border border-white/15 bg-slate-950/90 px-5 py-3 text-sm font-medium text-white shadow-2xl backdrop-blur-xl sm:inset-x-auto sm:left-1/2 sm:-translate-x-1/2 sm:px-6 sm:py-3.5" id="toast" role="alert"></div>
<!-- Live alerts stack (goles, cambios, anuncios del club) -->
<div id="liveAlerts" class="pointer-events-none fixed right-4 top-6 z-[130] flex w-full max-w-sm flex-col gap-3 sm:right-10"></div>

  <!-- QR Scanner Modal (standalone, before scripts) -->
  <div id="qrModal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/60 p-4">
    <div class="bg-america-dark/95 text-white rounded-xl shadow-xl w-full max-w-md p-4 relative">
<div class="relative w-full overflow-hidden rounded-xl bg-black
            aspect-square xs:aspect-[4/3] sm:aspect-[3/2] md:aspect-video">        <video id="qrVideo" class="w-full h-full object-cover" autoplay muted playsinline></video>
        <canvas id="qrCanvas" class="hidden"></canvas>
<div class="absolute inset-0 pointer-events-none grid place-items-center">
  <!-- Marco proporcional al contenedor -->
  <div class="rounded-md border-2 border-white/80
              w-[62%] aspect-square max-w-[420px] max-h-[420px]"></div>
</div>
      </div>
      <div class="flex justify-between items-center mt-3">
        <p class="text-sm text-gray-300">Alinea el QR dentro del cuadrado</p>
        <button id="closeQrModal" class="bg-gray-800 hover:bg-gray-700 text-white text-sm py-2 px-3 rounded-lg">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Menú lateral principal -->
  <div id="mainMenuModal" class="fixed inset-0 z-[96] hidden items-stretch justify-end bg-black/60 backdrop-blur-sm">
    <div class="w-[86%] sm:w-[360px] h-full bg-america-dark/95 text-white border-l border-gray-800 p-4 flex flex-col">
      <div class="flex items-center justify-between border-b border-gray-800 pb-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-america-red grid place-items-center"><i data-feather="menu" class="w-4 h-4"></i></div>
          <div class="text-sm">Menú</div>
        </div>
        <button id="closeMainMenu" class="p-2 rounded-lg hover:bg-gray-800"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <div class="flex-1 overflow-y-auto mt-3 space-y-1">
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="profile"><i data-feather="user" class="w-4 h-4 mr-2 inline"></i>Perfil</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="promos"><i data-feather="gift" class="w-4 h-4 mr-2 inline"></i>Promociones</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="daily"><i data-feather="zap" class="w-4 h-4 mr-2 inline"></i>Reto diario</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="topup"><i data-feather="dollar-sign" class="w-4 h-4 mr-2 inline"></i>Recargar</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="food"><i data-feather="shopping-bag" class="w-4 h-4 mr-2 inline"></i>Comidas</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="map"><i data-feather="map-pin" class="w-4 h-4 mr-2 inline"></i>Mapa</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="show"><i data-feather="cast" class="w-4 h-4 mr-2 inline"></i>Show</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="family"><i data-feather="users" class="w-4 h-4 mr-2 inline"></i>Familia</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="experiences"><i data-feather="star" class="w-4 h-4 mr-2 inline"></i>Experiencias</button>
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800" data-action="events"><i data-feather="calendar" class="w-4 h-4 mr-2 inline"></i>Eventos</button>
      </div>
      <div class="pt-2 border-t border-gray-800">
        <button class="menu-item w-full text-left px-3 py-3 rounded-lg hover:bg-gray-800 text-red-300" data-action="logout"><i data-feather="log-out" class="w-4 h-4 mr-2 inline"></i>Cerrar sesión</button>
      </div>
    </div>
  </div>
  <!-- Modal Show (interfaz del espectáculo) -->
  <div id="showModal" class="fixed inset-0 z-[85] hidden items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-6">
    <div class="w-full sm:max-w-md bg-america-dark/95 text-white rounded-t-2xl sm:rounded-2xl shadow-2xl border border-gray-800 overflow-hidden">
      <div class="p-5 border-b border-gray-800 flex items-center justify-between">
        <h3 class="text-lg font-bold">Show del partido</h3>
        <button id="closeShowModal" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <div class="p-5 grid grid-cols-2 gap-3">
        <button id="openFlashFromShow" class="px-3 py-3 rounded-xl bg-gray-900 border border-gray-700 btn-3d-dark flex flex-col items-center gap-2" type="button">
          <i data-feather="zap" class="w-5 h-5"></i>
          <span class="text-sm">Luces (Flash)</span>
        </button>
        <button id="openTriviaFromShow" class="px-3 py-3 rounded-xl bg-gray-900 border border-gray-700 btn-3d-dark flex flex-col items-center gap-2" type="button">
          <i data-feather="help-circle" class="w-5 h-5"></i>
          <span class="text-sm">Trivia</span>
        </button>
        <button id="toggleRedFromShow" class="px-3 py-3 rounded-xl bg-gray-900 border border-gray-700 btn-3d-dark flex flex-col items-center gap-2" type="button">
          <i data-feather="monitor" class="w-5 h-5"></i>
          <span class="text-sm">Pantalla roja</span>
        </button>
        <button id="toggleVibrateFromShow" class="px-3 py-3 rounded-xl bg-gray-900 border border-gray-700 btn-3d-dark flex flex-col items-center gap-2" type="button">
          <i data-feather="smartphone" class="w-5 h-5"></i>
          <span class="text-sm">Vibración</span>
        </button>
      </div>
      <div class="px-5 pb-5 text-xs text-gray-400">Consejo: si el dispositivo no vibra, puede no estar soportado por el navegador.</div>
    </div>
  </div>

  <!-- Overlay global de resultado (pantalla completa) -->
  <div id="qrResultOverlay" class="fixed inset-0 z-[90] hidden items-center justify-center bg-black/60 backdrop-blur-md">
    <div class="flex flex-col items-center justify-center p-6">
      <div id="qrResultIcon" class="mb-3"></div>
      <p id="qrResultMessage" class="text-sm text-gray-200 text-center whitespace-pre-line font-mono"></p>
    </div>
  </div>

  <!-- Modal Recorte de Foto (Cropper) -->
  <div id="cropperModal" class="fixed inset-0 z-[92] hidden items-center justify-center bg-black/70 p-4">
    <div class="w-full max-w-md bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-4">
      <div class="text-sm text-gray-300 mb-3">Ajusta el recorte de tu foto</div>
      <div class="relative aspect-square bg-black rounded overflow-hidden">
        <img id="cropperImage" alt="Recorte" class="max-w-full select-none" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cropperCancel" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">Cancelar</button>
        <button id="cropperApply" class="px-4 py-2 rounded-lg bg-america-red hover:bg-red-700">Aplicar recorte</button>
      </div>
    </div>
  </div>

  <!-- Modal Recorte de Momento (Cropper rectangular con relación seleccionable) -->
  <div id="momentCropperModal" class="fixed inset-0 z-[92] hidden items-center justify-center bg-black/70 p-4">
    <div class="w-full max-w-2xl bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm text-gray-300">Ajusta tu momento</div>
        <button id="momentCropperCancel" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Cancelar</button>
      </div>
      <div class="flex flex-wrap gap-2 mb-3">
        <button class="aspect-btn px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm ring-2 ring-america-red" data-aspect="9:16">9:16</button>
        <button class="aspect-btn px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-aspect="16:9">16:9</button>
        <button class="aspect-btn px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-aspect="4:5">4:5</button>
        <button class="aspect-btn px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-aspect="1:1">1:1</button>
        <button class="aspect-btn px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm" data-aspect="free">Libre</button>
      </div>
      <div class="relative bg-black rounded overflow-hidden">
        <img id="momentCropperImage" alt="Recorte del momento" class="max-w-full select-none" />
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="momentCropperApply" class="px-4 py-2 rounded-lg bg-america-red hover:bg-red-700">Guardar recorte</button>
      </div>
    </div>
  </div>

  <!-- Modal Perfil (Personalización) -->
  <div id="profileModal" class="fixed inset-0 z-[88] hidden items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-6">
    <div class="w-full sm:max-w-md bg-america-dark/95 text-white rounded-t-2xl sm:rounded-2xl shadow-2xl border border-gray-800 overflow-hidden">
      <div class="p-5 border-b border-gray-800 flex items-center justify-between">
        <h3 class="text-lg font-bold">Tu perfil</h3>
        <button id="closeProfileModal" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <form id="profileForm" class="p-5 space-y-4">
        <div class="flex items-center gap-4">
          <div id="profilePreview" class="w-16 h-16 rounded-full bg-gray-800 grid place-items-center text-lg font-bold overflow-hidden">U</div>
          <div class="ml-auto">
            <label class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm cursor-pointer">
              <input id="profileImage" type="file" accept="image/*" class="hidden" />
              Subir foto
            </label>
          </div>
        </div>
        <div>
          <label for="profileFirstName" class="text-sm text-gray-400">Nombre</label>
          <input id="profileFirstName" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Tu nombre" type="text"/>
        </div>
        <div>
          <label for="profileLastName" class="text-sm text-gray-400">Apellido</label>
          <input id="profileLastName" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Tu apellido" type="text"/>
        </div>
        <div>
          <label for="profileAge" class="text-sm text-gray-400">Edad</label>
          <input id="profileAge" inputmode="numeric" min="1" max="120" class="mt-1 w-32 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Ej: 25" type="number"/>
        </div>
        <div>
          <label for="profilePhone" class="text-sm text-gray-400">Teléfono</label>
          <input id="profilePhone" inputmode="tel" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Tu teléfono" type="tel"/>
        </div>
        <div>
          <label for="profileDocument" class="text-sm text-gray-400">Documento</label>
          <input id="profileDocument" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Tu documento" type="text"/>
        </div>
        <div class="pt-2 flex justify-end gap-2">
          <button type="button" id="cancelProfileModal" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-america-red hover:bg-red-700">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Recarga -->
  <!-- Modal Familia -->
  <div id="familyModal" class="fixed inset-0 z-[88] hidden items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-6">
    <div class="w-full sm:max-w-2xl bg-america-dark/95 text-white rounded-t-2xl sm:rounded-2xl shadow-2xl border border-gray-800 overflow-hidden">
      <div class="p-5 border-b border-gray-800 flex items-center justify-between">
        <h3 class="text-lg font-bold">Familia Escarlata</h3>
        <button id="closeFamilyModal" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <div class="px-5 pt-4">
        <div class="flex gap-2 overflow-auto pb-2">
          <button data-tab="members" class="family-tab px-3 py-2 rounded-lg bg-gray-800 text-sm ring-2 ring-transparent">Miembros</button>
          <button data-tab="album" class="family-tab px-3 py-2 rounded-lg bg-gray-800 text-sm">Álbum</button>
          <button data-tab="ranking" class="family-tab px-3 py-2 rounded-lg bg-gray-800 text-sm">Ranking</button>
          <button data-tab="moments" class="family-tab px-3 py-2 rounded-lg bg-gray-800 text-sm">Momentos</button>
        </div>
      </div>
      <div class="p-5">
        <div id="familyTab-members" class="family-tab-view">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">Miembros</h4>
            <button id="addFamilyMemberBtn" class="bg-america-red hover:bg-red-700 px-3 py-2 rounded-lg text-sm flex items-center gap-2"><i data-feather="user-plus" class="w-4 h-4"></i>Agregar familiar</button>
          </div>
          <div id="familyMembersList" class="space-y-3"></div>
          <div id="familyEmptyState" class="text-center text-gray-300 py-8 hidden">
            <p class="mb-1">Aún no tienes familiares agregados.</p>
            <p class="text-sm text-gray-400">Agrega a tu papá, hijo o hermano para compartir progreso.</p>
          </div>
          <div id="familyAddForm" class="mt-4 hidden bg-gray-900 border border-gray-800 rounded-xl p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="text-sm text-gray-400">Nombre</label>
                <input id="famNameInput" type="text" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2" placeholder="Ej: Carlos" />
              </div>
              <div>
                <label class="text-sm text-gray-400">Relación</label>
                <select id="famRelationInput" class="fancy-select mt-1 w-full">
                  <option value="Mi papá">Mi papá</option>
                  <option value="Mi hijo">Mi hijo</option>
                  <option value="Mi hermano">Mi hermano</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-400">Foto (opcional)</label>
                <input id="famPhotoInput" type="file" accept="image/*" class="mt-1 w-full text-sm" />
              </div>
            </div>
            <div class="flex justify-end gap-2 mt-3">
              <button id="cancelAddFam" class="px-3 py-2 rounded-lg bg-gray-800">Cancelar</button>
              <button id="saveAddFam" class="px-3 py-2 rounded-lg bg-america-red">Guardar</button>
            </div>
          </div>
        </div>
        <div id="familyTab-album" class="family-tab-view hidden">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">Álbum compartido</h4>
            <span id="familyAlbumSummary" class="text-sm text-gray-400">0/200</span>
          </div>
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <div class="progress-bar"><div id="familyAlbumBar" class="progress-fill" style="width:0%"></div></div>
            <div class="text-sm text-gray-400 mt-2">Suma de láminas de todos los miembros</div>
          </div>
          <div class="mt-4">
            <label class="text-sm text-gray-400">Sumar láminas al miembro</label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
              <select id="albumMemberSelect" class="fancy-select"></select>
              <input id="albumAddCount" type="number" min="1" value="1" class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-2"/>
              <button id="albumAddBtn" class="bg-america-red hover:bg-red-700 rounded-lg px-3 py-2">Sumar</button>
            </div>
          </div>
          <div class="mt-5">
            <h5 class="font-semibold mb-2">Detalle por miembro</h5>
            <div id="albumBreakdown" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
          </div>
        </div>
        <div id="familyTab-ranking" class="family-tab-view hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Más partidos</h4>
                <span class="text-xs text-gray-400">Asistencias</span>
              </div>
              <div id="rankingMatches" class="space-y-2"></div>
              <div class="mt-3 grid grid-cols-3 gap-2">
                <select id="matchMemberSelect" class="fancy-select"></select>
                <button id="addMatchBtn" class="bg-gray-800 hover:bg-gray-700 rounded-lg px-3 py-2">+1</button>
                <button id="subMatchBtn" class="bg-gray-800 hover:bg-gray-700 rounded-lg px-3 py-2">-1</button>
              </div>
            </div>
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Más trivias ganadas</h4>
                <span class="text-xs text-gray-400">Victorias</span>
              </div>
              <div id="rankingTrivias" class="space-y-2"></div>
              <div class="mt-3 grid grid-cols-3 gap-2">
                <select id="triviaMemberSelect" class="fancy-select"></select>
                <button id="addTriviaBtn" class="bg-gray-800 hover:bg-gray-700 rounded-lg px-3 py-2">+1</button>
                <button id="subTriviaBtn" class="bg-gray-800 hover:bg-gray-700 rounded-lg px-3 py-2">-1</button>
              </div>
            </div>
          </div>
        </div>
        <div id="familyTab-moments" class="family-tab-view hidden">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">Momentos heredados</h4>
            <button id="addMomentBtn" class="bg-america-red hover:bg-red-700 px-3 py-2 rounded-lg text-sm flex items-center gap-2"><i data-feather="camera" class="w-4 h-4"></i>Nuevo momento</button>
          </div>
          <input id="momentPhotoInput" type="file" accept="image/*" class="hidden" />
          <div id="momentsTimeline" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>
  <div id="topUpModal" class="fixed inset-0 z-[80] hidden items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-6">
    <div class="w-full sm:max-w-md bg-america-dark/95 text-white rounded-t-2xl sm:rounded-2xl shadow-2xl border border-gray-800">
      <div class="p-5 border-b border-gray-800 flex items-center justify-between">
        <h3 class="text-lg font-bold">Recargar saldo</h3>
        <button id="closeTopUp" class="p-2 rounded-lg hover:bg-gray-800"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>

      <div class="p-5 space-y-6">
        <!-- Monto -->
        <div>
          <p class="text-sm text-gray-400 mb-2">Selecciona un monto</p>
          <div class="grid grid-cols-4 gap-2">
            <button class="topup-amount chip px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 hover:border-gray-600" data-amount="10000">$10.000</button>
            <button class="topup-amount chip px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 ring-2 ring-america-red" data-amount="20000">$20.000</button>
            <button class="topup-amount chip px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 hover:border-gray-600" data-amount="50000">$50.000</button>
            <button class="topup-amount chip px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 hover:border-gray-600" data-amount="100000">$100.000</button>
          </div>
          <div class="mt-3">
            <label for="customAmount" class="text-sm text-gray-400">Otro monto</label>
            <div class="mt-1 flex items-center gap-2">
              <span class="text-gray-400">$</span>
              <input id="customAmount" type="text" inputmode="numeric" pattern="[0-9]*" min="1000" step="1000" placeholder="Ingresa un valor" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-america-red"/>
            </div>
          </div>
        </div>

        <!-- Método de pago -->
        <div>
          <p class="text-sm text-gray-400 mb-2">Método de pago</p>
          <div class="grid grid-cols-3 gap-2">
            <button class="topup-method px-3 py-3 rounded-lg bg-gray-900 border border-gray-700 ring-2 ring-america-red flex flex-col items-center gap-2" data-method="card">
              <i data-feather="credit-card" class="w-5 h-5"></i>
              <span class="text-xs">Tarjeta</span>
            </button>
            <button class="topup-method px-3 py-3 rounded-lg bg-gray-900 border border-gray-700 flex flex-col items-center gap-2 hover:border-gray-600" data-method="pse">
              <i data-feather="banknote" class="w-5 h-5"></i>
              <span class="text-xs">PSE</span>
            </button>
            <button class="topup-method px-3 py-3 rounded-lg bg-gray-900 border border-gray-700 flex flex-col items-center gap-2 hover:border-gray-600" data-method="wallet">
              <i data-feather="smartphone" class="w-5 h-5"></i>
              <span class="text-xs">Billetera</span>
            </button>
          </div>
        </div>

        <!-- Resumen -->
        <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-400">Monto</span>
            <span id="topUpAmountLabel" class="font-medium">$20.000</span>
          </div>
          <div class="flex items-center justify-between text-sm mt-2">
            <span class="text-gray-400">Costo de recarga</span>
            <span id="topUpFeeLabel" class="font-medium">$0</span>
          </div>
          <div class="flex items-center justify-between text-sm mt-2">
            <span class="text-gray-400">Total a pagar</span>
            <span id="topUpTotalLabel" class="font-bold">$20.000</span>
          </div>
        </div>

        <!-- CTA -->
        <button id="topUpPayBtn" class="w-full bg-america-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
          <i data-feather="arrow-up-circle" class="w-5 h-5"></i>
          <span>Recargar ahora</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Verificación para Recarga -->
  <div id="verificationModal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-md bg-america-dark/95 text-white rounded-xl shadow-2xl border border-gray-800 p-6">
      <div class="text-center mb-6">
        <h3 class="text-lg font-bold mb-2">Verificar identidad</h3>
        <p class="text-gray-300">Elige un método para confirmar la recarga</p>
      </div>
      <div class="space-y-4">
        <button id="verifyNfcBtn" class="w-full bg-america-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all">
          <i class="w-5 h-5" data-feather="radio"></i>
          <span>NFC</span>
        </button>
        <button id="verifyQrBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2">
          <i class="w-4 h-4" data-feather="maximize-2"></i>
          <span>Escanear QR</span>
        </button>
        <button id="verifyCodeBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2">
          <i class="w-4 h-4" data-feather="keypad"></i>
          <span>Ingresar código</span>
        </button>
      </div>
      <div class="hidden mt-4" id="verifyCodeSection">
        <input id="verifyCodeInput" class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Ingresa tu código" type="text"/>
        <button id="verifyCodeSubmit" class="w-full mt-3 bg-america-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl">Verificar</button>
      </div>
      <div class="mt-4 text-right">
        <button id="closeVerification" class="px-4 py-2 rounded-lg bg-transparent border border-gray-600 hover:bg-gray-800">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Código de Canje -->
  <div id="redeemModal" class="fixed inset-0 z-[85] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-md bg-america-dark/95 text-white rounded-xl shadow-2xl border border-gray-800 p-6">
      <div class="text-center mb-4">
        <h3 class="text-lg font-bold mb-1">Tu código de canje</h3>
        <p class="text-gray-300 text-sm">Presenta este código para canjear tu beneficio</p>
      </div>
      <div class="bg-black/60 border border-gray-700 rounded-xl p-4 text-center">
        <code id="redeemCodeValue" class="font-mono text-xl tracking-widest select-all">XXXXXXXXXXXXXXX</code>
      </div>
      <p id="redeemCodeExpiry" class="text-gray-400 text-xs mt-2 text-center">Expira en 15:00</p>
      <div class="mt-4 flex gap-2 justify-center">
        <button id="copyRedeemCodeBtn" class="bg-gray-800 hover:bg-gray-700 text-white py-2 px-3 rounded-lg text-sm" type="button">Copiar</button>
        <button id="shareRedeemCodeBtn" class="bg-gray-800 hover:bg-gray-700 text-white py-2 px-3 rounded-lg text-sm" type="button">Compartir</button>
        <button id="closeRedeemModal" class="bg-america-red hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Comidas (Domicilio en el estadio) -->
  <div id="foodModal" class="fixed inset-0 z-[85] hidden items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-6">
    <div class="w-full sm:max-w-2xl bg-america-dark/95 text-white rounded-t-2xl sm:rounded-2xl shadow-2xl border border-gray-800 overflow-hidden">
      <div class="p-5 border-b border-gray-800 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-america-red/90 grid place-items-center"><i data-feather="shopping-bag" class="w-4 h-4"></i></div>
          <div>
            <h3 class="text-lg font-bold leading-none">Comidas en tu asiento</h3>
            <p class="text-xs text-gray-400">Pide y te lo llevamos a tu tribuna</p>
          </div>
        </div>
        <button id="closeFoodModal" class="p-2 rounded-lg hover:bg-gray-800"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>

      <div class="p-5 max-h-[75vh] overflow-y-auto overscroll-contain">
        <!-- Paso: Menú -->
        <div id="foodMenuView" class="space-y-5">
          <div>
            <p class="text-sm text-gray-300">Clásicos del estadio</p>
            <div id="foodGrid" class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
          </div>
        </div>

        <!-- Paso: Checkout -->
        <div id="foodCheckoutView" class="hidden space-y-4">
          <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <h4 class="font-semibold mb-2">Tu pedido</h4>
            <div id="cartList" class="space-y-2 text-sm"></div>
            <div class="mt-3 flex items-center justify-between text-sm">
              <span class="text-gray-400">Subtotal</span>
              <span id="cartSubtotal" class="font-medium">$0</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-400">Servicio a asiento</span>
              <span id="cartService" class="font-medium">$3,000</span>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-800 flex items-center justify-between font-semibold">
              <span>Total</span>
              <span id="cartTotal">$0</span>
            </div>
          </div>

          <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <h4 class="font-semibold mb-3">Tu ubicación</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <label class="text-xs text-gray-400">Tribuna</label>
                <div class="relative mt-1">
                  <select id="seatTribuna" class="w-full pr-10">
                    <option value="" disabled selected>Selecciona</option>
                    <option>Norte</option>
                    <option>Sur</option>
                    <option>Oriental</option>
                    <option>Occidental</option>
                  </select>
                  <!-- Chevron decorativo -->
                  <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
              </div>
              <div>
                <label class="text-xs text-gray-400">Fila</label>
                <input id="seatFila" type="text" inputmode="numeric" class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Ej: 12" />
              </div>
              <div>
                <label class="text-xs text-gray-400">Silla</label>
                <input id="seatSilla" type="text" inputmode="numeric" class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-america-red" placeholder="Ej: 18" />
              </div>
            </div>
          </div>

          <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
            <h4 class="font-semibold mb-2">Pago</h4>
            <div class="grid grid-cols-3 gap-2 text-center">
              <button id="payWithWallet" class="px-3 py-3 rounded-lg bg-gray-900 border border-gray-700 ring-2 ring-america-red flex flex-col items-center gap-2" type="button">
                <i data-feather="dollar-sign" class="w-5 h-5"></i>
                <span class="text-xs">Saldo</span>
              </button>
              <button class="px-3 py-3 rounded-lg bg-gray-900 border border-gray-700 flex flex-col items-center gap-2 opacity-60 cursor-not-allowed" type="button" disabled>
                <i data-feather="credit-card" class="w-5 h-5"></i>
                <span class="text-xs">Tarjeta</span>
              </button>
              <button class="px-3 py-3 rounded-lg bg-gray-900 border border-gray-700 flex flex-col items-center gap-2 opacity-60 cursor-not-allowed" type="button" disabled>
                <i data-feather="smartphone" class="w-5 h-5"></i>
                <span class="text-xs">Billetera</span>
              </button>
            </div>
          </div>

          <button id="confirmFoodPayment" class="w-full bg-america-red hover:bg-red-700 text-white font-semibold py-3 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed" type="button" disabled>
            Pagar y finalizar
          </button>
        </div>

        <!-- Paso: Éxito -->
        <div id="foodSuccessView" class="hidden text-center space-y-3">
          <div class="mx-auto w-20 h-20 rounded-full bg-green-600/20 grid place-items-center">
            <svg class="w-10 h-10 text-green-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 7L9 18l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <h4 class="text-xl font-extrabold">¡Pedido confirmado!</h4>
          <p id="foodSuccessMsg" class="text-sm text-gray-300"></p>
          <button id="closeFoodSuccess" class="mt-2 bg-gray-800 hover:bg-gray-700 text-white py-2 px-4 rounded-lg" type="button">Cerrar</button>
        </div>
      </div>

      <!-- Footer del menú: resumen y acción -->
      <div id="foodCartBar" class="p-4 border-t border-gray-800 bg-black/50 flex items-center justify-between">
        <div class="text-sm text-gray-300"><span id="cartCount">0</span> ítems • <span id="cartTotalBar">$0</span></div>
        <div class="flex gap-2">
          <button id="goToCheckout" class="bg-america-red hover:bg-red-700 text-white py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" type="button" disabled>Ir a pagar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Eventos -->
  <!-- (Se eliminó el apartado de Show) -->
  <div id="eventsModal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div id="eventsModalContent" class="w-full max-w-2xl bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">Calendario de eventos</h3>
        <button id="closeEventsModal" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <div id="eventsScroll" class="max-h-[70vh] overflow-y-auto overscroll-contain">
        <div id="eventsModalList" class="space-y-3">
          <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 animate-pulse">
            <div class="flex justify-between items-start">
              <div class="w-40 h-4 bg-gray-800 rounded"></div>
              <div class="w-20 h-4 bg-gray-800 rounded"></div>
            </div>
            <div class="mt-3 w-56 h-3 bg-gray-800 rounded"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Trivia -->
  <div id="triviaModal" class="fixed inset-0 z-[85] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-xl bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">Trivia Escarlata</h3>
        <button id="closeTrivia" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <div id="triviaIntro" class="space-y-3">
        <p class="text-gray-300 text-sm">Responde 10 preguntas sobre el América de Cali. Si aciertas 5, ganas un código de descuento. Tienes 10 segundos por pregunta.</p>
        <button id="startTrivia" class="w-full bg-america-red hover:bg-red-700 text-white font-semibold py-3 rounded-xl">Comenzar</button>
      </div>
      <div id="triviaGame" class="hidden">
        <div class="flex items-center justify-between text-sm text-gray-400 mb-3">
          <span id="triviaProgress">Pregunta 1/10</span>
          <span id="triviaScore">Aciertos: 0</span>
        </div>
        <div class="mb-4">
          <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
            <span>Tiempo</span>
            <span id="triviaTimerLabel">10s</span>
          </div>
          <div class="timer-bar w-full bg-gray-800/80 border border-gray-700 rounded-full h-3 overflow-hidden">
            <div id="triviaTimerFill" class="timer-fill h-full w-full"></div>
          </div>
        </div>
        <div id="triviaQuestion" class="text-base font-semibold mb-4">Pregunta</div>
        <div id="triviaOptions" class="grid grid-cols-1 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Modal Mapa del Estadio -->
  <!-- Modal Reto diario -->
  <div id="dailyChallengeModal" class="fixed inset-0 z-[84] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-md bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Reto de hoy</h3>
        <button id="closeDailyChallenge" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700"><i data-feather="x" class="w-4 h-4"></i></button>
      </div>
      <div id="dailyChallengeBody" class="space-y-3">
        <p id="dailyChallengeQuestion" class="font-medium">Pregunta</p>
        <input id="dailyChallengeAnswer" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-white" placeholder="Tu respuesta" />
        <button id="submitDailyChallenge" class="w-full bg-america-red hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Responder</button>
        <p class="text-xs text-gray-400">Premio: +10 pts y suma en ranking familiar</p>
      </div>
    </div>
  </div>

  <!-- Modal Experiencias -->
  <div id="experiencesModal" class="fixed inset-0 z-[84] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-lg bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">Canjea experiencias</h3>
        <button id="closeExperiences" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700"><i data-feather="x" class="w-4 h-4"></i></button>
      </div>
      <div class="space-y-3" id="experiencesList">
        <!-- Items -->
      </div>
      <p class="text-xs text-gray-400 mt-3">Se descuenta de tus puntos. Recibirás un código de confirmación.</p>
    </div>
  </div>

  <div id="mapModal" class="fixed inset-0 z-[82] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-3xl bg-america-dark/95 text-white rounded-none shadow-2xl border border-gray-800 overflow-hidden">
      <div class="p-5 border-b border-gray-800 flex items-center justify-between">
        <h3 class="text-lg font-bold">Mapa del Estadio</h3>
        <div class="flex items-center gap-2">
          <button id="locateMeBtn" class="px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm" type="button"><i data-feather="crosshair" class="w-4 h-4"></i></button>
          <button id="closeMapModal" class="px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm" type="button"><i data-feather="x" class="w-4 h-4"></i></button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-[1fr,260px] gap-0">
        <div class="relative p-4">
          <div class="relative w-full rounded-none overflow-hidden border border-gray-800 bg-black aspect-[16/10]">
            <svg id="stadiumSvg" viewBox="0 0 1000 700" class="absolute inset-0 w-full h-full">
              <defs>
                <linearGradient id="gradField" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#0f1115"/>
                  <stop offset="100%" stop-color="#0b0b0b"/>
                </linearGradient>
              </defs>
              <!-- Cancha rectangular -->
              <rect x="250" y="150" width="500" height="400" fill="url(#gradField)" stroke="#065f46"/>
              <rect x="250" y="150" width="500" height="400" fill="none" stroke="#10b981" stroke-opacity="0.4" stroke-width="2" stroke-dasharray="6 6"/>

              <!-- Sectores anulares generados por JS -->
              <g id="sectors"></g>

              <!-- Puntos de interés y ruta ejemplo -->
              <g id="pois"></g>
              <!-- Capas emocionales y puntos de encuentro -->
              <g id="emotions"></g>
              <g id="meetups"></g>
              <!-- Rutas -->
              <polyline id="evacRoute" points="500,350 900,350 900,650" stroke="#ffffff" stroke-width="4" fill="none" stroke-dasharray="8 8" stroke-linecap="round"/>
              <polyline id="familyRoute" points="" />
              <g id="familyFootsteps"></g>
              <g id="userMarker" transform="translate(500, 350)" opacity="0">
                <circle r="10" fill="#D32F2F"/>
                <circle r="20" fill="#D32F2F" opacity="0.15">
                  <animate attributeName="r" values="16;28;16" dur="2s" repeatCount="indefinite" />
                </circle>
              </g>
            </svg>
            <div id="mapTooltip" class="pointer-events-none absolute z-10 px-2 py-1 rounded bg-black/80 border border-gray-700 text-xs text-gray-100 hidden"></div>
          </div>
        </div>
        <div class="p-4 border-t lg:border-t-0 lg:border-l border-gray-800 space-y-4">
          <div>
            <h4 class="font-semibold mb-2">Piso</h4>
            <div class="grid grid-cols-3 gap-2">
              <button type="button" data-floor="1" class="floor-btn px-3 py-2 rounded-lg bg-gray-900 border border-gray-700">Piso 1</button>
              <button type="button" data-floor="2" class="floor-btn px-3 py-2 rounded-lg bg-gray-900 border border-gray-700">Piso 2</button>
              <button type="button" data-floor="3" class="floor-btn px-3 py-2 rounded-lg bg-gray-900 border border-gray-700">Piso 3</button>
            </div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">Capas</h4>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerBath" class="accent-red-600" checked/> Baños</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerFood" class="accent-red-600" checked/> Comida</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerExit" class="accent-red-600" checked/> Salidas</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerRoute" class="accent-red-600" checked/> Rutas</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerMural" class="accent-red-600" checked/> Murales</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerPassion" class="accent-red-600" checked/> Pasión</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="layerHistory" class="accent-red-600" checked/> Historia</label>
            </div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">Piso seleccionado</h4>
            <div id="currentStand" class="text-sm text-gray-300">Detectando…</div>
          </div>
          <div class="text-xs text-gray-400">Nota: ubicación estimada por GPS. En interiores puede ser limitada.</div>
          <div>
            <h4 class="font-semibold mb-2">Guía familiar</h4>
            <div class="grid grid-cols-1 gap-2">
              <select id="entradaSelect" class="fancy-select">
                <option value="norte">Entrada Norte</option>
                <option value="occidental">Entrada Occidental</option>
                <option value="sur">Entrada Sur</option>
                <option value="oriental">Entrada Oriental</option>
              </select>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="withChild" class="accent-red-600" checked/> Con mi hijo</label>
              <button id="traceFamilyRouteBtn" class="px-3 py-2 rounded-lg bg-america-red hover:bg-red-700 text-sm">Trazar ruta familiar</button>
            </div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">Puntos de encuentro</h4>
            <div class="grid grid-cols-2 gap-2">
              <button id="markMeetBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Marcar aquí</button>
              <button id="clearMeetBtn" class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">Limpiar</button>
            </div>
            <div id="meetList" class="mt-2 space-y-1 text-sm text-gray-300 max-h-28 overflow-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Felicitación Trivia -->
  <!-- Modal Flash / Juego de luces -->
  <div id="flashModal" class="fixed inset-0 z-[85] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="w-full max-w-md bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">Luces con Flash</h3>
        <button id="closeFlashModal" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
      </div>
      <p class="text-xs text-yellow-300 mb-4">⚠️ Precaución: efectos estroboscópicos pueden afectar a personas fotosensibles. Límite recomendado ≤ 10 Hz.</p>
      <div class="space-y-5">
        <div>
          <label class="text-sm text-gray-400">Patrón</label>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <button class="flash-pattern px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 btn-3d-dark" data-pattern="strobe" type="button">Strobe</button>
            <button class="flash-pattern px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 btn-3d-dark" data-pattern="pulse" type="button">Pulso</button>
            <button class="flash-pattern px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 btn-3d-dark" data-pattern="sos" type="button">SOS</button>
          </div>
        </div>
        <div>
          <label for="flashBpm" class="text-sm text-gray-400">Velocidad (BPM)</label>
          <input id="flashBpm" type="range" min="30" max="180" step="1" value="120" class="w-full">
          <div class="text-xs text-gray-400 mt-1">≈ <span id="flashHz">2.0</span> Hz</div>
        </div>
        <div class="flex gap-2">
          <button id="flashStartBtn" class="flex-1 bg-america-red hover:bg-red-700 text-white py-2 px-4 rounded-lg btn-3d-red" type="button">Iniciar</button>
          <button id="flashStopBtn" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-2 px-4 rounded-lg btn-3d-dark" type="button">Apagar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay blanco para fallback sin torch -->
  <div id="screenFlash" class="fixed inset-0 bg-white hidden" style="z-index:95; opacity:1;"></div>
  <div id="triviaWinModal" class="fixed inset-0 z-[90] hidden items-center justify-center bg-black/70 backdrop-blur-sm p-4">
    <div class="w-full max-w-md bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-6 text-center">
      <img src="https://images.seeklogo.com/logo-png/26/1/america-de-cali-logo-png_seeklogo-262007.png" alt="Escudo América de Cali" class="mx-auto w-28 h-28 mb-3">
      <h3 class="text-2xl font-extrabold mb-2">¡Lo lograste!</h3>
      <p class="text-gray-300 mb-4">10/10 respuestas correctas. ¡Orgullo escarlata!</p>
      <button id="closeTriviaWin" class="bg-america-red hover:bg-red-700 text-white py-2 px-4 rounded-lg">Cerrar</button>
    </div>
  </div>

  <div id="dashboardSection" class="hidden">
    <div class="bg-america-dark text-white min-h-screen">
      <header class="dashboard-topbar">
        <div class="dashboard-topbar__inner">
          <div class="flex items-center gap-3 min-w-0">
            <div id="profileAvatar" class="dashboard-topbar__avatar">
              <span id="profileInitial" class="font-bold">V</span>
              <img id="profileAvatarImg" class="w-full h-full object-cover hidden rounded-full" src="" alt="Profile">
            </div>
            <div class="dashboard-topbar__meta">
              <h1 id="profileGreeting" class="font-bold">Hola, Valentina</h1>
              <p id="profileMeta" class="truncate"></p>
              <small class="dashboard-topbar__date text-xs text-gray-400">Hoy es <span id="currentDate"></span> • <span id="currentTime"></span></small>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="openMainMenu" class="icon-button" aria-label="Menú"><i data-feather="menu" class="w-5 h-5"></i></button>
          </div>
        </div>
      </header>

      <main class="dashboard-shell">
         <section id="sectionNav" class="section-nav">
          <div class="flex gap-2 overflow-x-auto no-scrollbar">
            <button class="chip px-3 py-1.5 rounded-lg text-sm" data-section="#secResumen">Resumen</button>
            <button class="chip px-3 py-1.5 rounded-lg text-sm" data-section="#secPromos">Promos</button>
            <button class="chip px-3 py-1.5 rounded-lg text-sm" data-section="#secPasaporte">Pasaporte</button>
            <button class="chip px-3 py-1.5 rounded-lg text-sm" data-section="#secComunidad">Comunidad</button>
            <button class="chip px-3 py-1.5 rounded-lg text-sm" data-section="#secEventos">Eventos</button>
            <button class="chip px-3 py-1.5 rounded-lg text-sm" data-section="#secActividad">Actividad</button>
          </div>
        </section>

        <section class="grid gap-6 lg:grid-cols-[minmax(0,1.4fr)_minmax(0,0.85fr)]" data-aos="fade-up">
          <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl backdrop-blur-xl lg:p-8">
            <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
              <div>
                <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-white/70">
                  <i data-feather="flag" class="h-4 w-4"></i>
                  Próximo encuentro
                </span>
                <h2 class="mt-4 text-2xl font-semibold text-white sm:text-[2rem]">América vs Atlético Nacional</h2>
                <p class="mt-2 text-sm text-white/70">Pascual Guerrero · Domingo 8:10 PM</p>
              </div>
              <div class="flex items-center gap-4 rounded-2xl border border-white/15 bg-black/40 px-5 py-4 text-white shadow-xl">
                <div>
                  <p class="text-xs uppercase tracking-[0.35em] text-white/50">Puerta asignada</p>
                  <p class="text-lg font-semibold text-white">Occidental 3</p>
                </div>
                <div class="h-12 w-px bg-white/10"></div>
                <div>
                  <p class="text-xs uppercase tracking-[0.35em] text-white/50">Butaca</p>
                  <p class="text-lg font-semibold text-white">Fila 12 · Silla 18</p>
                </div>
              </div>
            </div>
            <div class="mt-6 grid gap-4 sm:grid-cols-3">
              <div class="rounded-2xl border border-white/15 bg-black/35 p-4 text-white/70">
                <p class="text-xs uppercase tracking-[0.3em] text-white/50">Check-in</p>
                <p class="mt-2 text-xl font-semibold text-white">19:05</p>
                <p class="text-xs text-white/40">Recomendado</p>
              </div>
              <div class="rounded-2xl border border-white/15 bg-black/35 p-4 text-white/70">
                <p class="text-xs uppercase tracking-[0.3em] text-white/50">Compañía</p>
                <p class="mt-2 text-xl font-semibold text-white">+3 invitados</p>
                <p class="text-xs text-white/40">Familia Escarlata</p>
              </div>
              <div class="rounded-2xl border border-white/15 bg-black/35 p-4 text-white/70">
                <p class="text-xs uppercase tracking-[0.3em] text-white/50">Beneficio</p>
                <p class="mt-2 text-xl font-semibold text-white">2x1 bebidas</p>
                <p class="text-xs text-white/40">Hasta minuto 30</p>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-4 lg:gap-6">
            <div class="rounded-3xl border border-white/10 bg-white/5 p-5 shadow-xl backdrop-blur-xl">
              <div class="flex items-center justify-between gap-4">
                <div>
                  <p class="text-xs uppercase tracking-[0.35em] text-white/60">Pulso del estadio</p>
                  <p class="mt-2 text-lg font-semibold text-white">Ambiente al 92%</p>
                  <p class="text-xs text-white/60">Más vibrante que el último partido</p>
                </div>
                <div class="flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-rose-500 to-red-600 text-2xl font-semibold text-white shadow-lg">92%</div>
              </div>
            </div>
            <div class="grid gap-3 sm:grid-cols-2">
              <button id="navTopUpBtn" type="button" class="flex items-center justify-between gap-3 rounded-2xl border border-white/20 bg-gradient-to-r from-rose-500 via-red-500 to-red-600 px-5 py-4 text-left text-white shadow-lg transition hover:shadow-rose-500/40">
                <span>
                  <span class="block text-xs uppercase tracking-[0.35em] text-white/80">Recarga rápida</span>
                  <span class="mt-1 block text-lg font-semibold">Agregar saldo</span>
                </span>
                <i data-feather="arrow-up-right" class="h-5 w-5"></i>
              </button>
              <button id="dashboardProfileCta" type="button" class="flex items-center justify-between gap-3 rounded-2xl border border-white/20 bg-white/5 px-5 py-4 text-left text-white/80 transition hover:border-white/40 hover:text-white">
                <span>
                  <span class="block text-xs uppercase tracking-[0.35em]">Personaliza</span>
                  <span class="mt-1 block text-lg font-semibold text-white">Actualizar perfil</span>
                </span>
                <i data-feather="settings" class="h-5 w-5"></i>
              </button>
            </div>
          </div>
        </section>

        <div id="secResumen" class="dash-anchor"></div>
        <header class="dash-section-header mt-4">
          <h2 class="dash-section-title"><i data-feather="activity" class="w-4 h-4 text-america-red"></i> Tu resumen</h2>
          <span class="dash-section-sub">Puntos, saldo y álbum</span>
        </header>
        <section id="summaryGrid" class="dash-grid dash-grid--summary my-6">
          <div class="dash-card bg-gray-900 rounded-xl p-5" data-aos="fade-up">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-sm text-gray-400 font-medium">Tus puntos</h2>
              <i data-feather="award" class="text-america-red"></i>
            </div>
            <p class="text-3xl font-bold" id="pointsValue" data-amount="1850">1,850</p>
            <p class="text-sm text-gray-400 mt-1">Nivel: Familia Escarlata</p>
          </div>
          <div class="dash-card bg-gray-900 rounded-xl p-5" data-aos="fade-up" data-aos-delay="100">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-sm text-gray-400 font-medium">Saldo disponible</h2>
              <i data-feather="dollar-sign" class="text-america-red"></i>
            </div>
            <p class="text-3xl font-bold" id="balanceAmount" data-amount="42500">$42,500</p>
            <p class="text-sm text-gray-400 mt-1">COP</p>
          </div>
          <div class="dash-card bg-gray-900 rounded-xl p-5" data-aos="fade-up" data-aos-delay="200">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-sm text-gray-400 font-medium">Álbum Escarlata</h2>
              <i data-feather="image" class="text-america-red"></i>
            </div>
            <p id="albumProgressLabel" class="text-xl font-bold">137/200</p>
            <div class="progress-bar mt-2"><div id="albumProgressBarFill" class="progress-fill" style="width:68.5%"></div></div>
            <button class="mt-3 text-sm bg-america-red hover:bg-red-700 py-1 px-3 rounded-lg">Canjear lámina</button>
          </div>
          <div class="dash-card bg-gray-900 rounded-xl p-5 dash-card--wide" data-aos="fade-up" data-aos-delay="300">
            <div class="dash-card__header">
              <div>
                <h2 class="text-gray-200 font-semibold text-base">Asistencia del Pascual</h2>
                <p class="text-sm text-gray-400">Últimos 6 partidos como local</p>
              </div>
              <span id="attendanceChange" class="dash-chip">0%</span>
            </div>
            <div class="sparkline-wrapper">
              <div id="attendanceSpark" class="sparkline"></div>
            </div>
            <dl class="sparkline-summary">
              <div>
                <dt>Último juego</dt>
                <dd id="attendanceLatest">--</dd>
              </div>
              <div>
                <dt>Promedio</dt>
                <dd id="attendanceAverage">--</dd>
              </div>
              <div>
                <dt>Máximo</dt>
                <dd id="attendancePeak">--</dd>
              </div>
            </dl>
            <div class="sparkline-labels" id="attendanceSparkLabels"></div>
          </div>
        </section>

        <div id="secPromos" class="dash-anchor"></div>
        <header class="dash-section-header mt-8">
          <h2 class="dash-section-title"><i data-feather="gift" class="w-4 h-4 text-america-red"></i> Promociones y Experiencias</h2>
          <span class="dash-section-sub">Ofertas dinámicas y canjes</span>
        </header>
        <!-- Promociones y Experiencias -->
        <section id="promosSection" class="my-4" data-aos="fade-up">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">Para ti</h3>
            <button id="openExperiencesBtn" class="text-sm bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg flex items-center gap-2"><i data-feather="star" class="w-4 h-4"></i>Experiencias</button>
          </div>
          <!-- Cupones rápidos para no dejar vacío el bloque cuando hay pocas promos -->
          <div id="promoQuickRow" class="flex gap-2 overflow-x-auto no-scrollbar mb-3"></div>
          <div id="promosContainer" class="dash-grid dash-grid--two"></div>
        </section>

        <div id="secPasaporte" class="dash-anchor"></div>
        <header class="dash-section-header mt-8">
          <h2 class="dash-section-title"><i data-feather="map-pin" class="w-4 h-4 text-america-red"></i> Pasaporte gastronómico</h2>
          <span class="dash-section-sub">Sella cada compra y desbloquea beneficios gourmet</span>
        </header>
        <section id="passportSection" class="my-4" data-aos="fade-up">
          <div class="grid gap-5 xl:grid-cols-[minmax(0,1.2fr)_minmax(0,0.9fr)]">
            <div class="space-y-5">
              <article class="rounded-3xl border border-white/10 bg-white/5 p-6 lg:p-8 backdrop-blur-lg shadow-2xl">
                <div class="flex flex-col gap-6">
                  <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
                    <div>
                      <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-4 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.35em] text-white/70">
                        <i data-feather="coffee" class="h-4 w-4"></i>
                        Experiencias foodie
                      </span>
                      <h3 class="mt-4 text-2xl font-semibold text-white sm:text-[1.7rem]">Pasaporte gastronómico escarlata</h3>
                      <p class="mt-2 text-sm text-white/70">Registra tus consumos dentro y fuera del Pascual Guerrero para sumar sellos, puntos y beneficios exclusivos.</p>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-black/40 p-4 text-right text-white w-full max-w-[220px]">
                      <p class="text-xs uppercase tracking-[0.3em] text-white/60">Sellos activos</p>
                      <p id="passportStampCount" class="mt-2 text-4xl font-extrabold">0</p>
                      <p id="passportNextReward" class="mt-2 text-xs text-white/50"></p>
                    </div>
                  </div>
                  <div>
                    <div class="h-2 w-full overflow-hidden rounded-full bg-white/10">
                      <div id="passportProgressBar" class="h-full w-0 rounded-full bg-gradient-to-r from-amber-300 via-red-500 to-red-600 transition-all duration-500 ease-out"></div>
                    </div>
                    <p id="passportProgressLabel" class="mt-2 text-xs text-white/60">Empieza a sellar tus visitas gastronómicas.</p>
                  </div>
                  <div class="grid gap-3 sm:grid-cols-3">
                    <div class="rounded-2xl border border-white/10 bg-black/40 p-4 text-white/80">
                      <p class="text-xs uppercase tracking-[0.28em] text-white/60">Puntos acumulados</p>
                      <p id="passportPoints" class="mt-2 text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-black/40 p-4 text-white/80">
                      <p class="text-xs uppercase tracking-[0.28em] text-white/60">Experiencias fuera</p>
                      <p id="passportOutsideCount" class="mt-2 text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="rounded-2xl border border-white/10 bg-black/40 p-4 text-white/80">
                      <p class="text-xs uppercase tracking-[0.28em] text-white/60">Consumo registrado</p>
                      <p id="passportSpend" class="mt-2 text-2xl font-bold text-white">$0</p>
                    </div>
                  </div>
                  <div class="flex flex-wrap gap-3">
                    <button id="openPassportModal" type="button" class="flex items-center gap-2 rounded-2xl bg-gradient-to-r from-red-500 to-red-600 px-5 py-3 text-sm font-semibold text-white shadow-lg transition hover:shadow-red-500/40">
                      <i data-feather="plus-circle" class="h-4 w-4"></i>
                      Sellar nueva compra
                    </button>
                    <button id="passportResetBtn" type="button" class="flex items-center gap-2 rounded-2xl border border-white/20 bg-white/5 px-5 py-3 text-sm font-semibold text-white/80 transition hover:border-white/40 hover:text-white">
                      <i data-feather="refresh-ccw" class="h-4 w-4"></i>
                      Reiniciar pasaporte
                    </button>
                  </div>
                </div>
              </article>
              <article class="rounded-3xl border border-white/10 bg-white/5 p-6 lg:p-8 backdrop-blur-lg shadow-xl">
                <div class="flex items-center justify-between gap-4">
                  <h3 class="text-lg font-semibold text-white">Últimas experiencias selladas</h3>
                  <span class="rounded-full border border-white/15 bg-white/5 px-3 py-1 text-[0.7rem] uppercase tracking-[0.3em] text-white/60" id="passportHistoryBadge">0 sellos</span>
                </div>
                <ul id="passportHistoryList" class="mt-4 divide-y divide-white/5"></ul>
              </article>
            </div>
            <aside class="rounded-3xl border border-white/10 bg-white/5 p-6 lg:p-8 backdrop-blur-lg shadow-xl space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                  <i data-feather="award" class="h-5 w-5 text-amber-300"></i>
                  Próximos beneficios
                </h3>
                <p class="mt-2 text-sm text-white/60">Cada sello te acerca a experiencias gourmet exclusivas.</p>
                <ul id="passportBenefitsList" class="mt-4 space-y-3"></ul>
              </div>
              <div class="border-t border-white/10 pt-6">
                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                  <i data-feather="map" class="h-5 w-5 text-sky-300"></i>
                  Rutas recomendadas
                </h3>
                <p class="mt-2 text-sm text-white/60">Alterna entre puntos dentro del estadio y aliados de la ciudad para duplicar recompensas.</p>
                <ul id="passportExplorerList" class="mt-4 space-y-3"></ul>
              </div>
            </aside>
          </div>
        </section>

        <div id="secComunidad" class="dash-anchor"></div>
        <header class="dash-section-header mt-8">
          <h2 class="dash-section-title"><i data-feather="users" class="w-4 h-4 text-america-red"></i> Retos y Comunidad</h2>
          <span class="dash-section-sub">Reto diario y compartir</span>
        </header>
        <section id="engagementSection" class="dash-grid dash-grid--two my-4" data-aos="fade-up">
          <!-- Reto diario -->
          <div class="dash-card bg-gray-900 rounded-xl p-5 border border-gray-800">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-gray-400 font-medium">Reto diario</h2>
              <span id="dailyChallengeStatus" class="text-xs px-2 py-1 rounded bg-gray-800 text-gray-300">Pendiente</span>
            </div>
            <p class="text-sm text-gray-300">Trivias rápidas para sumar puntos.</p>
            <button id="openDailyChallengeBtn" class="mt-3 text-sm bg-america-red hover:bg-red-700 py-2 px-3 rounded-lg flex items-center gap-2"><i data-feather="zap" class="w-4 h-4"></i>Jugar ahora</button>
          </div>
          <!-- Comparte y gana -->
          <div class="dash-card bg-gray-900 rounded-xl p-5 border border-gray-800">
            <div class="flex items-center justify-between mb-2">
              <h2 class="text-gray-400 font-medium">Comparte y gana</h2>
              <span class="text-xs px-2 py-1 rounded bg-gray-800 text-gray-300">#AmericaDeCali</span>
            </div>
            <p class="text-sm text-gray-300">Gana puntos extra por compartir con el hashtag oficial.</p>
            <button id="shareAndEarnBtn" class="mt-3 text-sm bg-gray-800 hover:bg-gray-700 py-2 px-3 rounded-lg flex items-center gap-2"><i data-feather="share-2" class="w-4 h-4"></i>Compartir ahora</button>
          </div>
        </section>

        <div id="secEventos" class="dash-anchor"></div>

        <script id="eventsData" type="application/json">
{
  "events": [
    {"title":"Deportivo Pasto vs. América de Cali","start":"2025-09-24T20:00:00-05:00","end":"2025-09-24T22:00:00-05:00","location":"Estadio Departamental Libertad, Pasto","description":"Categoría Primera A · Clausura · Jornada 3 de 19"},
    {"title":"América de Cali vs. Envigado","start":"2025-09-28T14:00:00-05:00","end":"2025-09-28T16:00:00-05:00","location":"Estadio Olímpico Pascual Guerrero, Cali","description":"Categoría Primera A · Clausura · Jornada 13 de 19"},
    {"title":"Junior vs. América de Cali","start":"2025-10-02T20:00:00-05:00","end":"2025-10-02T22:00:00-05:00","location":"Estadio Metropolitano Roberto Meléndez, Barranquilla","description":"Copa Colombia · Cuartos de final · Partido 1 de 2"},
    {"title":"Millonarios vs. América de Cali","start":"2025-10-07T19:30:00-05:00","end":"2025-10-07T21:30:00-05:00","location":"Estadio Nemesio Camacho El Campín, Bogotá","description":"Categoría Primera A · Clausura · Jornada 14 de 19"},
    {"title":"América de Cali vs. La Equidad","start":"2025-10-11T19:30:00-05:00","end":"2025-10-11T21:30:00-05:00","location":"Estadio Olímpico Pascual Guerrero, Cali","description":"Categoría Primera A · Clausura · Jornada 15 de 19"},
    {"title":"América de Cali vs. Junior","start":"2025-10-15T20:20:00-05:00","end":"2025-10-15T22:20:00-05:00","location":"Estadio Olímpico Pascual Guerrero, Cali","description":"Copa Colombia · Cuartos de final · Partido 2 de 2"},
    {"title":"Deportivo Cali vs. América de Cali","start":"2025-10-19T18:20:00-05:00","end":"2025-10-19T20:20:00-05:00","location":"Estadio Deportivo Cali, Palmira","description":"Categoría Primera A · Clausura · Jornada 16 de 19"},
    {"title":"América de Cali vs. Junior (Pospuesto)","startText":"Pospuesto · Hora: PD","location":"Estadio Olímpico Pascual Guerrero, Cali","description":"Categoría Primera A · Clausura · Jornada 17 de 19 · Pospuesto (hora por definir)"},
    {"title":"Boyacá Chicó vs. América de Cali","start":"2025-10-28T20:20:00-05:00","end":"2025-10-28T22:20:00-05:00","location":"Estadio La Independencia, Tunja","description":"Categoría Primera A · Clausura · Jornada 18 de 19"},
    {"title":"América de Cali vs. Unión Magdalena","start":"2025-11-03T18:20:00-05:00","end":"2025-11-03T20:20:00-05:00","location":"Estadio Olímpico Pascual Guerrero, Cali","description":"Categoría Primera A · Clausura · Jornada 19 de 19"}
  ]
}
        </script>

        <section class="my-8" data-aos="fade-up">
          <div class="dash-section-header mb-4">
            <h2 class="dash-section-title"><i data-feather="target" class="w-4 h-4 text-america-red"></i> Recomendaciones para ti</h2>
            <button class="text-sm text-gray-400 hover:text-white">Ver más</button>
          </div>
          <div class="dash-grid dash-grid--two">
            <div class="dash-card bg-gray-900 rounded-xl p-5">
              <div class="flex justify-between gap-4">
                <div>
                  <h3 class="font-medium mb-1 text-white">Combo Familiar Entretiempo</h3>
                  <p class="text-sm text-gray-400">-15% de descuento</p>
                </div>
                <button id="redeemComboBtn" class="self-start bg-america-red hover:bg-red-700 text-white py-1 px-3 rounded-lg text-sm">Canjear</button>
              </div>
            </div>
            <div class="dash-card bg-gray-900 rounded-xl p-5">
              <div class="flex justify-between gap-4">
                <div>
                  <h3 class="font-medium mb-1 text-white">Trivia Histórica</h3>
                  <p class="text-sm text-gray-400">+50 pts por participar</p>
                </div>
                <button id="playTriviaBtn" class="self-start bg-america-red hover:bg-red-700 text-white py-1 px-3 rounded-lg text-sm" type="button">Jugar</button>
              </div>
            </div>
          </div>
        </section>

        <section class="my-8" data-aos="fade-up">
          <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Promociones activas</h2><button class="text-sm text-gray-400 hover:text-white">Ver todas</button></div>
          <div class="flex flex-wrap gap-3">
            <div class="promo-chip bg-gray-900 rounded-full px-4 py-2 flex items-center gap-2"><span class="font-medium">Crispetas Rojas 2x1</span><span class="text-xs bg-america-red px-2 py-1 rounded-full">24h</span></div>
            <div class="promo-chip bg-gray-900 rounded-full px-4 py-2 flex items-center gap-2"><span class="font-medium">Descuento Tienda</span><span class="text-xs bg-america-red px-2 py-1 rounded-full">3d</span></div>
          </div>
        </section>

        <!-- Próximos eventos (dinámico) -->
        <section id="eventsSection" class="my-8" data-aos="fade-up" data-ics="" data-json="america-events.json">
          <div class="flex justify-between items-center mb-2">
            <h2 class="dash-section-title"><i data-feather="calendar" class="w-4 h-4 text-america-red"></i> Próximos eventos</h2>
            <button id="openCalendarBtn" class="text-sm text-gray-400 hover:text-white">Ver calendario</button>
          </div>
          <div id="eventsContainer" class="space-y-3">
            <!-- Skeleton loader -->
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 animate-pulse">
              <div class="flex justify-between items-start">
                <div class="w-40 h-4 bg-gray-800 rounded"></div>
                <div class="w-20 h-4 bg-gray-800 rounded"></div>
              </div>
              <div class="mt-3 w-56 h-3 bg-gray-800 rounded"></div>
            </div>
            <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 animate-pulse">
              <div class="flex justify-between items-start">
                <div class="w-40 h-4 bg-gray-800 rounded"></div>
                <div class="w-20 h-4 bg-gray-800 rounded"></div>
              </div>
              <div class="mt-3 w-56 h-3 bg-gray-800 rounded"></div>
            </div>
          </div>
        </section>

        

        <!-- Sección Comunidad (engagementSection) -->
        <section id="engagementSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4" data-aos="fade-up">
          <!-- ...existing code... -->
          <!-- Agrega tarjeta de Reto Familiar -->
          <div class="bg-gray-900 rounded-xl p-5 border border-gray-800 flex flex-col justify-between">
            <div>
              <h3 class="font-semibold mb-1 flex items-center gap-2">
                <i data-feather="users" class="w-5 h-5 text-america-red"></i>
                Reto Familiar
              </h3>
              <p class="text-sm text-gray-300 mb-2">Compite con tu familia: ¿quién responde más rápido?</p>
            </div>
            <button id="startFamilyChallengeBtn" class="mt-3 bg-america-red hover:bg-red-700 text-white py-2 px-3 rounded-lg font-bold flex items-center gap-2 justify-center">
              <i data-feather="zap"></i>
              Iniciar reto
            </button>
          </div>
          <!-- ...existing code... -->
        </section>
        <!-- Modal Reto Familiar -->
        <div id="familyChallengeModal" class="fixed inset-0 z-[86] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
          <div class="w-full max-w-md bg-america-dark/95 text-white rounded-2xl shadow-2xl border border-gray-800 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Reto Familiar</h3>
              <button id="closeFamilyChallenge" class="p-2 rounded-lg hover:bg-gray-800" aria-label="Cerrar"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
            <div id="familyChallengeContent">
              <div id="familyChallengeIntro" class="space-y-3">
                <p class="text-gray-300 text-sm">¿Quién responde más rápido? Elige a los participantes y comienza.</p>
                <div class="flex gap-2">
                  <select id="familyChallengerA" class="fancy-select flex-1"></select>
                  <span class="text-gray-400 font-bold flex items-center">vs</span>
                  <select id="familyChallengerB" class="fancy-select flex-1"></select>
                </div>
                <button id="beginFamilyChallenge" class="w-full bg-america-red hover:bg-red-700 text-white font-semibold py-3 rounded-xl mt-3">Comenzar</button>
              </div>
              <div id="familyChallengeGame" class="hidden">
                <div class="mb-4 text-center">
                  <div class="text-sm text-gray-400 mb-1">Pregunta</div>
                  <div id="familyChallengeQuestion" class="font-bold text-lg"></div>
                </div>
                <div class="flex gap-3 justify-center mb-4">
                  <button id="familyBtnA" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold text-lg"></button>
                  <button id="familyBtnB" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold text-lg"></button>
                </div>
                <div id="familyChallengeResult" class="text-center text-base font-semibold mt-2"></div>
                <button id="nextFamilyChallenge" class="w-full bg-america-red hover:bg-red-700 text-white font-semibold py-2 rounded-xl mt-4 hidden">Siguiente pregunta</button>
              </div>
              <div id="familyChallengeSummary" class="hidden text-center">
                <h4 class="text-xl font-extrabold mb-2">¡Reto terminado!</h4>
                <div id="familyChallengeScores" class="mb-3"></div>
                <button id="closeFamilyChallengeSummary" class="bg-america-red hover:bg-red-700 text-white py-2 px-4 rounded-lg">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal Pasaporte Gastronómico -->
        <div id="passportModal" class="fixed inset-0 z-[87] hidden items-center justify-center bg-black/65 backdrop-blur-sm p-4">
          <div class="w-full max-w-lg rounded-2xl border border-white/10 bg-america-dark/95 text-white shadow-2xl">
            <div class="flex items-center justify-between border-b border-white/10 px-6 py-4">
              <div>
                <h3 class="text-lg font-semibold">Sellar compra gastronómica</h3>
                <p class="text-xs text-white/60">Registra el punto visitado para sumar sellos y puntos.</p>
              </div>
              <button id="closePassportModal" class="rounded-lg p-2 hover:bg-white/5" type="button" aria-label="Cerrar">
                <i data-feather="x" class="h-5 w-5"></i>
              </button>
            </div>
            <form id="passportForm" class="space-y-4 px-6 py-5">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-white/60">Ubicación</p>
                <div class="mt-2 grid gap-2 sm:grid-cols-2" id="passportAreaGroup">
                  <label class="passport-area-option flex items-center gap-3 rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm cursor-pointer hover:border-white/30">
                    <input type="radio" name="passportArea" value="inside" class="hidden" checked>
                    <span class="flex h-9 w-9 items-center justify-center rounded-lg bg-red-500/20 text-red-300"><i data-feather="home" class="h-4 w-4"></i></span>
                    <span class="font-medium text-white">Dentro del estadio</span>
                  </label>
                  <label class="passport-area-option flex items-center gap-3 rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm cursor-pointer hover:border-white/30">
                    <input type="radio" name="passportArea" value="outside" class="hidden">
                    <span class="flex h-9 w-9 items-center justify-center rounded-lg bg-sky-500/20 text-sky-200"><i data-feather="navigation" class="h-4 w-4"></i></span>
                    <span class="font-medium text-white">Fuera del estadio</span>
                  </label>
                </div>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="passportExperience" class="text-xs uppercase tracking-[0.3em] text-white/60">Experiencia</label>
                  <select id="passportExperience" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm focus:border-america-red focus:outline-none focus:ring-2 focus:ring-red-500/40">
                    <option value="gastrobar">Gastrobar Occidental</option>
                    <option value="palcos">Palcos gourmet</option>
                    <option value="foodtrucks">Food trucks La 14</option>
                    <option value="cafefans">Café de los hinchas</option>
                    <option value="aliado">Aliado urbano oficial</option>
                  </select>
                </div>
                <div>
                  <label for="passportAmount" class="text-xs uppercase tracking-[0.3em] text-white/60">Valor de la compra</label>
                  <div class="mt-2 flex items-center rounded-xl border border-white/10 bg-white/5 px-3 focus-within:border-america-red focus-within:ring-2 focus-within:ring-red-500/30">
                    <span class="text-sm text-white/50">$</span>
                    <input id="passportAmount" type="number" min="0" step="1000" placeholder="35.000" class="w-full bg-transparent px-2 py-3 text-sm text-white placeholder:text-white/40 focus:outline-none" required>
                  </div>
                </div>
              </div>
              <div>
                <label for="passportSpot" class="text-xs uppercase tracking-[0.3em] text-white/60">Nombre del punto</label>
                <input id="passportSpot" type="text" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder:text-white/40 focus:border-america-red focus:outline-none focus:ring-2 focus:ring-red-500/30" placeholder="Ej. Puesto 12 · Choripán Rojo" required>
              </div>
              <div>
                <label for="passportNotes" class="text-xs uppercase tracking-[0.3em] text-white/60">Detalle opcional</label>
                <textarea id="passportNotes" class="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white placeholder:text-white/40 focus:border-america-red focus:outline-none focus:ring-2 focus:ring-red-500/30" rows="2" placeholder="Cuenta qué probaste o con quién lo compartiste (opcional)"></textarea>
              </div>
              <div id="passportPointsPreview" class="flex items-center gap-3 rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white/70">
                <i data-feather="trending-up" class="h-4 w-4 text-amber-300"></i>
                <span>Completa la información para conocer los puntos que sumarás.</span>
              </div>
              <div class="flex flex-col gap-2 pt-2 sm:flex-row sm:justify-end sm:gap-3">
                <button type="button" id="passportCancelBtn" class="w-full rounded-xl border border-white/20 bg-transparent px-4 py-3 text-sm font-semibold text-white/70 transition hover:border-white/40 hover:text-white sm:w-auto">Cancelar</button>
                <button type="submit" class="w-full rounded-xl bg-gradient-to-r from-red-500 to-red-600 px-5 py-3 text-sm font-semibold text-white shadow-lg transition hover:shadow-red-500/40 sm:w-auto">Sellar compra</button>
              </div>
            </form>
          </div>
        </div>
        <div id="secActividad" class="dash-anchor"></div>
        <section class="my-8" data-aos="fade-up">
          <h2 class="dash-section-title mb-2"><i data-feather="clock" class="w-4 h-4 text-america-red"></i> Actividad reciente</h2>
          <div id="activityList" class="space-y-4">
            <!-- Se renderiza dinámicamente -->
          </div>
        </section>
      </main>

      <script id="passport-script">
      (function(){
        const STORAGE_KEY = 'gastronomyPassport';
        const REWARDS = [
          { stamps: 3, reward: 'Bebida de cortesía en tu tribuna' },
          { stamps: 6, reward: 'Fila express en la zona gourmet' },
          { stamps: 9, reward: 'Degustación con chefs invitados' },
          { stamps: 12, reward: 'Experiencia VIP Roja Gourmet' }
        ];
        const ROUTES = [
          { id: 'gastrobar', title: 'Gastrobar Occidental', area: 'inside', icon: 'coffee', description: 'Mixología y tapas previas al saque inicial.', bonus: '+10 pts si sellas antes del minuto 30.' },
          { id: 'foodtrucks', title: 'Food trucks La 14', area: 'outside', icon: 'truck', description: 'Aliados urbanos con combos rojos en la previa.', bonus: '+15 pts por compras mayores a $40.000.' },
          { id: 'palcos', title: 'Palcos gourmet', area: 'inside', icon: 'star', description: 'Menú de autor con chefs invitados en occidental.', bonus: 'Duplica sellos en partidos internacionales.' },
          { id: 'aliado', title: 'Aliado urbano oficial', area: 'outside', icon: 'map-pin', description: 'Restaurantes aliados en la ciudad para la post fiesta.', bonus: '+20 pts por reservar con tu manilla NFC.' }
        ];
        const EXPERIENCE_LABELS = {
          gastrobar: 'Gastrobar Occidental',
          palcos: 'Palcos gourmet',
          foodtrucks: 'Food trucks La 14',
          cafefans: 'Café de los hinchas',
          aliado: 'Aliado urbano oficial'
        };

        let state = { stamps: 0, history: [] };
        let els = {};

        function loadState(){
          try {
            const raw = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
            if (!raw || typeof raw !== 'object') return { stamps: 0, history: [] };
            const history = Array.isArray(raw.history) ? raw.history.filter(Boolean).map(normalizeEntry) : [];
            const storedStamps = Number(raw.stamps);
            const stamps = Number.isFinite(storedStamps) && storedStamps >= history.length ? storedStamps : history.length;
            return { stamps, history };
          } catch(_){
            return { stamps: 0, history: [] };
          }
        }

        function normalizeEntry(entry){
          return {
            id: String(entry.id || `stamp-${Date.now()}`),
            area: entry.area === 'outside' ? 'outside' : 'inside',
            experience: EXPERIENCE_LABELS[entry.experience] ? entry.experience : 'gastrobar',
            spot: String(entry.spot || ''),
            notes: String(entry.notes || ''),
            amount: Number(entry.amount) || 0,
            points: Number(entry.points) || 0,
            createdAt: entry.createdAt || new Date().toISOString()
          };
        }

        function saveState(){
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch(_){ }
        }

        function computePoints({ area, amount, experience }){
          const base = 40;
          let bonus = 0;
          if (area === 'outside') bonus += 20;
          if (amount >= 80000) bonus += 30;
          else if (amount >= 50000) bonus += 20;
          else if (amount >= 25000) bonus += 10;
          const experienceBonus = { gastrobar: 10, palcos: 25, foodtrucks: 15, cafefans: 8, aliado: 18 };
          bonus += experienceBonus[experience] || 0;
          return base + bonus;
        }

        function formatCurrency(value){
          try {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(Math.max(0, Math.round(value || 0)));
          } catch(_){
            return `$${Math.max(0, Math.round(value || 0)).toLocaleString('es-CO')}`;
          }
        }

        function formatDateTime(iso){
          const date = iso ? new Date(iso) : new Date();
          if (Number.isNaN(date.getTime())) return '';
          const d = date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
          const t = date.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
          return `${d.replace('.', '')} · ${t}`;
        }

        function pluralize(value, singular, plural){
          return value === 1 ? singular : plural;
        }

        function escapeHtml(str){
          return String(str || '').replace(/[&<>"']/g, ch => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[ch] || ch));
        }

        function getSelectedArea(){
          const radio = (els.areaRadios || []).find(r => r.checked);
          return radio ? radio.value : 'inside';
        }

        function updateAreaStyles(){
          (els.areaOptions || []).forEach(option => {
            const input = option.querySelector('input[name="passportArea"]');
            const checked = !!input?.checked;
            option.classList.toggle('ring-2', checked);
            option.classList.toggle('ring-red-500/60', checked && input?.value === 'inside');
            option.classList.toggle('ring-sky-400/60', checked && input?.value === 'outside');
            option.classList.toggle('border-white/30', checked);
            option.classList.toggle('border-white/10', !checked);
          });
        }

        function updatePreview(){
          if (!els.preview) return;
          const area = getSelectedArea();
          const amount = Number(els.amountInput?.value || 0);
          const experience = els.experienceSelect?.value || 'gastrobar';
          const spot = (els.spotInput?.value || '').trim();
          if (!spot && amount <= 0){
            els.preview.innerHTML = '<i data-feather="trending-up" class="h-4 w-4 text-amber-300"></i><span>Completa la información para conocer los puntos que sumarás.</span>';
            feather?.replace?.();
            return;
          }
          const points = computePoints({ area, amount, experience });
          const extras = [];
          if (area === 'outside') extras.push('aliado urbano');
          if (amount >= 50000) extras.push('consumo destacado');
          if (experience === 'palcos') extras.push('experiencia premium');
          const bonusText = extras.length ? ` (bono: ${extras.join(' + ')})` : '';
          const spend = amount > 0 ? ` por ${formatCurrency(amount)}` : '';
          els.preview.innerHTML = `<i data-feather="trending-up" class="h-4 w-4 text-amber-300"></i><span>Sello estimado: <strong class="text-white">+${points.toLocaleString('es-CO')} pts</strong>${spend}${bonusText}.</span>`;
          feather?.replace?.();
        }

        function render(){
          if (!els.section) return;
          const history = Array.isArray(state.history) ? state.history : [];
          const stamps = Math.max(Number(state.stamps) || 0, history.length);
          const maxTier = REWARDS[REWARDS.length - 1]?.stamps || 1;
          const progress = Math.min(100, Math.round((Math.min(stamps, maxTier) / maxTier) * 100));
          const totalPoints = history.reduce((acc, item) => acc + (Number(item.points) || 0), 0);
          const outsideCount = history.filter(item => item.area === 'outside').length;
          const totalSpend = history.reduce((acc, item) => acc + (Number(item.amount) || 0), 0);
          if (els.stampCount) els.stampCount.textContent = stamps.toLocaleString('es-CO');
          if (els.points) els.points.textContent = totalPoints.toLocaleString('es-CO');
          if (els.outsideCount) els.outsideCount.textContent = outsideCount.toLocaleString('es-CO');
          if (els.spend) els.spend.textContent = formatCurrency(totalSpend);
          if (els.historyBadge) els.historyBadge.textContent = `${stamps} ${pluralize(stamps, 'sello', 'sellos')}`;
          if (els.progressBar) els.progressBar.style.width = `${progress}%`;
          if (els.progressLabel) els.progressLabel.textContent = `Sellos completados: ${Math.min(stamps, maxTier)} de ${maxTier}.`;
          if (els.nextReward){
            const upcoming = REWARDS.find(tier => stamps < tier.stamps);
            els.nextReward.textContent = upcoming ? `Te faltan ${upcoming.stamps - stamps} ${pluralize(upcoming.stamps - stamps, 'sello', 'sellos')} para ${upcoming.reward}.` : '¡Pasaporte completo! Disfruta todos los beneficios.';
          }
          renderBenefits(stamps);
          renderExplorer(history);
          renderHistory(history);
          feather?.replace?.();
        }

        function renderBenefits(stamps){
          if (!els.benefitsList) return;
          els.benefitsList.innerHTML = REWARDS.map(tier => {
            const achieved = stamps >= tier.stamps;
            const icon = achieved ? 'check-circle' : 'flag';
            return `<li class="flex items-center gap-3 rounded-2xl border px-4 py-3 ${achieved ? 'border-emerald-400/40 bg-emerald-500/10' : 'border-white/10 bg-white/5'}">
              <span class="flex h-10 w-10 items-center justify-center rounded-xl ${achieved ? 'bg-emerald-500/20 text-emerald-300' : 'bg-black/40 text-white/70'}"><i data-feather="${icon}" class="h-5 w-5"></i></span>
              <div class="min-w-0">
                <p class="text-sm font-semibold text-white">${escapeHtml(tier.reward)}</p>
                <p class="text-xs text-white/60">Con ${tier.stamps} ${pluralize(tier.stamps, 'sello', 'sellos')}</p>
              </div>
            </li>`;
          }).join('');
        }

        function renderExplorer(history){
          if (!els.explorerList) return;
          const visited = new Set(history.map(item => item.experience));
          els.explorerList.innerHTML = ROUTES.map(route => {
            const complete = visited.has(route.id);
            const icon = complete ? 'check' : route.icon;
            const chipClass = route.area === 'outside' ? 'bg-sky-500/20 text-sky-100' : 'bg-red-500/20 text-red-100';
            return `<li class="rounded-2xl border px-4 py-3 ${complete ? 'border-sky-400/40 bg-sky-500/10' : 'border-white/10 bg-white/5'}">
              <div class="flex items-start gap-3">
                <span class="flex h-10 w-10 items-center justify-center rounded-xl ${complete ? 'bg-sky-500/20 text-sky-100' : 'bg-black/40 text-white/70'}"><i data-feather="${icon}" class="h-5 w-5"></i></span>
                <div class="min-w-0 space-y-1">
                  <div class="flex flex-wrap items-center gap-2">
                    <p class="text-sm font-semibold text-white">${escapeHtml(route.title)}</p>
                    <span class="rounded-full px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-[0.25em] ${chipClass}">${route.area === 'outside' ? 'Fuera' : 'Dentro'}</span>
                  </div>
                  <p class="text-xs text-white/60">${escapeHtml(route.description)}</p>
                  <p class="text-xs font-semibold text-amber-200">${escapeHtml(route.bonus)}</p>
                </div>
              </div>
            </li>`;
          }).join('');
        }

        function renderHistory(history){
          if (!els.historyList) return;
          if (!history.length){
            els.historyList.innerHTML = '<li class="py-6 text-center text-sm text-white/60">Aún no registras experiencias gastronómicas. ¡Sella tu primera compra y desbloquea recompensas!</li>';
            return;
          }
          const recent = history.slice(0, 5);
          els.historyList.innerHTML = recent.map(entry => {
            const icon = entry.area === 'outside' ? 'navigation' : 'coffee';
            const notes = entry.notes ? `<p class="text-xs text-white/50 mt-1">${escapeHtml(entry.notes)}</p>` : '';
            return `<li class="flex items-start justify-between gap-3 py-3 first:pt-0 last:pb-0">
              <div class="flex items-start gap-3">
                <span class="flex h-10 w-10 items-center justify-center rounded-xl ${entry.area === 'outside' ? 'bg-sky-500/15 text-sky-200' : 'bg-red-500/15 text-red-200'}"><i data-feather="${icon}" class="h-5 w-5"></i></span>
                <div class="min-w-0">
                  <p class="text-sm font-semibold text-white">${escapeHtml(entry.spot || 'Punto gastronómico')}</p>
                  <p class="text-xs text-white/60">${escapeHtml(EXPERIENCE_LABELS[entry.experience] || 'Experiencia gastronómica')} • ${entry.area === 'outside' ? 'Fuera del estadio' : 'Dentro del estadio'}</p>
                  ${notes}
                </div>
              </div>
              <div class="text-right text-xs text-white/60 min-w-[120px]">
                <p class="text-sm font-semibold text-emerald-300">+${(Number(entry.points) || 0).toLocaleString('es-CO')} pts</p>
                <p>${formatCurrency(entry.amount)}</p>
                <p>${formatDateTime(entry.createdAt)}</p>
              </div>
            </li>`;
          }).join('');
        }

        function resetForm(){
          if (!els.form) return;
          els.form.reset();
          updateAreaStyles();
          updatePreview();
        }

        function openModal(){
          if (!els.modal) return;
          resetForm();
          els.modal.classList.remove('hidden');
          els.modal.classList.add('flex');
          window.trapFocus?.(els.modal);
          feather?.replace?.();
          setTimeout(()=>{ els.spotInput?.focus({ preventScroll: true }); }, 120);
        }

        function closeModal(){
          if (!els.modal) return;
          els.modal.classList.add('hidden');
          els.modal.classList.remove('flex');
          window.releaseFocus?.();
        }

        function handleSubmit(ev){
          ev.preventDefault();
          const area = getSelectedArea();
          const experience = els.experienceSelect?.value || 'gastrobar';
          const spot = (els.spotInput?.value || '').trim();
          const notes = (els.notesInput?.value || '').trim();
          const amount = Math.max(0, Number(els.amountInput?.value || 0));
          if (!spot){
            els.spotInput?.focus();
            return;
          }
          const points = computePoints({ area, amount, experience });
          const entry = {
            id: `stamp-${Date.now()}`,
            area,
            experience,
            spot,
            notes,
            amount,
            points,
            createdAt: new Date().toISOString()
          };
          const previous = Number(state.stamps) || 0;
          state.history = [entry].concat(Array.isArray(state.history) ? state.history : []).slice(0, 40);
          state.stamps = previous + 1;
          saveState();
          render();
          closeModal();
        }

        function handleReset(){
          if (!state.history.length) return;
          const confirmReset = window.confirm('¿Quieres reiniciar tu pasaporte gastronómico? Se borrarán tus sellos registrados.');
          if (!confirmReset) return;
          state = { stamps: 0, history: [] };
          saveState();
          render();
        }

        function init(){
          els = {
            section: document.getElementById('passportSection'),
            openBtn: document.getElementById('openPassportModal'),
            resetBtn: document.getElementById('passportResetBtn'),
            modal: document.getElementById('passportModal'),
            cancelBtn: document.getElementById('passportCancelBtn'),
            closeBtn: document.getElementById('closePassportModal'),
            form: document.getElementById('passportForm'),
            preview: document.getElementById('passportPointsPreview'),
            historyList: document.getElementById('passportHistoryList'),
            historyBadge: document.getElementById('passportHistoryBadge'),
            stampCount: document.getElementById('passportStampCount'),
            nextReward: document.getElementById('passportNextReward'),
            progressBar: document.getElementById('passportProgressBar'),
            progressLabel: document.getElementById('passportProgressLabel'),
            points: document.getElementById('passportPoints'),
            outsideCount: document.getElementById('passportOutsideCount'),
            spend: document.getElementById('passportSpend'),
            benefitsList: document.getElementById('passportBenefitsList'),
            explorerList: document.getElementById('passportExplorerList'),
            amountInput: document.getElementById('passportAmount'),
            spotInput: document.getElementById('passportSpot'),
            notesInput: document.getElementById('passportNotes'),
            experienceSelect: document.getElementById('passportExperience'),
            areaOptions: Array.from(document.querySelectorAll('#passportAreaGroup .passport-area-option')),
            areaRadios: Array.from(document.querySelectorAll('input[name="passportArea"]'))
          };
          if (!els.section) return;

          state = loadState();
          render();

          els.openBtn?.addEventListener('click', openModal);
          els.resetBtn?.addEventListener('click', handleReset);
          els.cancelBtn?.addEventListener('click', ()=>{ closeModal(); });
          els.closeBtn?.addEventListener('click', closeModal);
          els.modal?.addEventListener('click', (ev)=>{ if (ev.target === els.modal) closeModal(); });
          els.form?.addEventListener('submit', handleSubmit);
          ['input','change'].forEach(evt => {
            els.amountInput?.addEventListener(evt, updatePreview);
            els.experienceSelect?.addEventListener(evt, updatePreview);
            els.spotInput?.addEventListener(evt, updatePreview);
            els.notesInput?.addEventListener(evt, updatePreview);
          });
          (els.areaRadios || []).forEach(radio => radio.addEventListener('change', ()=>{ updateAreaStyles(); updatePreview(); }));
          updateAreaStyles();
          updatePreview();

          window.openPassportModal = openModal;
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init, { once: true });
        } else {
          init();
        }
      })();
      </script>

      <script id="family-challenge-script">
      (function(){
        // Preguntas reales del América de Cali
        const QUESTIONS = [
          { q: '¿En qué año se fundó América de Cali?', a: '1927' },
          { q: '¿Cuál es el apodo más famoso del América?', a: 'Los Diablos Rojos' },
          { q: '¿En qué estadio juega América de Cali como local?', a: 'Pascual Guerrero' },
          { q: '¿Cuántas estrellas (títulos de liga) tiene América de Cali hasta 2023?', a: '15' },
          { q: '¿Qué color es la camiseta tradicional del América?', a: 'Rojo' },
          { q: '¿Quién es el máximo goleador histórico del América?', a: 'Anthony de Ávila' },
          { q: '¿Qué rival es considerado el clásico regional del América?', a: 'Deportivo Cali' },
          { q: '¿En qué año América ganó su primera liga profesional?', a: '1979' },
          { q: '¿Qué animal aparece en el escudo del América?', a: 'Diablo' },
          { q: '¿Cómo se llama la hinchada más famosa del América?', a: 'Barón Rojo Sur' }
        ];

        // Elementos
        const openBtn = document.getElementById('startFamilyChallengeBtn');
        const modal = document.getElementById('familyChallengeModal');
        const closeBtn = document.getElementById('closeFamilyChallenge');
        const intro = document.getElementById('familyChallengeIntro');
        const game = document.getElementById('familyChallengeGame');
        const summary = document.getElementById('familyChallengeSummary');
        const challengerA = document.getElementById('familyChallengerA');
        const challengerB = document.getElementById('familyChallengerB');
        const beginBtn = document.getElementById('beginFamilyChallenge');
        const qEl = document.getElementById('familyChallengeQuestion');
        const btnA = document.getElementById('familyBtnA');
        const btnB = document.getElementById('familyBtnB');
        const resultEl = document.getElementById('familyChallengeResult');
        const nextBtn = document.getElementById('nextFamilyChallenge');
        const scoresEl = document.getElementById('familyChallengeScores');
        const closeSummaryBtn = document.getElementById('closeFamilyChallengeSummary');

        if (!openBtn || !modal) return;

        // Estado
        let participants = [];
        let idx = 0;
        let scores = [0, 0];
        let lock = false;
        let order = [];

        function loadFamily(){
          try { return JSON.parse(localStorage.getItem('familyData')||'{}'); } catch(_) { return {}; }
        }

        function open(){
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          intro.classList.remove('hidden');
          game.classList.add('hidden');
          summary.classList.add('hidden');
          // Cargar miembros de la familia
          const fam = loadFamily();
          const members = Array.isArray(fam.members) ? fam.members : [];
          challengerA.innerHTML = members.map(m=>`<option value="${m.id}">${m.name||'A'}</option>`).join('');
          challengerB.innerHTML = members.map(m=>`<option value="${m.id}">${m.name||'B'}</option>`).join('');
          window.trapFocus?.(modal);
          feather?.replace?.();
        }
        function close(){
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          window.releaseFocus?.();
        }

        function startGame(){
          const fam = loadFamily();
          const members = Array.isArray(fam.members) ? fam.members : [];
          const a = members.find(m=>String(m.id)===String(challengerA.value));
          const b = members.find(m=>String(m.id)===String(challengerB.value));
          if (!a || !b || a.id === b.id) { window.showToast?.('Selecciona dos miembros distintos', 'error'); return; }
          participants = [a, b];
          idx = 0;
          scores = [0, 0];
          order = [...Array(QUESTIONS.length).keys()];
          // Barajar preguntas
          for (let i=order.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [order[i],order[j]]=[order[j],order[i]]; }
          intro.classList.add('hidden');
          game.classList.remove('hidden');
          summary.classList.add('hidden');
          nextBtn.classList.add('hidden');
          renderQuestion();
        }

        function renderQuestion(){
          lock = false;
          resultEl.textContent = '';
          nextBtn.classList.add('hidden');
          if (idx >= QUESTIONS.length){
            showSummary();
            return;
          }
          const q = QUESTIONS[order[idx]];
          qEl.textContent = q.q;
          btnA.textContent = participants[0].name;
          btnB.textContent = participants[1].name;
          btnA.disabled = false;
          btnB.disabled = false;
        }

        function answer(winnerIdx){
          if (lock) return;
          lock = true;
          scores[winnerIdx]++;
          resultEl.textContent = `${participants[winnerIdx].name} respondió primero (+1)`;
          btnA.disabled = true;
          btnB.disabled = true;
          nextBtn.classList.remove('hidden');
          // Ranking especial familiar
          try {
            const fam = loadFamily();
            const m = fam.members.find(m=>String(m.id)===String(participants[winnerIdx].id));
            if (m) { m.familyChallengeWins = (m.familyChallengeWins||0)+1; localStorage.setItem('familyData', JSON.stringify(fam)); }
          } catch(_){}
        }

        function showSummary(){
          game.classList.add('hidden');
          summary.classList.remove('hidden');
          scoresEl.innerHTML = `
            <div class="mb-2">${participants[0].name}: <span class="font-bold">${scores[0]}</span></div>
            <div>${participants[1].name}: <span class="font-bold">${scores[1]}</span></div>
            <div class="mt-3 text-sm text-gray-400">Ranking familiar actualizado</div>
          `;
        }

        openBtn.addEventListener('click', open);
        closeBtn?.addEventListener('click', close);
        modal.addEventListener('click', (e)=>{ if (e.target === modal) close(); });
        beginBtn.addEventListener('click', startGame);
        btnA.addEventListener('click', ()=> answer(0));
        btnB.addEventListener('click', ()=> answer(1));
        nextBtn.addEventListener('click', ()=>{ idx++; renderQuestion(); });
        closeSummaryBtn?.addEventListener('click', close);
      })();
      </script>

      <script id="family-ranking-extend">
      (function(){
        // Extiende el ranking familiar para mostrar los ganadores de retos familiares
        document.addEventListener('DOMContentLoaded', ()=>{
          const rankingTab = document.getElementById('familyTab-ranking');
          if (!rankingTab) return;
          // Espera a que el ranking se renderice (hook simple)
          setTimeout(()=>{
            const fam = (()=>{ try{ return JSON.parse(localStorage.getItem('familyData')||'{}'); }catch(_){ return {}; }})();
            const members = Array.isArray(fam.members) ? fam.members : [];
            if (!members.length) return;
            // Ranking por retos familiares ganados
            const sorted = [...members].sort((a,b)=>(b.familyChallengeWins||0)-(a.familyChallengeWins||0));
            const block = document.createElement('div');
            block.className = 'mt-6';
            block.innerHTML = `<div class="font-bold mb-2">Ranking Reto Familiar</div>` +
              sorted.map((m,i)=>`<div class="flex items-center justify-between bg-gray-900 border border-gray-800 rounded-lg p-2 mb-1"><div class="flex items-center gap-2"><span class="text-xs text-gray-400 w-5">#${i+1}</span><span class="font-medium">${m.name}</span></div><div class="text-sm"><span class="font-semibold">${m.familyChallengeWins||0}</span> victorias</div></div>`).join('');
            rankingTab.appendChild(block);
          }, 400);
        });
      })();
      </script>
    </div>
  </div>
<script>
        feather.replace();
        
        let qrPurpose = 'login';
        
        // Function to extract NFC ID from NDEF records
        function extractNfcId(event) {
            const { message, serialNumber } = event;
            if (message && message.records.length > 0) {
                for (const record of message.records) {
                    try {
                        if (record.recordType === 'text') {
                            const text = new TextDecoder(record.encoding || 'utf-8').decode(record.data);
                            return text.trim();
                        } else if (record.recordType === 'url') {
                            const url = new TextDecoder('utf-8').decode(record.data);
                            // Extract ID from URL if present, e.g., myclub://nfc?id=123
                            const match = url.match(/[?&]id=([^&]+)/);
                            if (match) return match[1];
                        } else if (record.recordType === 'json') {
                            const json = JSON.parse(new TextDecoder('utf-8').decode(record.data));
                            return json.id || json.nfcId;
                        }
                    } catch (e) {
                        // Skip malformed records
                    }
                }
            }
            // Fallback to serial number
            return serialNumber || 'ID_DESCONOCIDO';
        }

        // NFC Login with improved implementation
        async function performNfcLogin() {
            const nfcButton = document.getElementById('nfcButton');

            // Show loading state
            nfcButton.innerHTML = '<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Leyendo manilla NFC...</span>';
            nfcButton.setAttribute('aria-busy', 'true');
            feather.replace();

            const controller = new AbortController();
            let reader;

            try {
                if (!('NDEFReader' in window)) {
                    throw new Error('NFC no soportado en este navegador');
                }

                reader = new NDEFReader();
                await reader.scan({ signal: controller.signal });

                const readingPromise = new Promise((resolve, reject) => {
                    reader.onreadingerror = (error) => {
                        reject(new Error('Error al leer la manilla NFC'));
                    };

                    reader.onreading = async (event) => {
                        try {
                            const idNFC = extractNfcId(event);

                            const response = await fetch('/api/auth/nfc-login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ idNFC })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Error en autenticación');
                            }

                            const data = await response.json();
                            sessionStorage.setItem('authToken', data.authToken);
                            sessionStorage.setItem('userId', data.userId);

                            showToast('¡Listo! Ingresando...', 'success');
                            setTimeout(showDashboard, 800);
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                });

                // Timeout after 30 seconds
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Tiempo agotado. Acerca la manilla y vuelve a intentar')), 30000);
                });

                await Promise.race([readingPromise, timeoutPromise]);

            } catch (error) {
                if (error.name === 'AbortError') return; // Cancelled
                showToast(error.message, 'error');
            } finally {
                // Cleanup
                controller.abort();
                if (reader) {
                    try {
                        reader.abort();
                    } catch (e) {}
                }
                nfcButton.innerHTML = '<i data-feather="radio" class="w-5 h-5"></i><span>Escanear manilla NFC</span>';
                nfcButton.removeAttribute('aria-busy');
                feather.replace();
            }
        }

        // NFC Verification
        async function startVerificationNfc() {
            const button = document.getElementById('verifyNfcBtn');

            button.innerHTML = '<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Leyendo NFC...</span>';
            button.setAttribute('aria-busy', 'true');
            feather.replace();

            const controller = new AbortController();
            let reader;

            try {
                if (!('NDEFReader' in window)) {
                    throw new Error('NFC no soportado en este navegador');
                }

                reader = new NDEFReader();
                await reader.scan({ signal: controller.signal });

                const readingPromise = new Promise((resolve, reject) => {
                    reader.onreadingerror = () => {
                        reject(new Error('Error al leer NFC'));
                    };

                    reader.onreading = (event) => {
                        // Any successful NFC read is verification success
                        showGlobalOverlay({
                            type: 'success',
                            message: 'NFC verificado',
                            duration: 2000,
                            onDone: verificationSuccess
                        });
                        resolve();
                    };
                });

                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Tiempo agotado')), 30000);
                });

                await Promise.race([readingPromise, timeoutPromise]);

            } catch (error) {
                if (error.name === 'AbortError') return;
                showToast(error.message, 'error');
            } finally {
                controller.abort();
                if (reader) {
                    try {
                        reader.abort();
                    } catch (e) {}
                }
                button.innerHTML = '<i class="w-5 h-5" data-feather="radio"></i><span>NFC</span>';
                button.removeAttribute('aria-busy');
                feather.replace();
            }
        }

        // Manual login toggle + enfoque input
        document.getElementById('manualButton').addEventListener('click', () => {
            document.getElementById('fallbackSection').classList.add('hidden');
            document.getElementById('manualInputSection').classList.remove('hidden');
            const input = document.getElementById('manualCode');
            if (input) setTimeout(() => input.focus(), 0);
        });

        // Validación reutilizable
        const isValidAccessCode = (val) => ['0721','0606','2505','9847'].includes(String(val||'').trim());

        function validateManualCode(){
          const code = document.getElementById('manualCode').value.trim();
          if (!code) { showToast('Por favor ingresa un código', 'error'); return; }
          if (isValidAccessCode(code)){
            showGlobalOverlay({ type:'success', message:'¡Código válido! Ingresando...', duration:2000, onDone: () => {
              try {
                sessionStorage.setItem('authToken','mockToken');
                sessionStorage.setItem('userId','mockUser');
              } catch(e) {}
              showDashboard();
            }});
          } else {
            showGlobalOverlay({ type:'error', message:'Código inválido. Intenta de nuevo', duration:2000 });
          }
        }
        // Click en botón validar
        document.getElementById('validateButton').addEventListener('click', validateManualCode);
        // Enter en el input para validar
        document.getElementById('manualCode').addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') { e.preventDefault(); validateManualCode(); }
        });

        // --- QR Scanner (real) ---
        let qrStream = null;
        let qrRafId = null;

        function openQrModal() {
          const modal = document.getElementById('qrModal');
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        }
        function closeQrModal() {
          const modal = document.getElementById('qrModal');
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          qrPurpose = 'login';
        }

        async function startQrScanner(){
          try {
            const video = document.getElementById('qrVideo');
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d');

            // Oculta el <video> para evitar el overlay de "play" hasta que la cámara esté lista
            video.classList.add('media-hidden');

            // Refuerza atributos para iOS y autoplay confiable
            video.setAttribute('playsinline', 'true');
            video.setAttribute('autoplay', 'true');
            video.muted = true;

            qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = qrStream;

            // Espera a tener metadata y comenzar reproducción
            await video.play().catch(()=>{});
            if (video.readyState < 2) {
              await new Promise(resolve => { video.onloadedmetadata = resolve; });
            }

            // Una vez lista la cámara, muestra el video
            video.classList.remove('media-hidden');

            const tick = () => {
              if (!video.videoWidth) { qrRafId = requestAnimationFrame(tick); return; }
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, canvas.width, canvas.height);
              if (code && code.data) {
                // Detener escáner al encontrar código
                stopQrScanner();

                const overlay = document.getElementById('qrResultOverlay');
                const iconEl = document.getElementById('qrResultIcon');
                const msgEl = document.getElementById('qrResultMessage');
                const ok = isValidAccessCode(code.data.trim());

                // Mostrar overlay con animación
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                toggleScreenLock(true);

                if (ok) {
                  if (qrPurpose === 'login') {
                    // Icono: chulo verde
                    iconEl.innerHTML = `
                      <svg class="w-20 h-20 text-green-500 pop-in" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>`;
                    msgEl.textContent = '¡QR válido! Ingresando...';

                    // simula token de sesión si lo deseas
                    sessionStorage.setItem('authToken', 'mockToken');
                    sessionStorage.setItem('userId', 'mockUser');

                    setTimeout(() => {
                      // Limpiar overlay y redirigir al dashboard
                      iconEl.innerHTML = '';
                      msgEl.textContent = '';
                      overlay.classList.add('hidden');
                      overlay.classList.remove('flex');
                      toggleScreenLock(false);
                      closeQrModal();
                      showDashboard();
                    }, 2000);
                  } else if (qrPurpose === 'topup') {
                    // Icono: chulo verde
                    iconEl.innerHTML = `
                      <svg class="w-20 h-20 text-green-500 pop-in" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>`;
                    msgEl.textContent = 'Verificación exitosa';

                    setTimeout(() => {
                      // Limpiar overlay y redirigir al dashboard
                      iconEl.innerHTML = '';
                      msgEl.textContent = '';
                      overlay.classList.add('hidden');
                      overlay.classList.remove('flex');
                      toggleScreenLock(false);
                      closeQrModal();
                      verificationSuccess();
                    }, 2000);
                  }
                } else {
                  // Icono: X roja y reintentar
                  iconEl.innerHTML = `
                    <svg class="w-20 h-20 text-america-red pop-in" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                      <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>`;
                  msgEl.textContent = 'Código inválido. Intenta de nuevo';

                  setTimeout(() => {
                    iconEl.innerHTML = '';
                    msgEl.textContent = '';
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    toggleScreenLock(false);
                    // Volver a la cámara
                    startQrScanner();
                  }, 2000);
                }
                return;
              }
              qrRafId = requestAnimationFrame(tick);
            };
            tick();
          } catch (err) {
            showToast('No se pudo acceder a la cámara', 'error');
            closeQrModal();
          }
        }

        function stopQrScanner(){
          if (qrRafId) { cancelAnimationFrame(qrRafId); qrRafId = null; }
          if (qrStream) { qrStream.getTracks().forEach(t => t.stop()); qrStream = null; }
        }

        // Abrir modal y comenzar a escanear
        document.getElementById('qrButton').addEventListener('click', () => {
          qrPurpose = 'login';
          openQrModal();
          startQrScanner();
        });

        // Cerrar modal

        document.getElementById('closeQrModal')?.addEventListener('click', () => {
          stopQrScanner();
          closeQrModal();
          const overlay = document.getElementById('qrResultOverlay');
          overlay?.classList.add('hidden');
          overlay?.classList.remove('flex');
          toggleScreenLock(false);
        });

        // ====== Recarga (TopUp) ======
        const topUp = {
          amount: 20000,
          method: 'card',
          fee: 0
        };

        const topUpModal = document.getElementById('topUpModal');
        const navTopUpBtn = document.getElementById('navTopUpBtn');
        const closeTopUpBtn = document.getElementById('closeTopUp');
        const customAmount = document.getElementById('customAmount');
        const amountChips = () => Array.from(document.querySelectorAll('.topup-amount'));
        const methodBtns = () => Array.from(document.querySelectorAll('.topup-method'));
        const payBtn = document.getElementById('topUpPayBtn');

        const amountLbl = document.getElementById('topUpAmountLabel');
        const feeLbl = document.getElementById('topUpFeeLabel');
        const totalLbl = document.getElementById('topUpTotalLabel');

        function formatThousands(n) {
          // Formats an integer as e.g. "20.000"
          if (isNaN(n) || n == null) return '';
          return n.toLocaleString('es-CO');
        }

        function parseToInt(str) {
          // Parses a string with dots as thousands separators to integer
          if (!str) return 0;
          // Remove all non-digit chars
          return parseInt(String(str).replace(/\D/g, ''), 10) || 0;
        }

        function setCustomAmountValue(val) {
          // Sets the customAmount input value formatted, triggers input event
          if (!customAmount) return;
          customAmount.value = formatThousands(val);
          // Manually trigger input event to update state and summary
          const event = new Event('input', { bubbles: true });
          customAmount.dispatchEvent(event);
        }

        function formatCOP(n){
          // Use formatThousands for consistency
          return `$${formatThousands(Math.round(n))}`;
        }

        function openTopUp(){
          if (!topUpModal) return;
          topUpModal.classList.remove('hidden');
          topUpModal.classList.add('flex');
          feather.replace();
        }
        function closeTopUp(){
          if (!topUpModal) return;
          topUpModal.classList.add('hidden');
          topUpModal.classList.remove('flex');
          qrPurpose = 'login';
        }
        navTopUpBtn?.addEventListener('click', openTopUp);
        closeTopUpBtn?.addEventListener('click', closeTopUp);
        topUpModal?.addEventListener('click', (e)=>{ if(e.target === topUpModal) closeTopUp(); });
        // Exponer apertura para menú
        window.openTopUpModal = openTopUp;

        function updateTopUpSummary(){
          amountLbl.textContent = formatCOP(topUp.amount);
          feeLbl.textContent = formatCOP(topUp.fee);
          totalLbl.textContent = formatCOP(topUp.amount + topUp.fee);
        }
        updateTopUpSummary();

        // Select preset amount
        amountChips().forEach(btn => {
          btn.addEventListener('click', () => {
            amountChips().forEach(b => b.classList.remove('ring-2','ring-america-red'));
            btn.classList.add('ring-2','ring-america-red');
            const val = parseInt(btn.dataset.amount||'0',10);
            topUp.amount = isNaN(val)? 0 : val;
            setCustomAmountValue(topUp.amount);
            updateTopUpSummary();
          });
        });

        // Custom amount
        customAmount?.addEventListener('input', (e) => {
          // Parse current value to int, then format with thousands
          const raw = customAmount.value;
          const parsed = parseToInt(raw);
          // Format value with thousands separators
          const formatted = parsed ? formatThousands(parsed) : '';
          // Only update if changed (to avoid cursor jump when typing at end)
          if (customAmount.value !== formatted) {
            const selEnd = customAmount.selectionEnd;
            customAmount.value = formatted;
            // Try to keep caret at end (for mobile this is usually fine)
            if (customAmount === document.activeElement && typeof selEnd === 'number') {
              customAmount.setSelectionRange(formatted.length, formatted.length);
            }
          }
          amountChips().forEach(b => b.classList.remove('ring-2','ring-america-red'));
          topUp.amount = parsed;
          updateTopUpSummary();
        });

        // Method select
        methodBtns().forEach(btn => {
          btn.addEventListener('click', () => {
            methodBtns().forEach(b => b.classList.remove('ring-2','ring-america-red'));
            btn.classList.add('ring-2','ring-america-red');
            topUp.method = btn.dataset.method||'card';
          });
        });

        // Process payment (simulado)
        payBtn?.addEventListener('click', () => {
          if (!topUp.amount || topUp.amount < 1000) {
            showToast('Ingresa un monto válido (mín. $1.000)', 'error');
            return;
          }
          openVerification();
        });

        function openVerification() {
          const modal = document.getElementById('verificationModal');
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          feather.replace();
        }
        function closeVerification() {
          const modal = document.getElementById('verificationModal');
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.getElementById('verifyCodeSection').classList.add('hidden');
          qrPurpose = 'login';
        }
        function verificationSuccess() {
          qrPurpose = 'login';
          closeVerification();
          processTopUp();
        }
        function processTopUp() {
          payBtn.disabled = true;
          const original = payBtn.innerHTML;
          payBtn.innerHTML = '<i data-feather="loader" class="w-5 h-5 animate-spin"></i><span>Procesando...</span>';
          feather.replace();
          setTimeout(() => {
            const balEl = document.getElementById('balanceAmount');
            if (balEl) {
              const current = parseInt(balEl.dataset.amount || '0', 10) || 0;
              const next = current + topUp.amount;
              balEl.dataset.amount = String(next);
              balEl.textContent = formatCOP(next);
            }
            try {
              const methodName = topUp.method === 'pse' ? 'PSE' : (topUp.method === 'wallet' ? 'Billetera' : 'Tarjeta');
              window.ActivityTracker?.add({
                type: 'topup',
                title: 'Recarga',
                amount: topUp.amount,
                desc: `Recarga con ${methodName} (+${formatCOP(topUp.amount)})`
              });
              window.FamilyStats?.incMatchForCurrentUniqueToday?.();
            } catch(_){}
            showGlobalOverlay({ type:'success', message:'Recarga exitosa', duration: 1600, onDone: () => { closeTopUp(); }});
            payBtn.disabled = false;
            payBtn.innerHTML = original;
            feather.replace();
          }, 1200);
        }
        // Verification event listeners
        document.getElementById('verifyNfcBtn').addEventListener('click', startVerificationNfc);
        document.getElementById('verifyQrBtn').addEventListener('click', () => {
          qrPurpose = 'topup';
          openQrModal();
          startQrScanner();
        });
        document.getElementById('verifyCodeBtn').addEventListener('click', () => {
          document.getElementById('verifyCodeSection').classList.remove('hidden');
        });
        document.getElementById('verifyCodeSubmit').addEventListener('click', () => {
          const code = document.getElementById('verifyCodeInput').value.trim();
          if (isValidAccessCode(code)) {
            showGlobalOverlay({
              type: 'success',
              message: 'Verificación exitosa',
              duration: 2000,
              onDone: verificationSuccess
            });
          } else {
            showGlobalOverlay({
              type: 'error',
              message: 'Código inválido',
              duration: 2000
            });
          }
        });
        document.getElementById('closeVerification').addEventListener('click', closeVerification);

        let toastTimer = null;
        function showToast(message, type = 'info') {
          const toast = document.getElementById('toast');
          if (!toast) return;
          const toneClasses = {
            success: ['bg-emerald-500/15', 'border-emerald-300/50', 'text-emerald-100'],
            error: ['bg-rose-500/15', 'border-rose-300/50', 'text-rose-100'],
            info: ['bg-sky-500/15', 'border-sky-300/50', 'text-sky-100']
          };
          const palette = Object.values(toneClasses).flat();

          toast.classList.remove(...palette);
          toast.textContent = message;
          toast.classList.remove('hidden');

          const selection = toneClasses[type] || toneClasses.info;
          toast.classList.add(...selection);

          if (toastTimer) window.clearTimeout(toastTimer);
          toastTimer = window.setTimeout(() => {
            toast.classList.add('hidden');
            toast.classList.remove(...palette);
          }, 3200);
        }

        // ---- Global overlay helpers ----
        function toggleScreenLock(locked) {
          document.body.classList.toggle('screen-locked', !!locked);
        }

        function buildResultIcon(type) {
          if (type === 'success') {
            return `
              <svg class="w-20 h-20 text-green-500 pop-in" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`;
          }
          if (type === 'error') {
            return `
              <svg class="w-20 h-20 text-america-red pop-in" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`;
          }
          return `
            <svg class="w-20 h-20 text-blue-400 pop-in" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
              <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
        }

        function showGlobalOverlay({ type = 'info', message = '', duration = 2000, onDone } = {}) {
          const overlay = document.getElementById('qrResultOverlay');
          const iconEl = document.getElementById('qrResultIcon');
          const msgEl = document.getElementById('qrResultMessage');
          if (!overlay || !iconEl || !msgEl) return;
          iconEl.innerHTML = buildResultIcon(type);
          msgEl.textContent = message || '';
          overlay.classList.remove('hidden');
          overlay.classList.add('flex');
          toggleScreenLock(true);
          window.setTimeout(() => {
            iconEl.innerHTML = '';
            msgEl.textContent = '';
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            toggleScreenLock(false);
            if (typeof onDone === 'function') onDone();
          }, duration);
        }
    // ---- Dashboard helpers ----
    function showDashboard(){
      document.body.classList.add('dashboard-mode');
      // Hide login, show dashboard
      document.getElementById('loginSection')?.classList.add('hidden');
      document.getElementById('dashboardSection')?.classList.remove('hidden');
      // Init libraries and dynamic bits
      if (window.AOS) { AOS.init({ duration:600, once:true }); }
      if (window.feather) { feather.replace(); }
      // La fecha y hora serán actualizadas en tiempo real por el script live-datetime
      try { window.ActivityTracker?.render(); } catch(_){}
    }

    // Logout handler
    function logout(){
      try {
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('userId');
      } catch (e) {}
      document.body.classList.remove('dashboard-mode');
      document.getElementById('dashboardSection')?.classList.add('hidden');
      document.getElementById('loginSection')?.classList.remove('hidden');
      // Cierra cualquier overlay/modal del QR por seguridad
      const overlay = document.getElementById('qrResultOverlay');
      overlay?.classList.add('hidden');
      overlay?.classList.remove('flex');
      toggleScreenLock(false);
      const qrModal = document.getElementById('qrModal');
      qrModal?.classList.add('hidden');
      qrModal?.classList.remove('flex');
      // Feedback y scroll al inicio
      showToast('Sesión cerrada', 'info');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('logoutButton')?.addEventListener('click', logout);

    // On load: if session exists, go straight to dashboard
    document.addEventListener('DOMContentLoaded', () => {
      const token = sessionStorage.getItem('authToken');
      const userId = sessionStorage.getItem('userId');
      if (token && userId) {
        showDashboard();
      }
      // Aplicar estilos 3D a tarjetas y botones
      try {
        const cardSelectors = [
          '.bg-gray-900.rounded-xl',
          '.bg-america-dark\\/95',
          '.bg-america-dark\\/90'
        ];
        document.querySelectorAll(cardSelectors.join(',')).forEach(el => el.classList.add('card-3d'));
        document.querySelectorAll('button.bg-america-red, a.bg-america-red, .bg-america-red.rounded-xl').forEach(el => el.classList.add('btn-3d-red'));
        document.querySelectorAll('button.bg-gray-800, a.bg-gray-800, .bg-gray-800.rounded-xl').forEach(el => el.classList.add('btn-3d-dark'));
      } catch (e) {}
    });
</script>

<!-- Hora en tiempo real junto a la fecha del header del dashboard -->
<script id="live-datetime">
  document.addEventListener('DOMContentLoaded', () => {
    const dateEl = document.getElementById('currentDate');
    const timeEl = document.getElementById('currentTime');

    function capitalizeFirst(txt){
      return typeof txt === 'string' && txt.length ? txt.charAt(0).toUpperCase() + txt.slice(1) : txt;
    }

    function updateDateTime(){
      const now = new Date();
      // Fecha (ej: miércoles, 25 de septiembre)
      if (dateEl) {
        const dateOpts = { weekday: 'long', day: 'numeric', month: 'long' };
        const dateTxt = now.toLocaleDateString('es-CO', dateOpts);
        dateEl.textContent = capitalizeFirst(dateTxt);
      }
      // Hora en tiempo real (HH:MM:SS)
      if (timeEl) {
        const timeOpts = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        timeEl.textContent = now.toLocaleTimeString('es-CO', timeOpts);
      }
    }

    // Inicial y actualización cada segundo
    updateDateTime();
    setInterval(updateDateTime, 1000);
  });
</script>

<div id="iosNfcModal" class="fixed inset-0 z-[80] hidden">
  <!-- backdrop -->
  <div id="iosNfcBackdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- sheet -->
  <div class="sheet pointer-events-auto fixed inset-x-0 bottom-0 mx-auto w-full max-w-md p-4">
    <div class="rounded-2xl bg-america-dark/95 text-white shadow-2xl border border-white/10">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 pt-5">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-america-red/90 grid place-items-center">
            <i data-feather="radio" class="w-4 h-4 text-white"></i>
          </div>
          <div>
            <h3 class="text-base font-semibold leading-none">Lector NFC de iPhone</h3>
            <p class="text-[12px] text-gray-400 mt-1">Safari no permite leer NFC desde la web.</p>
          </div>
        </div>
        <button id="closeIosNfcModal" class="p-2 rounded-lg hover:bg-white/5" aria-label="Cerrar">
          <i data-feather="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Body -->
      <div class="px-5 pb-5 pt-3">
        <!-- CTA principal -->
        <a id="openAppBtn"
           href="#"
           class="w-full flex items-center justify-center gap-2 bg-america-red hover:bg-red-700 text-white font-semibold py-3 rounded-xl">
          <i data-feather="smartphone" class="w-4 h-4"></i>
          <span>Abrir lector en app</span>
        </a>

        <!-- Acciones secundarias -->
        <div class="grid grid-cols-2 gap-2 mt-3">
          <button id="openControlCenterBtn"
                  class="bg-gray-900 hover:bg-gray-800 text-white/90 py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-feather="chevrons-up" class="w-4 h-4"></i>
            <span>Cómo abrir Centro de Control</span>
          </button>

          <button id="useQrFromModal"
                  class="bg-gray-900 hover:bg-gray-800 text-white/90 py-3 rounded-xl flex items-center justify-center gap-2">
            <i data-feather="maximize-2" class="w-4 h-4"></i>
            <span>Escanear QR</span>
          </button>
        </div>

        <!-- Enlace terciario -->
        <button id="useCodeFromModal"
                class="mt-3 w-full text-gray-400 hover:text-white text-sm underline">
          Ingresar código manual
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  #iosNfcModal .sheet {
    transform: translateY(24px);
    opacity: 0;
    transition: transform .22s ease, opacity .22s ease;
  }
  #iosNfcModal.show .sheet {
    transform: translateY(0);
    opacity: 1;
  }
</style>
<style>
  /* Barra de tiempo de la trivia: blanco + rojo */
  .timer-bar { position: relative; background: #ffffff; border: 1px solid rgba(255,255,255,.3); }
  .timer-fill { width: 100%; background: #D32F2F; transition: width .1s linear; box-shadow: 0 0 12px rgba(211,47,47,.45); }
  .timer-fill.timer-warning { background: #b71c1c; animation: timer-blink .6s linear infinite; }
  @keyframes timer-blink { 0%,100% { opacity: 1; } 50% { opacity: .35; } }

  /* Botones de opciones con look 3D */
  .option-btn {
    transition: transform .1s ease, background-color .2s ease, border-color .2s ease, box-shadow .2s ease;
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.06));
    border-color: rgba(255,255,255,.08) !important;
    box-shadow:
      0 1px 0 rgba(255,255,255,.06) inset,
      0 10px 18px rgba(0,0,0,.35),
      0 6px 0 rgba(0,0,0,.35);
    transform: translateY(0);
    position: relative;
    overflow: hidden;
    will-change: transform;
  }
  .option-btn:hover {
    box-shadow:
      0 1px 0 rgba(255,255,255,.07) inset,
      0 14px 24px rgba(0,0,0,.4),
      0 7px 0 rgba(0,0,0,.38),
      0 0 0 1px rgba(211,47,47,.18) inset;
    border-color: rgba(211,47,47,.35) !important;
  }
  .option-btn:active {
    box-shadow:
      0 0 0 rgba(255,255,255,0) inset,
      0 6px 12px rgba(0,0,0,.35),
      0 2px 0 rgba(0,0,0,.45);
  }
  .option-correct {
    background: linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.16)) !important;
    border-color: #16a34a !important;
    box-shadow:
      0 1px 0 rgba(255,255,255,.06) inset,
      0 10px 18px rgba(0,0,0,.35),
      0 6px 0 rgba(22,163,74,.45);
  }
  .option-wrong {
    background: linear-gradient(180deg, rgba(220,38,38,.25), rgba(220,38,38,.16)) !important;
    border-color: #dc2626 !important;
    box-shadow:
      0 1px 0 rgba(255,255,255,.06) inset,
      0 10px 18px rgba(0,0,0,.35),
      0 6px 0 rgba(220,38,38,.45);
  }
  .option-letter { display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:9999px;background:rgba(211,47,47,.15);color:#fff;border:1px solid rgba(211,47,47,.35);font-weight:600;font-size:12px; }
</style>
<style>
  /* Botones 3D (rojo y oscuro) */
  .btn-3d-red {
    box-shadow:
      0 1px 0 rgba(255,255,255,.12) inset,
      0 14px 24px rgba(211,47,47,.35),
      0 6px 0 rgba(153,27,27,.65);
    transform: translateY(0);
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn-3d-red:hover { filter: brightness(1.03); }
  .btn-3d-red:active {
    box-shadow:
      0 0 0 rgba(255,255,255,0) inset,
      0 8px 14px rgba(211,47,47,.35),
      0 2px 0 rgba(153,27,27,.75);
  }
  .btn-3d-dark {
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.06));
    border-color: rgba(255,255,255,.08) !important;
    box-shadow:
      0 1px 0 rgba(255,255,255,.06) inset,
      0 10px 18px rgba(0,0,0,.35),
      0 6px 0 rgba(0,0,0,.35);
    transform: translateY(0);
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn-3d-dark:hover {
    box-shadow:
      0 1px 0 rgba(255,255,255,.07) inset,
      0 14px 24px rgba(0,0,0,.4),
      0 7px 0 rgba(0,0,0,.38);
    filter: brightness(1.03);
  }
  .btn-3d-dark:active {
    box-shadow:
      0 0 0 rgba(255,255,255,0) inset,
      0 6px 12px rgba(0,0,0,.35),
      0 2px 0 rgba(0,0,0,.45);
  }
  /* Ripple para todos los botones */
  /* ripple deshabilitado */
</style>

<script>
  function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  }
  function showIosNfcModal() {
    const modal = document.getElementById('iosNfcModal');
    modal.classList.remove('hidden');
    // Lock body scroll for iOS modal
    document.body.classList.add('screen-locked');
    // Use requestAnimationFrame to trigger transition
    requestAnimationFrame(() => {
      modal.classList.add('show');
    });
  }
  function hideIosNfcModal() {
    const modal = document.getElementById('iosNfcModal');
    modal.classList.remove('show');
    setTimeout(() => {
      modal.classList.add('hidden');
      // Unlock body scroll after modal closes
      document.body.classList.remove('screen-locked');
    }, 220);
  }
  const nfcBtn = document.getElementById('nfcButton');
  if (nfcBtn) {
    nfcBtn.addEventListener('click', async (e) => {
      if ('NDEFReader' in window && !isIOS()) {
        // Use Web NFC API for supported browsers (Android Chrome)
        performNfcLogin();
        return;
      }
      if (isIOS()) {
        // iOS: show modal with instructions
        showIosNfcModal();
        return;
      }
      // Other unsupported browsers
      showToast('NFC no soportado en este navegador. Usa QR o código.', 'error');
    });
  }
  const openAppBtn = document.getElementById('openAppBtn');
  const appDeepLink = 'myclub://open-nfc'; 
  if (openAppBtn) {
    if (appDeepLink) {
      openAppBtn.href = appDeepLink;
      openAppBtn.classList.remove('hidden');
    } else {
      openAppBtn.classList.add('hidden');
    }
  }
  document.getElementById('openControlCenterBtn')?.addEventListener('click', () => {
    alert('Desliza desde la esquina superior derecha (iPhone X o superior) o desde abajo (iPhone 8 o anterior) y toca el icono de Lector NFC.');
  });
  document.getElementById('useQrFromModal')?.addEventListener('click', () => {
    hideIosNfcModal();
    document.getElementById('qrButton').click();
  });
  document.getElementById('closeIosNfcModal')?.addEventListener('click', hideIosNfcModal);
  document.getElementById('iosNfcBackdrop')?.addEventListener('click', hideIosNfcModal);
  document.getElementById('useCodeFromModal')?.addEventListener('click', () => {
    hideIosNfcModal();
    document.getElementById('manualButton')?.click();
  });
</script>
  <script id="events-script">
  (function(){
    const section = document.getElementById('eventsSection');
    if (!section) return;
    const container = document.getElementById('eventsContainer');
    const openBtn = document.getElementById('openCalendarBtn');
    const modal = document.getElementById('eventsModal');
    const modalContent = document.getElementById('eventsModalContent');
    const modalList = document.getElementById('eventsModalList');
    // Guarda el skeleton inicial para restaurarlo durante la carga
    const skeletonTop = container ? container.innerHTML : '';
    const skeletonModal = modalList ? modalList.innerHTML : '';
    const closeModalBtn = document.getElementById('closeEventsModal');

    const AMERICA_SOURCES = {
      icsUrl: section.dataset.ics || '',
      jsonUrl: section.dataset.json || '',
      proxyBase: '' // opcional: e.g. 'https://your-proxy.example.com/fetch?url='
    };

    function openEventsModal(){ if (!modal) return; modal.classList.remove('hidden'); modal.classList.add('flex'); document.body.classList.add('screen-locked'); feather?.replace?.(); window.trapFocus?.(modal); }
    function closeEventsModal(){ if (!modal) return; modal.classList.add('hidden'); modal.classList.remove('flex'); document.body.classList.remove('screen-locked'); resetSwipe(); window.releaseFocus?.(); }
    openBtn?.addEventListener('click', openEventsModal);
    closeModalBtn?.addEventListener('click', closeEventsModal);
    modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeEventsModal(); });

    // --- Swipe-to-close (sheet gesture) ---
    let startY = 0, dy = 0, dragging = false, atTop = true;
    const scrollEl = document.getElementById('eventsScroll');
    function resetSwipe(){ if (modalContent){ modalContent.style.transform = ''; } }
    function onTouchStart(e){
      const t = e.touches?.[0]; if (!t) return;
      startY = t.clientY; dy = 0; atTop = !scrollEl || scrollEl.scrollTop <= 0; dragging = true;
    }
    function onTouchMove(e){
      if (!dragging) return;
      const t = e.touches?.[0]; if (!t) return;
      dy = t.clientY - startY;
      if (atTop && dy > 0 && modalContent){
        modalContent.style.transform = `translateY(${Math.min(dy,180)}px)`;
        e.preventDefault(); // evita scroll del fondo en iOS
      }
    }
    function onTouchEnd(){
      if (!dragging) return; dragging = false;
      if (atTop && dy > 120) { closeEventsModal(); }
      else { resetSwipe(); }
    }
    modalContent?.addEventListener('touchstart', onTouchStart, { passive:false });
    modalContent?.addEventListener('touchmove', onTouchMove, { passive:false });
    modalContent?.addEventListener('touchend', onTouchEnd, { passive:false });

    function fmt(dt){
      try {
        return new Date(dt).toLocaleString('es-CO', { dateStyle:'medium', timeStyle:'short' });
      } catch(e){ return String(dt); }
    }
    function fmtDate(dt){
      try { return new Date(dt).toLocaleDateString('es-CO', { weekday:'short', day:'2-digit', month:'short' }); } catch(e){ return String(dt); }
    }

    async function fetchWithProxy(url){
      if (!url) throw new Error('URL vacía');
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error('HTTP '+r.status);
        return r;
      } catch(err){
        if (AMERICA_SOURCES.proxyBase){
          const proxied = AMERICA_SOURCES.proxyBase + encodeURIComponent(url);
          const r2 = await fetch(proxied);
          if (!r2.ok) throw new Error('Proxy HTTP '+r2.status);
          return r2;
        }
        throw err;
      }
    }

    function unfoldICS(text){
      // Unfold lines per RFC 5545 (continuation lines start with space)
      return text.replace(/\r?\n[ \t]/g, '');
    }
    function parseICS(text){
      const lines = unfoldICS(text).split(/\r?\n/);
      const events = [];
      let cur = null;
      for (const line of lines){
        if (line.startsWith('BEGIN:VEVENT')){ cur = {}; continue; }
        if (line.startsWith('END:VEVENT')){ if (cur) events.push(cur); cur = null; continue; }
        if (!cur) continue;
        const idx = line.indexOf(':');
        if (idx === -1) continue;
        const keyPart = line.slice(0, idx);
        const val = line.slice(idx+1);
        const key = keyPart.split(';')[0].toUpperCase();
        if (key === 'SUMMARY') cur.title = val;
        if (key === 'LOCATION') cur.location = val;
        if (key === 'DESCRIPTION') cur.description = val;
        if (key === 'DTSTART' || key === 'DTEND'){
          let v = val;
          // Normalize: yyyymmddThhmmssZ or yyyymmdd
          if (/^\d{8}T\d{6}Z$/.test(v)){
            cur[key === 'DTSTART' ? 'start' : 'end'] = new Date(v);
          } else if (/^\d{8}T\d{6}$/.test(v)){
            // treat as local time
            const y = v.slice(0,4), m=v.slice(4,6), d=v.slice(6,8), hh=v.slice(9,11), mm=v.slice(11,13), ss=v.slice(13,15);
            cur[key === 'DTSTART' ? 'start' : 'end'] = new Date(+y, +m-1, +d, +hh, +mm, +ss);
          } else if (/^\d{8}$/.test(v)){
            const y=v.slice(0,4), m=v.slice(4,6), d=v.slice(6,8);
            cur[key === 'DTSTART' ? 'start' : 'end'] = new Date(+y, +m-1, +d);
          } else {
            // fallback: Date parse
            cur[key === 'DTSTART' ? 'start' : 'end'] = new Date(v);
          }
        }
      }
      return events.map(e => ({
        title: e.title || 'Evento',
        location: e.location || '',
        start: e.start ? new Date(e.start) : null,
        end: e.end ? new Date(e.end) : null,
        description: e.description || ''
      }));
    }

    function parseFlexibleDate(str){
      if (!str || typeof str !== 'string') return null;
      const s = str.trim().toLowerCase()
        .replace(/\s+/g,' ')
        .replace(/\./g,''); // normaliza am./pm.

      const now = new Date();
      // hoy/mañana HH:MM [am|pm]
      let m = s.match(/^(hoy|manana|mañana)\s+(\d{1,2}):(\d{2})(?:\s*(am|pm))?$/i);
      if (m){
        let h = parseInt(m[2],10), min = parseInt(m[3],10);
        const ampm = m[4];
        if (ampm === 'pm' && h < 12) h += 12;
        if (ampm === 'am' && h === 12) h = 0;
        const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, min, 0);
        if (m[1].startsWith('man') || m[1].startsWith('mañ')) base.setDate(base.getDate()+1);
        return base;
      }
      // [wd,] dd/mm [y] HH:MM [am|pm]
      m = s.match(/^(?:lun|mar|mie|mié|jue|vie|sab|sáb|dom),?\s*(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\s+(\d{1,2}):(\d{2})(?:\s*(am|pm))?$/i)
        || s.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\s+(\d{1,2}):(\d{2})(?:\s*(am|pm))?$/i);
      if (m){
        const d = parseInt(m[1],10), mm = parseInt(m[2],10);
        let y = m[3] ? parseInt(m[3],10) : now.getFullYear();
        if (y < 100) y += 2000;
        let h = parseInt(m[4],10), min = parseInt(m[5],10);
        const ampm = m[6];
        if (ampm === 'pm' && h < 12) h += 12;
        if (ampm === 'am' && h === 12) h = 0;
        return new Date(y, mm-1, d, h, min, 0);
      }
      // solo dd/mm sin hora -> mediodía
      m = s.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
      if (m){
        const d = parseInt(m[1],10), mm = parseInt(m[2],10);
        let y = m[3] ? parseInt(m[3],10) : now.getFullYear();
        if (y < 100) y += 2000;
        return new Date(y, mm-1, d, 12, 0, 0);
      }
      return null;
    }

    function normalizeJsonEvents(data){
      const arr = Array.isArray(data?.events) ? data.events : (Array.isArray(data) ? data : []);
      return arr.map(x => {
        const title = x.title || x.summary || 'Evento';
        const location = x.location || '';
        const raw = x.start || x.dtstart || x.date || x.when || x.startText || x.fecha;
        let start = raw ? new Date(raw) : null;
        if (!start || isNaN(+start)) start = parseFlexibleDate(String(raw||''));
        const end = x.end ? (isNaN(+new Date(x.end)) ? null : new Date(x.end)) : null;
        const description = x.description || '';
        const status = /pospuesto|pd\b/i.test(`${title} ${description}`) ? 'pospuesto' : 'programado';
        return { title, location, start, end, description, status };
      });
    }

    function sampleEvents(){
      const now = Date.now();
      return [0,1,2,3].map(i => {
        const s = new Date(now + (i+1)*86400000 + 18*3600000);
        const e = new Date(+s + 2*3600000);
        return { title: 'América vs. Rival ' + (i+1), location: 'Estadio Pascual Guerrero', start: s, end: e, description: 'Liga BetPlay' };
      });
    }

    function loadFromInline(){
      const el = document.getElementById('eventsData');
      if (!el) throw new Error('No inline events');
      const raw = (el.textContent || el.innerHTML || '').trim();
      if (!raw) throw new Error('Inline events empty');
      let data;
      try { data = JSON.parse(raw); }
      catch(e){ throw new Error('Inline JSON parse error'); }
      const list = normalizeJsonEvents(data);
      if (!Array.isArray(list) || list.length === 0) throw new Error('Inline events none');
      return list;
    }

    async function loadFromIcs(){
      if (!AMERICA_SOURCES.icsUrl) throw new Error('No ICS URL');
      const resp = await fetchWithProxy(AMERICA_SOURCES.icsUrl);
      const text = await resp.text();
      return parseICS(text);
    }
    async function loadFromJson(){
      if (!AMERICA_SOURCES.jsonUrl) throw new Error('No JSON URL');
      const resp = await fetchWithProxy(AMERICA_SOURCES.jsonUrl);
      const data = await resp.json();
      return normalizeJsonEvents(data);
    }

    function sortAndFilterUpcoming(evts){
      const now = Date.now();
      return evts
        .filter(e => e.start && !isNaN(+e.start) && +e.start >= now - 3600000)
        .sort((a,b)=> +a.start - +b.start);
    }

    function renderEventsList(list, target){
      target.innerHTML = '';
      if (!list.length){
        target.innerHTML = '<div class="text-gray-400 text-sm">No hay eventos próximos.</div>';
        return;
      }
      list.forEach((ev, idx) => {
        const el = document.createElement('div');
        el.className = 'bg-gray-900 rounded-xl p-5 border border-gray-800';
        const when = ev.start && !isNaN(+ev.start) ? fmt(ev.start) : 'Hora por definir';
        el.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-medium mb-1">${ev.title}</h3>
              <p class="text-sm text-gray-400">${when}${ev.location ? ' · ' + ev.location : ''}</p>
            </div>
            <div class="flex gap-2">
              <button class="add-ics bg-america-red hover:bg-red-700 text-white py-1 px-3 rounded-lg text-xs">Agregar</button>
            </div>
          </div>`;
        const addBtn = el.querySelector('.add-ics');
        if (!ev.start || isNaN(+ev.start)){
          addBtn.disabled = true;
          addBtn.classList.add('opacity-50','pointer-events-none');
          addBtn.title = 'Hora por definir';
        } else {
          addBtn.addEventListener('click', () => addToCalendar(ev));
        }
        target.appendChild(el);
      });
      if (typeof feather !== 'undefined') feather.replace();
    }

    function renderTop(list){
      renderEventsList(list.slice(0,3), container);
    }

    function buildICS(ev){
      const dt = (d) => d ? d.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z$/,'Z') : '';
      const uid = `${Date.now()}-${Math.random().toString(36).slice(2)}@america-de-cali`;
      return `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//America de Cali//Eventos//ES\nBEGIN:VEVENT\nUID:${uid}\nSUMMARY:${ev.title}\nDTSTART:${dt(ev.start)}\n${ev.end?`DTEND:${dt(ev.end)}\n`:''}LOCATION:${ev.location||''}\nDESCRIPTION:${ev.description||''}\nEND:VEVENT\nEND:VCALENDAR`;
    }
    function addToCalendar(ev){
      const ics = buildICS(ev);
      const blob = new Blob([ics], { type:'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'evento.ics';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    }

    async function loadUpcomingEvents(){
      if (container) container.innerHTML = skeletonTop;
      if (modalList) modalList.innerHTML = skeletonModal;
      let events = [];
      try { events = await loadFromInline(); }
      catch(_){
        try { events = await loadFromJson(); }
        catch(__){
          try { events = await loadFromIcs(); }
          catch(___){ events = sampleEvents(); }
        }
      }
      const valid = sortAndFilterUpcoming(events);
      const invalid = events.filter(e => !e.start || isNaN(+e.start));
      renderTop(valid);
      renderEventsList(valid.concat(invalid), modalList);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadUpcomingEvents, { once:true });
    } else {
      loadUpcomingEvents();
    }
  })();
  </script>
  <script id="section-color-script">
  (function(){
    // Solo sincroniza el chip activo. El header permanece rojo fijo.
    const chipFor = new Map([
      ['#secResumen', '#sectionNav .chip[data-section="#secResumen"]'],
      ['#secPromos', '#sectionNav .chip[data-section="#secPromos"]'],
      ['#secPasaporte', '#sectionNav .chip[data-section="#secPasaporte"]'],
      ['#secComunidad', '#sectionNav .chip[data-section="#secComunidad"]'],
      ['#eventsSection', '#sectionNav .chip[data-section="#secEventos"]'],
      ['#secActividad', '#sectionNav .chip[data-section="#secActividad"]']
    ]);
    function setActive(chipSel){
      try {
        const chips = Array.from(document.querySelectorAll('#sectionNav .chip'));
        chips.forEach(c=> c.classList.remove('active'));
        const el = chipSel ? document.querySelector(chipSel) : null;
        if (el) el.classList.add('active');
      } catch(_){ }
    }
    function init(){
      const obs = new IntersectionObserver((entries)=>{
        let top = null;
        entries.forEach(en => { if (en.isIntersecting){ top = en; } });
        if (!top) return;
        const id = '#'+(top.target.id||'');
        const chipSel = chipFor.get(id);
        setActive(chipSel);
      }, { root:null, rootMargin:'-40% 0px -50% 0px', threshold:[0.25,0.6,0.9] });
      ['secResumen','secPromos','secPasaporte','secComunidad','eventsSection','secActividad'].forEach(i=>{ const el=document.getElementById(i); if (el) obs.observe(el); });
      setActive(chipFor.get('#secResumen'));
    }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init, { once:true }); else init();
  })();
  </script>
  <script id="a11y-focus-trap">
  (function(){
    let lastTrap = null;
    function qFocusable(root){ return Array.from(root.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])')).filter(el=>!el.hasAttribute('disabled') && !el.getAttribute('aria-hidden')); }
    function onKey(e){ if(e.key!=='Tab' || !lastTrap) return; const nodes = qFocusable(lastTrap); if(nodes.length===0) return; const first=nodes[0], last=nodes[nodes.length-1]; if(e.shiftKey){ if(document.activeElement===first || !lastTrap.contains(document.activeElement)){ last.focus(); e.preventDefault(); } } else { if(document.activeElement===last){ first.focus(); e.preventDefault(); } } }
    function trap(modal){ if(!modal) return; lastTrap = modal; const nodes = qFocusable(modal); (nodes[0]||modal).focus({ preventScroll:true }); document.addEventListener('keydown', onKey); }
    function release(){ lastTrap=null; document.removeEventListener('keydown', onKey); }
    window.trapFocus = trap; window.releaseFocus = release;
  })();
  </script>
  <script id="main-menu-script">
  (function(){
    const modal = document.getElementById('mainMenuModal');
    const openBtn = document.getElementById('openMainMenu');
    const closeBtn = document.getElementById('closeMainMenu');
    function open(){ modal?.classList.remove('hidden'); modal?.classList.add('flex'); feather?.replace?.(); }
    function close(){ modal?.classList.add('hidden'); modal?.classList.remove('flex'); }
    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    modal?.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
    (document.querySelectorAll('#mainMenuModal .menu-item')||[]).forEach(el=>{
      el.addEventListener('click', ()=>{
        const a = el.getAttribute('data-action');
        try{
          if (a==='profile') window.openProfileModal?.();
          else if (a==='promos') document.getElementById('promosSection')?.scrollIntoView({behavior:'smooth', block:'start'});
          else if (a==='daily') document.getElementById('openDailyChallengeBtn')?.click();
          else if (a==='topup') window.openTopUpModal?.();
          else if (a==='food') window.openFoodModal?.();
          else if (a==='map') window.openMapModal?.();
          else if (a==='show') window.openShowModal?.();
          else if (a==='family') window.openFamilyModal?.();
          else if (a==='experiences') window.openExperiencesModal?.();
          else if (a==='events') document.getElementById('openCalendarBtn')?.click();
          else if (a==='logout') window.logout?.();
        } catch(_){}
        close();
      });
    });
  })();
  </script>
  <script id="modal-esc-close">
  (function(){
    const MODALS=['profileModal','familyModal','passportModal','topUpModal','verificationModal','redeemModal','triviaModal','foodModal','mapModal','eventsModal','showModal','flashModal','dailyChallengeModal','experiencesModal','iosNfcModal','qrModal'];
    function isOpen(id){ const el=document.getElementById(id); return el && !el.classList.contains('hidden'); }
    function close(id){
      const el=document.getElementById(id); if(!el) return;
      el.classList.add('hidden'); el.classList.remove('flex');
      try{ document.body.classList.remove('screen-locked'); }catch(_){ }
    }
    function handler(e){ if(e.key!=='Escape') return; for(const id of MODALS){ if(isOpen(id)){ close(id); break; } } }
    window.addEventListener('keydown', handler);
  })();
  </script>
  <script id="ui-quick-script">
  (function(){
    function todayKey(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }
    function loadFamily(){ try{ return JSON.parse(localStorage.getItem('familyData')||'{}'); }catch(_){ return {}; } }
    function loadProfile(){ try{ return JSON.parse(localStorage.getItem('userProfile')||'{}'); }catch(_){ return {}; } }
    function owner(){ const f=loadFamily(); return (f.members||[]).find(m=>m.owner) || (f.members||[])[0] || null; }
    function attendedToday(){ const me=owner(); const t=todayKey(); return Array.isArray(me?.attendedDates) && me.attendedDates.includes(t); }
    function hasRelation(rel){ const f=loadFamily(); return (f.members||[]).some(m=> new RegExp(rel,'i').test(m.relation||'')); }
    function tribuneCount(){ const me=owner(); const p=loadProfile(); const st=(p.stand||'').toLowerCase(); const norm = st.includes('occi')?'occidental': st.includes('ori')?'oriental': st.includes('norte')?'norte': st.includes('sur')?'sur': ''; return me?.tribuneCounts?.[norm]||0; }

    function computePromos(){
      let c=0;
      if ((hasRelation('papá')||hasRelation('hijo')) && attendedToday()) c++;
      if (tribuneCount() > 0) c++;
      const me=owner(); if (hasRelation('hijo') && Array.isArray(me?.attendedDates) && me.attendedDates.length===1) c++;
      return c;
    }

    function updateBadges(){
      const dailyDone = localStorage.getItem('dailyChallengeDoneDate') === todayKey();
      const qaDailyDot = document.querySelector('#qaDaily .badge-dot');
      if (qaDailyDot) qaDailyDot.classList.toggle('hidden', dailyDone);
      const promoCount = computePromos();
      const qaPromosDot = document.querySelector('#qaPromos .badge-dot');
      if (qaPromosDot) qaPromosDot.classList.toggle('hidden', !(promoCount>0));
    }

    function wire(){
      // Section chips
      const chips = Array.from(document.querySelectorAll('#sectionNav .chip'));
      const sections = ['#secResumen','#secPromos','#secPasaporte','#secComunidad','#secEventos','#secActividad'];
      const map = { '#secPromos':'promosSection', '#secPasaporte':'passportSection', '#secComunidad':'engagementSection' };
      chips.forEach(ch => ch.addEventListener('click', ()=>{
        const target = ch.getAttribute('data-section');
        const el = document.querySelector(target) || document.getElementById(map[target]||'');
        if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
        chips.forEach(x=>x.classList.remove('active')); ch.classList.add('active');
      }));
      updateBadges();
    }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', wire, { once:true }); else wire();
  })();
  </script>
  <script id="engagement-script">
  (function(){
    const LS = {
      minute: 'lastMinuteEscarlataDate',
      idol: 'lastIdolPingDate',
      daily: 'dailyChallengeDoneDate',
      share: 'lastSharePointsDate'
    };
    const PROFILE_KEY = 'userProfile';
    function todayKey(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }
    function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch(_){ return {}; } }
    function oncePerDay(key, fn){ const t=todayKey(); const last=localStorage.getItem(key); if(last===t) return; try{ fn(); localStorage.setItem(key,t);}catch(_){} }

    // UI bindings
    document.addEventListener('DOMContentLoaded', ()=>{
      const openBtn = document.getElementById('openDailyChallengeBtn');
      const modal = document.getElementById('dailyChallengeModal');
      const closeBtn = document.getElementById('closeDailyChallenge');
      const qEl = document.getElementById('dailyChallengeQuestion');
      const aEl = document.getElementById('dailyChallengeAnswer');
      const submit = document.getElementById('submitDailyChallenge');
      const status = document.getElementById('dailyChallengeStatus');

      function setStatusDone(){ status.textContent='Completado'; status.classList.remove('bg-gray-800'); status.classList.add('bg-green-800'); }
      function setStatusPending(){ status.textContent='Pendiente'; status.classList.remove('bg-green-800'); status.classList.add('bg-gray-800'); }

      function isDoneToday(){ return localStorage.getItem(LS.daily) === todayKey(); }
      function markDone(){ localStorage.setItem(LS.daily, todayKey()); }

      function buildQuestion(){
        const p = loadProfile();
        if (p.idol){ return `¿En qué año debutó ${p.idol}?` };
        const qs = [
          '¿En qué ciudad juega como local el América?',
          '¿Cuál es el apodo del América de Cali?',
          '¿De qué color es la camiseta tradicional del América?'
        ];
        return qs[Math.floor(Math.random()*qs.length)];
      }

      function open(){ if(!modal) return; qEl.textContent = buildQuestion(); aEl.value=''; modal.classList.remove('hidden'); modal.classList.add('flex'); feather?.replace?.(); }
      function close(){ if(!modal) return; modal.classList.add('hidden'); modal.classList.remove('flex'); }

      openBtn?.addEventListener('click', ()=>{ if(isDoneToday()){ if(window.showToast) showToast('Ya completaste el reto de hoy', 'info'); return; } open(); });
      closeBtn?.addEventListener('click', close);
      modal?.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
      submit?.addEventListener('click', ()=>{
        // Validación ligera
        const ans = (aEl.value||'').trim(); if(!ans){ if(window.showToast) showToast('Escribe una respuesta','error'); return; }
        markDone(); setStatusDone();
        try { window.awardPoints?.(10,'Reto diario'); window.FamilyStats?.incTriviaForCurrent?.(); window.ActivityTracker?.add({ type:'points', points:10, title:'Reto diario', desc:'Trivia rápida completada' }); } catch(_){}
        if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'success', message:'¡Reto completado! +10 pts', duration:1500 });
        close();
      });

      // Initialize status on load
      if (isDoneToday()) setStatusDone(); else setStatusPending();

      // Minuto Escarlata (1 vez al día)
      const datos = [
        'Gol icónico 1986: título inolvidable en el Pascual.',
        'Dato: El apodo “La Mechita” nació por la camiseta roja.',
        'Recuerdo: gran campaña internacional a finales de los 80.',
      ];
      oncePerDay(LS.minute, ()=>{
        const msg = datos[Math.floor(Math.random()*datos.length)];
        try { window.ActivityTracker?.add({ type:'news', title:'Minuto Escarlata', desc: msg }); } catch(_){}
        if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'info', message: `Minuto Escarlata:\n${msg}`, duration: 2600 });
      });

      // Ping personalizado por ídolo (1 vez al día si existe)
      const p = loadProfile();
      if (p.idol){
        oncePerDay(LS.idol, ()=>{
          const msgs = [
            `Mañana cumple ${p.idol}, ¡comparte tu saludo!`,
            `${p.idol} fue figura en un clásico. ¿Lo recuerdas?`,
            `Nuevo reto: responde algo sobre ${p.idol} en el Reto diario.`
          ];
          const text = msgs[Math.floor(Math.random()*msgs.length)];
          try { window.ActivityTracker?.add({ type:'idol', title:`Tu ídolo: ${p.idol}`, desc: text }); } catch(_){}
          if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'info', message: text, duration: 2400 });
        });
      }

      // Share & earn (1 vez por día)
      const shareBtn = document.getElementById('shareAndEarnBtn');
      shareBtn?.addEventListener('click', async ()=>{
        const today = todayKey();
        if (localStorage.getItem(LS.share) === today){ if(window.showToast) showToast('Ya sumaste por compartir hoy', 'info'); return; }
        const text = '#AmericaDeCali ¡Vamos Mechita!';
        let shared = false;
        try{
          if (navigator.share){ await navigator.share({ text, title:'América de Cali' }); shared = true; }
          else { await navigator.clipboard?.writeText(text); shared = true; if(window.showToast) showToast('Hashtag copiado. ¡Pégalo y comparte!', 'info'); }
        }catch(_){ shared = false; }
        if (shared){
          localStorage.setItem(LS.share, today);
          try { window.awardPoints?.(15, 'Compartir en redes'); window.ActivityTracker?.add({ type:'points', points:15, title:'Comparte y gana', desc:'#AmericaDeCali' }); } catch(_){}
          if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'success', message:'¡Gracias por compartir! +15 pts', duration:1500 });
        }
      });
    });
  })();
  </script>
  <script id="promos-script">
  (function(){
    const FAMILY_KEY='familyData';
    const PROFILE_KEY='userProfile';
    function todayKey(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }
    function loadFamily(){ try{ return JSON.parse(localStorage.getItem(FAMILY_KEY)||'{}'); }catch(_){ return {}; } }
    function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch(_){ return {}; } }
    function owner(){ const f=loadFamily(); return (f.members||[]).find(m=>m.owner) || (f.members||[])[0] || null; }
    function hasRelation(rel){ const f=loadFamily(); return (f.members||[]).some(m=> new RegExp(rel,'i').test(m.relation||'')); }
    function attendedToday(){ const me=owner(); if(!me) return false; const t=todayKey(); return Array.isArray(me.attendedDates) && me.attendedDates.includes(t); }
    function tribuneProgress(){ const me=owner(); if(!me) return {current:'',count:0}; const p=loadProfile(); const st=(p.stand||'').toLowerCase(); const norm = st.includes('occi')?'occidental': st.includes('ori')?'oriental': st.includes('norte')?'norte': st.includes('sur')?'sur': ''; const cnt = me.tribuneCounts?.[norm]||0; return { current:norm, count:cnt } }

    function renderPromos(){
      const box=document.getElementById('promosContainer'); if(!box) return; box.innerHTML='';
      const quick=document.getElementById('promoQuickRow'); if (quick) quick.innerHTML='';
      const promos=[];
      // 2x1 familiar por venir con papá o hijo y check-in hoy
      if ((hasRelation('papá') || hasRelation('hijo')) && attendedToday()){
        promos.push({ id:'2x1', title:'2x1 en combos familiares', desc:'Porque vienes con tu familia hoy', cta:'Canjear 2x1', action: async ()=>{
          const code = (Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10);
          if (typeof openRedeemModal==='function'){ openRedeemModal(code); }
          window.ActivityTracker?.add({ type:'redeem', title:'Oferta 2x1', desc:'Combos familiares' });
        }});
      }
      // Misión: 3 partidos misma tribuna
      const tp=tribuneProgress();
      if (tp.current){
        const done = localStorage.getItem('missionTribune3:'+tp.current)==='done';
        const left = Math.max(0, 3 - (tp.count||0));
        promos.push(done ? { id:'mission3done', title:'Misión completada', desc:`3 partidos en ${tp.current} · Descuento desbloqueado`, cta:'Ver código', action: ()=>{
          const code = (Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10);
          if (typeof openRedeemModal==='function'){ openRedeemModal(code); }
          window.ActivityTracker?.add({ type:'redeem', title:'Misión', desc:`3 partidos en ${tp.current}` });
        }} : { id:'mission3', title:'Misión: tu tribuna', desc:`Asiste ${left} partido(s) más en ${tp.current} para un descuento exclusivo`, cta:'Abrir mapa', action: ()=>{ document.getElementById('mapNavBtn')?.click(); } });
      }
      // Reconocimiento emocional: con hijo y primer partido
      const me=owner(); if (hasRelation('hijo') && Array.isArray(me?.attendedDates) && me.attendedDates.length===1){
        promos.push({ id:'firstKid', title:'Gracias por traer a tu hijo', desc:'Cupón especial por su primer partido', cta:'Ver cupón', action: ()=>{
          const code = (Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10);
          if (typeof openRedeemModal==='function'){ openRedeemModal(code); }
          window.ActivityTracker?.add({ type:'redeem', title:'Primer partido en familia', desc:'Cupón especial' });
        }});
      }
      // Card experiencias
      promos.push({ id:'exp', title:'Vive experiencias únicas', desc:'Tour al camerino, foto en la cancha con tu familia', cta:'Ver experiencias', action: ()=>{ document.getElementById('openExperiencesBtn')?.click(); }});

      // Fallbacks para nunca dejar vacío
      if (promos.length < 3){
        promos.push({ id:'store10', title:'10% en tienda oficial', desc:'Solo hoy con tu membresía', cta:'Usar ahora', action: ()=>{ try{ window.openRedeemModal?.((Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10)); }catch(_){} } });
      }
      if (promos.length < 4){
        promos.push({ id:'family', title:'Combo familia', desc:'2x1 en bebida + snack', cta:'Ver combo', action: ()=>{ document.getElementById('foodNavBtn')?.click(); } });
      }

      promos.forEach(p=>{
        const card=document.createElement('div'); card.className='bg-gray-900 rounded-xl p-5 border border-gray-800';
        card.innerHTML = `<div class="flex items-center justify-between mb-2"><h3 class="font-semibold">${p.title}</h3><span class="text-xs text-gray-400">Personalizada</span></div><p class="text-sm text-gray-300">${p.desc}</p>`;
        const btn=document.createElement('button'); btn.className='mt-3 text-sm bg-america-red hover:bg-red-700 py-2 px-3 rounded-lg'; btn.textContent=p.cta; btn.addEventListener('click', p.action); card.appendChild(btn);
        box.appendChild(card);
      });
      if (typeof feather!=='undefined') feather.replace();

      // Chips rápidos
      if (quick){
        const pills = [
          { icon:'gift', label:'2x1 familia', on: ()=>{ try{ window.openRedeemModal?.((Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10)); }catch(_){} } },
          { icon:'percent', label:'10% tienda', on: ()=>{ try{ window.openRedeemModal?.((Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10)); }catch(_){} } },
          { icon:'star', label:'Experiencias', on: ()=>{ document.getElementById('openExperiencesBtn')?.click(); } }
        ];
        pills.forEach(x=>{ const b=document.createElement('button'); b.className='promo-pill flex items-center gap-2'; b.innerHTML=`<i data-feather="${x.icon}"></i><span>${x.label}</span>`; b.addEventListener('click', x.on); quick.appendChild(b); });
        if (typeof feather!=='undefined') feather.replace();
      }
    }

    function wireExperiences(){
      const openBtn=document.getElementById('openExperiencesBtn');
      const modal=document.getElementById('experiencesModal');
      const closeBtn=document.getElementById('closeExperiences');
      const list=document.getElementById('experiencesList');
      const items=[
        { id:'tour', name:'Tour al camerino', cost:300 },
        { id:'photo', name:'Foto en la cancha (familia)', cost:500 },
        { id:'band', name:'Manilla conmemorativa', cost:200 }
      ];
      function open(){ modal.classList.remove('hidden'); modal.classList.add('flex'); render(); window.trapFocus?.(modal); }
      function close(){ modal.classList.add('hidden'); modal.classList.remove('flex'); window.releaseFocus?.(); }
      function render(){ list.innerHTML=''; items.forEach(it=>{ const row=document.createElement('div'); row.className='flex items-center justify-between bg-gray-900 border border-gray-800 rounded-xl p-3'; row.innerHTML=`<div><div class="font-medium">${it.name}</div><div class="text-xs text-gray-400">Costo: ${it.cost} pts</div></div>`; const btn=document.createElement('button'); btn.className='px-3 py-2 bg-america-red hover:bg-red-700 rounded-lg text-sm'; btn.textContent='Canjear'; btn.addEventListener('click', ()=>{ if (window.spendPoints && window.spendPoints(it.cost, it.name)){ const code=(Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10); if (typeof openRedeemModal==='function'){ openRedeemModal(code); } window.ActivityTracker?.add({ type:'redeem', title:'Experiencia', desc:`${it.name}` }); close(); } }); row.appendChild(btn); list.appendChild(row); }); }
      openBtn?.addEventListener('click', open); closeBtn?.addEventListener('click', close); modal?.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
      // Exponer para menú
      window.openExperiencesModal = open;
    }

    document.addEventListener('DOMContentLoaded', ()=>{ renderPromos(); wireExperiences(); });
  })();
  </script>
  <script id="family-script">
  (function(){
    const FAMILY_KEY = 'familyData';
    const PROFILE_KEY = 'userProfile';

    // Elements
    let familyModal, closeFamilyModalBtn, familyNavBtn;
    let tabButtons, tabViews;
    let membersList, emptyState, addMemberBtn, addForm, famNameInput, famRelationInput, famPhotoInput, cancelAddFamBtn, saveAddFamBtn;
    let albumSummary, albumBar, albumMemberSelect, albumAddCount, albumAddBtn, albumBreakdown;
    let rankingMatches, rankingTrivias, matchMemberSelect, addMatchBtn, subMatchBtn, triviaMemberSelect, addTriviaBtn, subTriviaBtn;
    let addMomentBtn, momentPhotoInput, momentsTimeline;
    // Moment cropper (rectangular)
    let momentCropperModal, momentCropperImage, momentCropperApply, momentCropperCancel, momentAspectBtns;
    let momentCropper = null; let selectedAspect = '9:16';

    function getDefaultData(){ return { albumTotal: 200, members: [], moments: [] }; }
    function loadFamily(){ try { return JSON.parse(localStorage.getItem(FAMILY_KEY)) || getDefaultData(); } catch(_) { return getDefaultData(); } }
    function saveFamily(data){ localStorage.setItem(FAMILY_KEY, JSON.stringify(data)); try{ updateDashboardAlbum(data); }catch(_){} }
    function getProfile(){ try { return JSON.parse(localStorage.getItem(PROFILE_KEY)) || {}; } catch(_) { return {}; } }
    function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
    function todayKey(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }

    function ensureOwnerMember(){ const data=loadFamily(); let owner=data.members.find(m=>m.owner===true); if(!owner){ const p=getProfile(); owner={ id:uid(), owner:true, name:p.firstName||'Yo', relation:'Yo', image:p.image||null, stickers:0, matches:0, trivias:0, attendedDates:[] }; data.members.unshift(owner); saveFamily(data);} else { const p=getProfile(); if(p.firstName && owner.name!==p.firstName) owner.name=p.firstName; if(p.image && !owner.image) owner.image=p.image; if(owner.relation!=='Yo') owner.relation='Yo'; if(!Array.isArray(owner.attendedDates)) owner.attendedDates=[]; saveFamily(data);} return owner; }
    function getCurrentMember(){ const data=loadFamily(); return data.members.find(m=>m.owner) || data.members[0] || null; }

    function switchTab(name){ tabButtons.forEach(btn=>{ const a=btn.dataset.tab===name; btn.classList.toggle('ring-2', a); btn.classList.toggle('ring-america-red', a); }); tabViews.forEach(v=> v.classList.toggle('hidden', v.id!==`familyTab-${name}`)); }

    function renderMembers(){ const data=loadFamily(); membersList.innerHTML=''; if(!data.members.length){ emptyState.classList.remove('hidden'); return; } emptyState.classList.add('hidden'); data.members.forEach(m=>{ const row=document.createElement('div'); row.className='flex items-center gap-3 bg-gray-900 border border-gray-800 rounded-xl p-3'; row.innerHTML=`<div class=\"w-10 h-10 rounded-full overflow-hidden bg-gray-800 grid place-items-center text-sm font-bold\">${m.image?`<img src=\"${m.image}\" class=\"w-full h-full object-cover\"/>`:(m.name||'?').charAt(0).toUpperCase()}</div><div class=\"flex-1\"><div class=\"font-semibold\">${m.name||'Sin nombre'}</div><div class=\"text-xs text-gray-400\">${m.relation||''}</div></div><div class=\"text-xs text-gray-400 mr-2\">Láminas: <span class=\"font-semibold text-white\">${m.stickers||0}</span></div><button data-id=\"${m.id}\" class=\"fam-del px-2 py-1 rounded bg-gray-800 hover:bg-gray-700 text-xs\">Eliminar</button>`; membersList.appendChild(row); }); membersList.querySelectorAll('.fam-del').forEach(btn=> btn.addEventListener('click', ()=>{ const id=btn.getAttribute('data-id'); const data=loadFamily(); data.members=data.members.filter(m=>String(m.id)!==String(id)); saveFamily(data); renderAll(); })); }

    function updateDashboardAlbum(data){ const cardLbl=document.getElementById('albumProgressLabel'); const fill=document.getElementById('albumProgressBarFill'); if(!cardLbl||!fill) return; const total=data?.albumTotal??200; const sum=(data?.members||[]).reduce((a,m)=>a+(m.stickers||0),0); const pct=Math.max(0,Math.min(100,total?(sum/total*100):0)); cardLbl.textContent=`${sum}/${total}`; fill.style.width=`${pct.toFixed(1)}%`; }
    function renderAlbum(){ const data=loadFamily(); const total=data.albumTotal||200; const sum=data.members.reduce((a,m)=>a+(m.stickers||0),0); const pct=Math.max(0,Math.min(100,total?(sum/total*100):0)); albumSummary.textContent=`${sum}/${total}`; albumBar.style.width=`${pct.toFixed(1)}%`; albumMemberSelect.innerHTML=data.members.map(m=>`<option value="${m.id}">${m.name} • ${m.relation||''}</option>`).join(''); albumBreakdown.innerHTML=data.members.map(m=>`<div class=\"bg-gray-900 border border-gray-800 rounded-xl p-3\"><div class=\"flex items-center justify-between\"><div class=\"font-medium\">${m.name}</div><div class=\"text-sm text-gray-400\">${m.relation||''}</div></div><div class=\"mt-2 text-sm\">Láminas: <span class=\"font-semibold\">${m.stickers||0}</span></div></div>`).join(''); try{ updateDashboardAlbum(data);}catch(_){} }

    function renderRanking(){ const data=loadFamily(); const byMatches=[...data.members].sort((a,b)=>{ const ma=Array.isArray(a.attendedDates)?a.attendedDates.length:(a.matches||0); const mb=Array.isArray(b.attendedDates)?b.attendedDates.length:(b.matches||0); return mb-ma; }); const byTrivias=[...data.members].sort((a,b)=>(b.trivias||0)-(a.trivias||0)); rankingMatches.innerHTML=byMatches.map((m,i)=>`<div class=\"flex items-center justify-between bg-gray-900 border border-gray-800 rounded-lg p-2\"><div class=\"flex items-center gap-2\"><span class=\"text-xs text-gray-400 w-5\">#${i+1}</span><span class=\"font-medium\">${m.name}</span></div><div class=\"text-sm\"><span class=\"font-semibold\">${Array.isArray(m.attendedDates)?m.attendedDates.length:(m.matches||0)}</span></div></div>`).join(''); rankingTrivias.innerHTML=byTrivias.map((m,i)=>`<div class=\"flex items-center justify-between bg-gray-900 border border-gray-800 rounded-lg p-2\"><div class=\"flex items-center gap-2\"><span class=\"text-xs text-gray-400 w-5\">#${i+1}</span><span class=\"font-medium\">${m.name}</span></div><div class=\"text-sm\"><span class=\"font-semibold\">${m.trivias||0}</span></div></div>`).join(''); const opts=data.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); matchMemberSelect.innerHTML=opts; triviaMemberSelect.innerHTML=opts; }

    function renderMoments(){ const data=loadFamily(); momentsTimeline.innerHTML=''; if(!data.moments.length){ const empty=document.createElement('div'); empty.className='text-center text-gray-400 py-6'; empty.textContent='Aún no hay momentos. Sube una foto de tu legado escarlata.'; momentsTimeline.appendChild(empty); return; } data.moments.sort((a,b)=> new Date(b.date)-new Date(a.date)); data.moments.forEach(m=>{ const card=document.createElement('div'); card.className='bg-gray-900 border border-gray-800 rounded-xl overflow-hidden'; const parts=[]; if(m.image){ const box=document.createElement('div'); box.className='w-full bg-black'; box.style.aspectRatio='16/9'; const img=document.createElement('img'); img.src=m.image; img.alt='Momento'; img.className='w-full h-full object-cover'; img.addEventListener('load', ()=>{ const isPortrait=img.naturalHeight>img.naturalWidth; box.style.aspectRatio = isPortrait ? '9 / 16' : '16 / 9'; }); box.appendChild(img); parts.push(box);} const body=document.createElement('div'); body.className='p-3'; const dateEl=document.createElement('div'); dateEl.className='text-sm text-gray-400'; dateEl.textContent=new Date(m.date).toLocaleString(); const captionEl=document.createElement('div'); captionEl.className='mt-1'; captionEl.textContent=m.caption||''; const actions=document.createElement('div'); actions.className='mt-2 text-right'; const del=document.createElement('button'); del.setAttribute('data-id', m.id); del.className='moment-del px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-xs'; del.textContent='Eliminar'; actions.appendChild(del); body.appendChild(dateEl); body.appendChild(captionEl); body.appendChild(actions); parts.push(body); parts.forEach(p=> card.appendChild(p)); momentsTimeline.appendChild(card); }); momentsTimeline.querySelectorAll('.moment-del').forEach(btn=> btn.addEventListener('click', ()=>{ const id=btn.getAttribute('data-id'); const data=loadFamily(); data.moments=data.moments.filter(x=>String(x.id)!==String(id)); saveFamily(data); renderMoments(); })); }

    function renderAll(){ renderMembers(); renderAlbum(); renderRanking(); renderMoments(); feather?.replace?.(); }

    document.addEventListener('DOMContentLoaded', ()=>{
      familyModal=document.getElementById('familyModal'); familyNavBtn=document.getElementById('familyNavBtn'); closeFamilyModalBtn=document.getElementById('closeFamilyModal');
      tabButtons=Array.from(document.querySelectorAll('.family-tab')); tabViews=Array.from(document.querySelectorAll('.family-tab-view'));
      membersList=document.getElementById('familyMembersList'); emptyState=document.getElementById('familyEmptyState'); addMemberBtn=document.getElementById('addFamilyMemberBtn'); addForm=document.getElementById('familyAddForm'); famNameInput=document.getElementById('famNameInput'); famRelationInput=document.getElementById('famRelationInput'); famPhotoInput=document.getElementById('famPhotoInput'); cancelAddFamBtn=document.getElementById('cancelAddFam'); saveAddFamBtn=document.getElementById('saveAddFam');
      albumSummary=document.getElementById('familyAlbumSummary'); albumBar=document.getElementById('familyAlbumBar'); albumMemberSelect=document.getElementById('albumMemberSelect'); albumAddCount=document.getElementById('albumAddCount'); albumAddBtn=document.getElementById('albumAddBtn'); albumBreakdown=document.getElementById('albumBreakdown');
      rankingMatches=document.getElementById('rankingMatches'); rankingTrivias=document.getElementById('rankingTrivias'); matchMemberSelect=document.getElementById('matchMemberSelect'); addMatchBtn=document.getElementById('addMatchBtn'); subMatchBtn=document.getElementById('subMatchBtn'); triviaMemberSelect=document.getElementById('triviaMemberSelect'); addTriviaBtn=document.getElementById('addTriviaBtn'); subTriviaBtn=document.getElementById('subTriviaBtn');
      addMomentBtn=document.getElementById('addMomentBtn'); momentPhotoInput=document.getElementById('momentPhotoInput'); momentsTimeline=document.getElementById('momentsTimeline');
      momentCropperModal=document.getElementById('momentCropperModal'); momentCropperImage=document.getElementById('momentCropperImage'); momentCropperApply=document.getElementById('momentCropperApply'); momentCropperCancel=document.getElementById('momentCropperCancel'); momentAspectBtns=Array.from(document.querySelectorAll('#momentCropperModal .aspect-btn'));

      function openFamily(){ if(!familyModal) return; familyModal.classList.remove('hidden'); familyModal.classList.add('flex'); document.body.classList.add('screen-locked'); switchTab('members'); renderAll(); feather?.replace?.(); }
      function closeFamily(){ if(!familyModal) return; familyModal.classList.add('hidden'); familyModal.classList.remove('flex'); document.body.classList.remove('screen-locked'); }
      familyNavBtn?.addEventListener('click', openFamily); closeFamilyModalBtn?.addEventListener('click', closeFamily); familyModal?.addEventListener('click', (e)=>{ if(e.target===familyModal) closeFamily(); });
      // Exponer para menú
      window.openFamilyModal = openFamily;
      tabButtons.forEach(btn=> btn.addEventListener('click', ()=> switchTab(btn.dataset.tab)));

      addMemberBtn?.addEventListener('click', ()=>{ addForm.classList.remove('hidden'); });
      cancelAddFamBtn?.addEventListener('click', ()=>{ addForm.classList.add('hidden'); famNameInput.value=''; famRelationInput.value='Mi papá'; famPhotoInput.value=''; });
      saveAddFamBtn?.addEventListener('click', async ()=>{ const name=(famNameInput.value||'').trim(); if(!name){ window.showToast?.('Ingresa un nombre', 'error'); return; } const relation=famRelationInput.value||'Familiar'; let image=null; if(famPhotoInput.files && famPhotoInput.files[0]){ try{ const r=new FileReader(); image = await new Promise((res,rej)=>{ r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(famPhotoInput.files[0]); }); }catch(_){ image=null; } } const data=loadFamily(); data.members.push({ id:uid(), name, relation, image, stickers:0, matches:0, trivias:0, attendedDates:[] }); saveFamily(data); famNameInput.value=''; famRelationInput.value='Mi papá'; famPhotoInput.value=''; addForm.classList.add('hidden'); renderAll(); window.showToast?.('Familiar agregado','success'); });

      albumAddBtn?.addEventListener('click', ()=>{ const id=albumMemberSelect.value; const n=parseInt(albumAddCount.value||'0',10); if(!id||!n||n<=0){ window.showToast?.('Cantidad inválida','error'); return; } const data=loadFamily(); const m=data.members.find(x=>String(x.id)===String(id)); if(!m){ window.showToast?.('Selecciona un miembro','error'); return; } m.stickers=(m.stickers||0)+n; saveFamily(data); renderAlbum(); window.showToast?.('Láminas sumadas','success'); });

      addMatchBtn?.addEventListener('click', ()=>{ const id=matchMemberSelect.value; const data=loadFamily(); const m=data.members.find(x=>String(x.id)===String(id)); if(m){ if(!Array.isArray(m.attendedDates)) m.attendedDates=[]; m.attendedDates.push('manual-'+uid()); m.matches=(m.matches||0)+1; saveFamily(data); renderRanking(); }});
      subMatchBtn?.addEventListener('click', ()=>{ const id=matchMemberSelect.value; const data=loadFamily(); const m=data.members.find(x=>String(x.id)===String(id)); if(m){ if(!Array.isArray(m.attendedDates)) m.attendedDates=[]; if(m.attendedDates.length>0) m.attendedDates.pop(); m.matches=Math.max(0,(m.matches||0)-1); saveFamily(data); renderRanking(); }});
      addTriviaBtn?.addEventListener('click', ()=>{ const id=triviaMemberSelect.value; const data=loadFamily(); const m=data.members.find(x=>String(x.id)===String(id)); if(m){ m.trivias=(m.trivias||0)+1; saveFamily(data); renderRanking(); }});
      subTriviaBtn?.addEventListener('click', ()=>{ const id=triviaMemberSelect.value; const data=loadFamily(); const m=data.members.find(x=>String(x.id)===String(id)); if(m){ m.trivias=Math.max(0,(m.trivias||0)-1); saveFamily(data); renderRanking(); }});

      addMomentBtn?.addEventListener('click', ()=> momentPhotoInput?.click());
      momentPhotoInput?.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; e.target.value=''; if(!file) return; let dataUrl=null; try{ const r=new FileReader(); dataUrl=await new Promise((res,rej)=>{ r.onload=e2=>res(e2.target.result); r.onerror=rej; r.readAsDataURL(file); }); }catch(_){ dataUrl=null; } if(!dataUrl) return; openMomentCropperWith(dataUrl); });

      function openMomentCropperWith(dataUrl){ if(!momentCropperModal||!momentCropperImage) return; momentCropperImage.src=dataUrl; momentCropperModal.classList.remove('hidden'); momentCropperModal.classList.add('flex'); setTimeout(()=>{ try{ if(momentCropper){ try{momentCropper.destroy();}catch(_){} momentCropper=null; } const map={'9:16':9/16,'16:9':16/9,'4:5':4/5,'1:1':1}; const aspect = selectedAspect==='free'? NaN : (map[selectedAspect]||9/16); momentCropper = new Cropper(momentCropperImage, { aspectRatio: isNaN(aspect)? NaN : aspect, viewMode:1, dragMode:'move', autoCropArea:1, background:false }); }catch(_){ } }, 30); }
      function closeMomentCropper(){ if(!momentCropperModal) return; momentCropperModal.classList.add('hidden'); momentCropperModal.classList.remove('flex'); try{ momentCropper?.destroy?.(); }catch(_){} momentCropper=null; }
      function setAspect(aspect){ selectedAspect=aspect; momentAspectBtns.forEach(b=>{ const active=b.dataset.aspect===aspect; b.classList.toggle('ring-2', active); b.classList.toggle('ring-america-red', active); }); try{ if(momentCropper){ const map={'9:16':9/16,'16:9':16/9,'4:5':4/5,'1:1':1}; const val=aspect==='free'? NaN : (map[aspect]||NaN); momentCropper.setAspectRatio(val); } }catch(_){} }
      function applyMomentCrop(){ if(!momentCropper) return; try{ const sizes={'9:16':{w:1080,h:1920},'4:5':{w:1080,h:1350},'16:9':{w:1280,h:720},'1:1':{w:1080,h:1080}}; const target=sizes[selectedAspect]||null; const canvas = target? momentCropper.getCroppedCanvas({ width: target.w, height: target.h, imageSmoothingQuality:'high' }) : momentCropper.getCroppedCanvas({ imageSmoothingQuality:'high' }); const dataUrl=canvas.toDataURL('image/jpeg',0.92); const caption=window.prompt('Describe el momento (opcional):','')||''; const data=loadFamily(); data.moments.push({ id:uid(), date:new Date().toISOString(), caption, image:dataUrl }); saveFamily(data); renderMoments(); window.showToast?.('Momento agregado','success'); closeMomentCropper(); }catch(_){} }
      momentAspectBtns.forEach(b=> b.addEventListener('click', ()=> setAspect(b.dataset.aspect)));
      momentCropperApply?.addEventListener('click', applyMomentCrop);
      momentCropperCancel?.addEventListener('click', closeMomentCropper);
      momentCropperModal?.addEventListener('click', (e)=>{ if(e.target===momentCropperModal) closeMomentCropper(); });

      ensureOwnerMember();
      try{ updateDashboardAlbum(loadFamily()); }catch(_){ }

      // Public API for hooks
      window.FamilyStats = {
        incTriviaForCurrent(){ const data=loadFamily(); const me=getCurrentMember()||ensureOwnerMember(); if(!me) return; me.trivias=(me.trivias||0)+1; saveFamily(data); renderRanking(); },
        incMatchForCurrent(dateStr){
          const data=loadFamily(); const me=getCurrentMember()||ensureOwnerMember(); if(!me) return; if(!Array.isArray(me.attendedDates)) me.attendedDates=[];
          const key=(dateStr||todayKey()); if(!me.attendedDates.includes(key)){
            me.attendedDates.push(key); me.matches=(me.matches||0)+1;
            // Tribuna streaks
            try { const p = JSON.parse(localStorage.getItem('userProfile')||'{}'); const st=(p.stand||'').toLowerCase(); const norm = st.includes('occi')?'occidental': st.includes('ori')?'oriental': st.includes('norte')?'norte': st.includes('sur')?'sur': (st||'oriental'); me.tribuneCounts = me.tribuneCounts||{}; me.tribuneCounts[norm] = (me.tribuneCounts[norm]||0)+1; const cnt = me.tribuneCounts[norm]; if (cnt===3 && localStorage.getItem('missionTribune3:'+norm)!=='done'){ localStorage.setItem('missionTribune3:'+norm,'done'); if (typeof openRedeemModal==='function'){ const code=(Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10); openRedeemModal(code); window.ActivityTracker?.add({ type:'redeem', title:'Misión completada', desc:`3 partidos en ${norm}` }); } else { window.showToast?.('Misión: 3 partidos en la misma tribuna', 'success'); }
            } } catch(_){}
            // Primer partido con tu hijo reconocimiento
            try { const hasKid = (data.members||[]).some(m=>/hijo/i.test(m.relation||'')); if (hasKid && me.attendedDates.length===1 && localStorage.getItem('kidFirstThanks')!=='done'){ localStorage.setItem('kidFirstThanks','done'); if (typeof openRedeemModal==='function'){ const code=(Math.random().toString(36).slice(2,8)+Date.now().toString(36)).toUpperCase().slice(0,10); openRedeemModal(code); window.ActivityTracker?.add({ type:'redeem', title:'Gracias por traer a tu hijo', desc:'Cupón especial' }); if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'success', message:'¡Gracias por traer a tu hijo a su primer partido! 🎉', duration:2000 }); } }
            } catch(_){}
            saveFamily(data); renderRanking();
          }
        },
        incMatchForCurrentUniqueToday(){ this.incMatchForCurrent(todayKey()); }
      };
    });
  })();
  </script>
  <script id="map-script">
  (function(){
    const modal = document.getElementById('mapModal');
    const openBtn = document.getElementById('mapNavBtn');
    const closeBtn = document.getElementById('closeMapModal');
    const locateBtn = document.getElementById('locateMeBtn');
    const checkInBtn = document.getElementById('checkInBtn');
    const svg = document.getElementById('stadiumSvg');
    const sectorsLayer = svg?.querySelector('#sectors');
    const poisLayer = svg?.querySelector('#pois');
    const emotionsLayer = svg?.querySelector('#emotions');
    const meetupsLayer = svg?.querySelector('#meetups');
    const familyRoute = svg?.querySelector('#familyRoute');
    const familyFootsteps = svg?.querySelector('#familyFootsteps');
    const userMarker = svg?.querySelector('#userMarker');
    const route = svg?.querySelector('#evacRoute');
    const layerBath = document.getElementById('layerBath');
    const layerFood = document.getElementById('layerFood');
    const layerExit = document.getElementById('layerExit');
    const layerRoute = document.getElementById('layerRoute');
    const layerMural = document.getElementById('layerMural');
    const layerPassion = document.getElementById('layerPassion');
    const layerHistory = document.getElementById('layerHistory');
    const currentStand = document.getElementById('currentStand');
    const floorBtns = Array.from(document.querySelectorAll('#mapModal .floor-btn'));
    const entradaSelect = document.getElementById('entradaSelect');
    const withChild = document.getElementById('withChild');
    const traceFamilyRouteBtn = document.getElementById('traceFamilyRouteBtn');
    const markMeetBtn = document.getElementById('markMeetBtn');
    const clearMeetBtn = document.getElementById('clearMeetBtn');
    const meetList = document.getElementById('meetList');

    let watchId = null;
    const PROFILE_KEY = 'userProfile';
    const getProfile = ()=>{ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch(_){ return {}; } };

    // Geometry (viewBox 1000x700)
    const CX=500, CY=350; // centro
    const INNER_RX=240, INNER_RY=160; // borde cerca de la cancha
    const RING_W=28; // grosor de anillo por piso

    const ANG = {
      norte:  [45, 135],
      occidental: [135, 225],
      sur:   [225, 315],
      oriental:  [315, 405], // 405 equivale a 45°
    };

    // Colores aproximados por tribuna/piso (piso 1 interior → piso 3 exterior)
    const COLORS = {
      norte:     ['#3dd5ae', '#22c55e'],
      sur:       ['#eab0b0', '#cf8f8f'],
      oriental:  ['#f59e0b', '#fb923c', '#fde047'],
      occidental:['#86efac', '#ef4444', '#a78bfa'],
    };

    // Helper: punto en elipse
    function polar(rx, ry, angleDeg){
      const th = (angleDeg*Math.PI)/180;
      return { x: CX + rx*Math.cos(th), y: CY + ry*Math.sin(th) };
    }

    // Path de sector anular elíptico
    function annularPath(rxIn, ryIn, rxOut, ryOut, a0, a1){
      const large = ((a1-a0) % 360 + 360) % 360 > 180 ? 1 : 0;
      const p0o = polar(rxOut, ryOut, a0);
      const p1o = polar(rxOut, ryOut, a1);
      const p1i = polar(rxIn,  ryIn,  a1);
      const p0i = polar(rxIn,  ryIn,  a0);
      return [
        `M ${p0o.x.toFixed(1)} ${p0o.y.toFixed(1)}`,
        `A ${rxOut} ${ryOut} 0 ${large} 1 ${p1o.x.toFixed(1)} ${p1o.y.toFixed(1)}`,
        `L ${p1i.x.toFixed(1)} ${p1i.y.toFixed(1)}`,
        `A ${rxIn} ${ryIn} 0 ${large} 0 ${p0i.x.toFixed(1)} ${p0i.y.toFixed(1)}`,
        'Z'
      ].join(' ');
    }

    function buildSectors(){ if(!sectorsLayer) return; sectorsLayer.innerHTML='';
      const tribunes = ['norte','occidental','sur','oriental'];
      tribunes.forEach(t=>{
        const [a0,a1] = ANG[t];
        const levels = COLORS[t].length;
        for(let i=0;i<levels;i++){
          const rxIn = INNER_RX + i*RING_W;
          const ryIn = INNER_RY + i*RING_W*0.70; // leve achatamiento vertical
          const rxOut = rxIn + RING_W*0.95;
          const ryOut = ryIn + RING_W*0.95*0.70;
          const path = document.createElementNS('http://www.w3.org/2000/svg','path');
          path.setAttribute('class','seg');
          path.setAttribute('fill', COLORS[t][i]);
          path.setAttribute('data-tribune', t);
          path.setAttribute('data-level', String(i+1));
          path.setAttribute('d', annularPath(rxIn, ryIn, rxOut, ryOut, a0, a1));
          sectorsLayer.appendChild(path);
        }
      });
    }

    // POIs distribuidos por piso y tribuna (centros aproximados)
    const pois = [
      {type:'bath', floor:1, tribune:'norte',    ang:90,   r: INNER_RX-20},
      {type:'bath', floor:2, tribune:'norte',    ang:60,   r: INNER_RX+RING_W+8},
      {type:'bath', floor:1, tribune:'sur',      ang:270,  r: INNER_RX-20},
      {type:'bath', floor:2, tribune:'sur',      ang:300,  r: INNER_RX+RING_W+8},
      {type:'food', floor:1, tribune:'oriental', ang:350,  r: INNER_RX+12},
      {type:'food', floor:2, tribune:'oriental', ang:10,   r: INNER_RX+RING_W+18},
      {type:'food', floor:3, tribune:'oriental', ang:20,   r: INNER_RX+2*RING_W+22},
      {type:'food', floor:1, tribune:'occidental',ang:190, r: INNER_RX+12},
      {type:'food', floor:2, tribune:'occidental',ang:170, r: INNER_RX+RING_W+18},
      {type:'food', floor:3, tribune:'occidental',ang:160, r: INNER_RX+2*RING_W+22},
      {type:'exit', floor:1, tribune:'sur',      ang:240,  r: INNER_RX-40},
      {type:'exit', floor:1, tribune:'norte',    ang:120,  r: INNER_RX-40},
    ];
    // Emocional: murales, pasión, debut histórico
    const emos = [
      {type:'mural', tribune:'oriental', ang:330, r: INNER_RX+8},
      {type:'mural', tribune:'occidental', ang:200, r: INNER_RX+10},
      {type:'passion', tribune:'sur', ang:260, r: INNER_RX+18},
      {type:'passion', tribune:'norte', ang:120, r: INNER_RX+22},
      {type:'debut', tribune:'occidental', ang:150, r: INNER_RX+26},
    ];

    let selectedFloor = null;
    let selectedTribune = null;
    function labelFloor(){ return selectedFloor? `Piso ${selectedFloor}` : 'Piso (elige)'; }
    function updateFloorUI(){ if(currentStand) currentStand.textContent = labelFloor(); floorBtns.forEach(b=> b.classList.toggle('active', parseInt(b.dataset.floor||'0',10)===selectedFloor)); }

    function renderPois(){ if(!poisLayer) return; poisLayer.innerHTML=''; if (emotionsLayer) emotionsLayer.innerHTML='';
      const showBath = layerBath?.checked !== false; const showFood = layerFood?.checked !== false; const showExit = layerExit?.checked !== false;
      const showMural = layerMural?.checked !== false; const showPassion = layerPassion?.checked !== false; const showHistory = layerHistory?.checked !== false;
      for(const p of pois){
        if((p.type==='bath' && !showBath) || (p.type==='food' && !showFood) || (p.type==='exit' && !showExit)) continue;
        if(selectedFloor && p.floor !== selectedFloor) continue;
        if(selectedTribune && p.tribune !== selectedTribune) continue;
        const xy = polar(p.r, p.r*0.70, p.ang);
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','poi'); g.setAttribute('transform',`translate(${xy.x},${xy.y})`);
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r','9');
         if(p.type==='bath') c.setAttribute('fill','#ffffff'); else if(p.type==='food') c.setAttribute('fill','#ffffff'); else c.setAttribute('fill','#ffffff');
        const o = document.createElementNS('http://www.w3.org/2000/svg','circle'); o.setAttribute('r','16'); o.setAttribute('fill','white'); o.setAttribute('opacity','0.08');
        g.appendChild(o); g.appendChild(c); poisLayer.appendChild(g);
        attachPoiTooltip(g, p);
      }
      if (emotionsLayer){
        for(const e of emos){
          if((e.type==='mural' && !showMural) || (e.type==='passion' && !showPassion) || (e.type==='debut' && !showHistory)) continue;
          if(selectedTribune && e.tribune !== selectedTribune) continue;
          const xy = polar(e.r, e.r*0.70, e.ang);
          const g = document.createElementNS('http://www.w3.org/2000/svg','g');
          g.setAttribute('class',`poi ${e.type}`); g.setAttribute('transform',`translate(${xy.x},${xy.y})`);
          const c = document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r','9'); c.setAttribute('fill', e.type==='passion' ? '#D32F2F' : '#ffffff');
          const o = document.createElementNS('http://www.w3.org/2000/svg','circle'); o.setAttribute('r','16'); o.setAttribute('fill','white'); o.setAttribute('opacity','0.08');
          g.appendChild(o); g.appendChild(c); emotionsLayer.appendChild(g);
          attachPoiTooltip(g, { type: e.type });
        }
      }
    }
    // Tooltip para POIs
    const tooltipEl = document.getElementById('mapTooltip');
    function labelFor(p){
      if (!p) return '';
      if (p.type==='bath') return 'Baños';
      if (p.type==='food') return 'Comida';
      if (p.type==='exit') return 'Salida';
      if (p.type==='mural') return 'Mural histórico';
      if (p.type==='passion') return 'Tribuna pasional';
      if (p.type==='debut') return 'Aquí debutó…';
      return 'Punto de interés';
    }
    function attachPoiTooltip(g, p){ if(!tooltipEl || !svg) return; const show=(ev)=>{ const rect=svg.getBoundingClientRect(); const m = ev.touches?.[0] || ev; const x=m.clientX - rect.left; const y=m.clientY - rect.top; tooltipEl.style.left = `${x+8}px`; tooltipEl.style.top = `${y+8}px`; tooltipEl.textContent = labelFor(p); tooltipEl.classList.remove('hidden'); }; const hide=()=> tooltipEl.classList.add('hidden'); g.addEventListener('mouseenter', show); g.addEventListener('mouseleave', hide); g.addEventListener('touchstart', (e)=>{ show(e); setTimeout(hide, 1600); }, { passive:true }); }

    function setUserMarker(x,y){ if(!userMarker) return; userMarker.setAttribute('transform',`translate(${x},${y})`); userMarker.setAttribute('opacity','1'); }
    function estimateStand(){
      const st = (getProfile().stand||'').toLowerCase();
      if(!st) return '';
      if(st.includes('occi')) return 'occidental';
      if(st.includes('ori')) return 'oriental';
      if(st.includes('norte')) return 'norte';
      if(st.includes('sur')) return 'sur';
      return st;
    }
    function centerByStand(){ const st=estimateStand();
      if(!st) return;
      // Usa el punto medio del anillo de piso 1 de cada tribuna
      const mid = { norte: polar(INNER_RX+RING_W*0.5, (INNER_RY+RING_W*0.5*0.70), 90), sur: polar(INNER_RX+RING_W*0.5, (INNER_RY+RING_W*0.5*0.70), 270), occidental: polar(INNER_RX+RING_W*0.5, (INNER_RY+RING_W*0.5*0.70), 180), oriental: polar(INNER_RX+RING_W*0.5, (INNER_RY+RING_W*0.5*0.70), 0) };
      const p = mid[st]; if(p) setUserMarker(p.x, p.y);
    }
    function startGeo(){ if(!navigator.geolocation){ centerByStand(); return; }
      try { if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } } catch(_){ }
      watchId = navigator.geolocation.watchPosition((pos)=>{
        const st=estimateStand();
        const base = st==='norte'? polar(INNER_RX, INNER_RY*0.9, 90) : st==='sur'? polar(INNER_RX, INNER_RY*0.9, 270) : st==='occidental'? polar(INNER_RX, INNER_RY*0.9, 180) : polar(INNER_RX, INNER_RY*0.9, 0);
        const jitter = Math.min(24, Math.max(6, (pos.coords.accuracy||50)/10));
        setUserMarker(base.x + (Math.random()*2-1)*jitter, base.y + (Math.random()*2-1)*jitter);
      }, ()=>{ centerByStand(); }, { enableHighAccuracy:true, maximumAge:8000, timeout:10000 });
    }

    function applySelection(){
      // Segmentar por piso y tribuna
      sectorsLayer?.querySelectorAll('.seg').forEach(seg=>{
        const lvl = parseInt(seg.getAttribute('data-level')||'0',10);
        const trib = seg.getAttribute('data-tribune');
        seg.classList.remove('active','dim');
        let visible = true;
        if(selectedFloor && lvl !== selectedFloor) visible = false;
        if(visible && selectedTribune && trib !== selectedTribune) seg.classList.add('dim');
        seg.style.display = visible ? '' : 'none';
        if(visible && selectedTribune && trib === selectedTribune) seg.classList.add('active');
      });
      updateFloorUI();
      renderPois();
    }

    function wireSectors(){
      sectorsLayer?.querySelectorAll('.seg').forEach(seg=>{
        seg.addEventListener('click', ()=>{
          const trib = seg.getAttribute('data-tribune');
          const lvl = parseInt(seg.getAttribute('data-level')||'0',10);
          selectedTribune = trib; selectedFloor = lvl; applySelection(); lockFloorButtons(); zoomToTribune(selectedTribune);
        });
      });
    }

    // Bloqueo/desbloqueo Piso 3 según tribuna
    function lockFloorButtons(){
      const isSide = selectedTribune==='occidental' || selectedTribune==='oriental';
      const btn3 = document.querySelector('#mapModal .floor-btn[data-floor="3"]');
      if (btn3){
        btn3.disabled = !isSide;
        btn3.classList.toggle('opacity-50', !isSide);
        btn3.classList.toggle('cursor-not-allowed', !isSide);
      }
      if (!isSide && selectedFloor===3){ selectedFloor = 2; applySelection(); }
    }

    // Zoom animado por tribuna via viewBox
    let currentViewBox = { x:0, y:0, w:1000, h:700 };
    function vbString(vb){ return `${vb.x} ${vb.y} ${vb.w} ${vb.h}`; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function centerForTrib(trib){ const ang = trib==='norte'?90: trib==='sur'?270: trib==='occidental'?180:0; const p = polar(INNER_RX+RING_W*1.5, (INNER_RY+RING_W*1.5*0.70), ang); return p; }
    function zoomToTribune(trib){ if(!svg || !trib) return; const c = centerForTrib(trib); const target = { w: 650, h: 455 }; const halfW = target.w/2, halfH = target.h/2; const tx = clamp(c.x - halfW, 0, 1000 - target.w); const ty = clamp(c.y - halfH, 0, 700 - target.h); const to = { x: tx, y: ty, w: target.w, h: target.h };
      const from = { ...currentViewBox }; const dur = 320; const t0 = performance.now();
      function step(now){ const t = Math.min(1, (now - t0)/dur); const e = t*(2-t); const vb = { x: from.x + (to.x-from.x)*e, y: from.y + (to.y-from.y)*e, w: from.w + (to.w-from.w)*e, h: from.h + (to.h-from.h)*e }; svg.setAttribute('viewBox', vbString(vb)); if (t<1) requestAnimationFrame(step); else currentViewBox = to; }
      requestAnimationFrame(step);
    }

    function open(){ if(!modal) return; modal.classList.remove('hidden'); modal.classList.add('flex'); feather?.replace?.();
      if (!sectorsLayer || !sectorsLayer.childElementCount) { buildSectors(); wireSectors(); }
      // Autoselección de tribuna desde el perfil
      const st = estimateStand(); if (st){ selectedTribune = st; }
      // Piso por defecto: 2 para laterales, 1 para norte/sur
      if(!selectedFloor){ selectedFloor = (st==='occidental'||st==='oriental')?2:1; }
      lockFloorButtons();
      startGeo(); updateRoute(); applySelection(); renderMeetups(); zoomToTribune(selectedTribune||st);
      window.trapFocus?.(modal);
    }
    function close(){ if(!modal) return; modal.classList.add('hidden'); modal.classList.remove('flex'); window.releaseFocus?.(); }

    function toggle(v, el){ if(!el) return; el.style.display = v ? '' : 'none'; }
    function updateRoute(){ toggle(document.getElementById('layerRoute')?.checked !== false, route); }

    openBtn?.addEventListener('click', open);
    // Exponer apertura del mapa para menú global
    window.openMapModal = open;
    closeBtn?.addEventListener('click', close);
    modal?.addEventListener('click', (e)=>{ if(e.target===modal) close(); });
    locateBtn?.addEventListener('click', startGeo);
    checkInBtn?.addEventListener('click', ()=>{
      try { window.FamilyStats?.incMatchForCurrentUniqueToday?.(); window.ActivityTracker?.add?.({ type:'attendance', title:'Asistencia', desc:'Check-in manual en mapa' }); if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'success', message:'Check-in registrado', duration:1400 }); } catch(_){}
    });
    layerBath?.addEventListener('change', renderPois);
    layerFood?.addEventListener('change', renderPois);
    layerExit?.addEventListener('change', renderPois);
    layerRoute?.addEventListener('change', updateRoute);
    document.getElementById('layerMural')?.addEventListener('change', renderPois);
    document.getElementById('layerPassion')?.addEventListener('change', renderPois);
    document.getElementById('layerHistory')?.addEventListener('change', renderPois);
    floorBtns.forEach(btn=> btn.addEventListener('click', ()=>{ selectedFloor = parseInt(btn.getAttribute('data-floor')||'1',10); applySelection(); }));

    // ---- Guía familiar ----
    function entrancePoint(name){
      const map={ norte:90, sur:270, occidental:180, oriental:0 };
      const ang = map[name] ?? 0;
      return polar(INNER_RX+2*RING_W+26, (INNER_RY+2*RING_W+26*0.70), ang);
    }
    function standPoint(){
      const st=estimateStand() || 'oriental';
      const ang = st==='norte'?90: st==='sur'?270: st==='occidental'?180:0;
      return polar(INNER_RX+RING_W*0.5, (INNER_RY+RING_W*0.5*0.70), ang);
    }
    function drawFamilyRoute(){ if(!familyRoute||!familyFootsteps) return; const ep=entrancePoint(entradaSelect?.value||'oriental'); const sp=standPoint(); const mid = { x:(ep.x+sp.x)/2, y: Math.min(ep.y, sp.y) - 40 }; const pts = [ep, mid, sp]; familyRoute.setAttribute('points', pts.map(p=>`${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ')); while(familyFootsteps.firstChild) familyFootsteps.removeChild(familyFootsteps.firstChild); const steps=14; for(let i=1;i<steps;i++){ const t=i/(steps-1); const ax=ep.x+(mid.x-ep.x)*t; const ay=ep.y+(mid.y-ep.y)*t; const bx=mid.x+(sp.x-mid.x)*t; const by=mid.y+(sp.y-mid.y)*t; const x = t<0.5? ax : bx; const y = t<0.5? ay : by; const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx', x.toFixed(1)); c.setAttribute('cy', y.toFixed(1)); c.setAttribute('r', (withChild?.checked? 3.2 : 2.8).toString()); familyFootsteps.appendChild(c);} }
    document.getElementById('traceFamilyRouteBtn')?.addEventListener('click', drawFamilyRoute);

    // ---- Puntos de encuentro ----
    const FAMILY_KEY='familyData';
    function loadFamily(){ try{ return JSON.parse(localStorage.getItem(FAMILY_KEY)||'{}'); }catch(_){ return {}; } }
    function saveFamily(d){ try{ localStorage.setItem(FAMILY_KEY, JSON.stringify(d)); }catch(_){} }
    function addMeetPoint(p){ if(!meetupsLayer) return; const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform',`translate(${p.x.toFixed(1)},${p.y.toFixed(1)})`); const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r','8'); c.setAttribute('fill','#60a5fa'); const o=document.createElementNS('http://www.w3.org/2000/svg','circle'); o.setAttribute('r','16'); o.setAttribute('fill','white'); o.setAttribute('opacity','0.08'); g.appendChild(o); g.appendChild(c); meetupsLayer.appendChild(g); }
    function renderMeetups(){ if(!meetupsLayer||!meetList) return; meetupsLayer.innerHTML=''; meetList.innerHTML=''; const fam=loadFamily(); const arr=Array.isArray(fam.meetups)? fam.meetups : []; arr.forEach((p,idx)=>{ addMeetPoint(p); const li=document.createElement('div'); li.className='flex items-center justify-between'; li.innerHTML=`<span>Punto #${idx+1}</span><button data-idx="${idx}" class="text-xs px-2 py-1 bg-gray-800 rounded">Quitar</button>`; meetList.appendChild(li); }); meetList.querySelectorAll('button').forEach(btn=> btn.addEventListener('click', ()=>{ const i=parseInt(btn.getAttribute('data-idx')||'0',10); const fam=loadFamily(); fam.meetups=(fam.meetups||[]).filter((_,k)=>k!==i); saveFamily(fam); renderMeetups(); })); }
    let marking=false; function viewCoords(evt){ const rect=svg.getBoundingClientRect(); const x=(evt.clientX-rect.left)/rect.width*1000; const y=(evt.clientY-rect.top)/rect.height*700; return {x,y}; }
    document.getElementById('markMeetBtn')?.addEventListener('click', ()=>{ marking=true; if(window.showToast) showToast('Toca el mapa para marcar', 'info'); });
    document.getElementById('clearMeetBtn')?.addEventListener('click', ()=>{ const fam=loadFamily(); fam.meetups=[]; saveFamily(fam); renderMeetups(); });
    svg?.addEventListener('click', (e)=>{ if(!marking) return; const p=viewCoords(e); marking=false; const fam=loadFamily(); if(!Array.isArray(fam.meetups)) fam.meetups=[]; fam.meetups.push(p); saveFamily(fam); renderMeetups(); });
  })();
  </script>

  <script id="live-integration-script">
  (function(){
    const LIVE_WS = ((location.protocol==='https:')?'wss':'ws') + '://' + location.host + '/ws/stadium';
    const LIVE_SSE = '/api/stadium/live';
    const alertsBox = document.getElementById('liveAlerts');
    const PROFILE_KEY = 'userProfile';
    const getProfile = ()=>{ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch(_){ return {}; } };
    const standOf = ()=> (getProfile().stand||'').toLowerCase();

    function showAlert({title, body, kind}){
      if(!alertsBox) return;
      const el = document.createElement('div');
      el.className = 'bg-gray-900/95 border border-gray-800 rounded-xl shadow-xl p-3 min-w-[220px] max-w-[320px]';
      el.innerHTML = `<div class=\"flex items-start gap-2\">\n        <div class=\"mt-0.5\">${kind==='goal'? '⚽' : kind==='substitution'? '🔁' : kind==='warning'? '⚠️' : '📣'}</div>\n        <div class=\"flex-1\">\n          <div class=\"font-semibold text-sm\">${title||'Alerta'}</div>\n          ${body? `<div class=\"text-xs text-gray-300 mt-0.5\">${body}</div>`:''}\n        </div>\n        <button class=\"text-gray-400 hover:text-white\" aria-label=\"Cerrar\">×</button>\n      </div>`;
      el.querySelector('button')?.addEventListener('click', ()=>{ try{ alertsBox.removeChild(el); }catch(_){} });
      alertsBox.appendChild(el);
      setTimeout(()=>{ try{ alertsBox.removeChild(el); }catch(_){} }, 6000);
    }

    function vibrate(pattern){ try{ if('vibrate' in navigator) navigator.vibrate(pattern||[120,80,120]); }catch(_){} }
    function lights(onMillis){
      const screenFlash = document.getElementById('screenFlash'); if(!screenFlash) return;
      screenFlash.classList.remove('hidden'); screenFlash.classList.add('red-mode','pulse-red');
      setTimeout(()=>{ screenFlash.classList.add('hidden'); screenFlash.classList.remove('red-mode','pulse-red'); }, Math.max(800, onMillis||2000));
    }

    function matchesTribune(target){
      const st = standOf(); if(!target || !st) return true;
      const t = String(target).toLowerCase();
      return t==='all' || st.includes(t);
    }

    function handleEvent(evt){
      try{
        const data = typeof evt === 'string' ? JSON.parse(evt) : evt;
        const kind = (data.type||'').toLowerCase();
        if(kind==='goal'){
          showAlert({title:`¡GOL de ${data.club||'América'}!`, body:data.player? `Anota ${data.player}`:'', kind:'goal'});
          vibrate([200,120,200,120,220]); lights(2200);
        } else if(kind==='substitution'){
          showAlert({title:'Cambio', body:`Sale ${data.out} • Entra ${data.in}`, kind:'substitution'});
        } else if(kind==='message'){
          showAlert({title:data.title||'Mensaje del club', body:data.body||'', kind:'info'});
        } else if(kind==='vibrate'){
          if(matchesTribune(data.tribune)) vibrate(data.pattern||[120,80,120]);
        } else if(kind==='tribune_lights'){
          if(matchesTribune(data.tribune)) lights(data.duration||1800);
        }
      }catch(_){ /* ignore */ }
    }

    let es = null, ws = null, retry=0, timer=null;
    function connect(){
      cleanup();
      if('EventSource' in window){
        try{
          es = new EventSource(LIVE_SSE);
          es.onmessage = (e)=> handleEvent(e.data);
          es.onerror = ()=>{ es && es.close(); schedule(); };
          return;
        }catch(_){ /* fallback to WS */ }
      }
      try{
        ws = new WebSocket(LIVE_WS);
        ws.onmessage = (e)=> handleEvent(e.data);
        ws.onclose = schedule;
        ws.onerror = schedule;
      }catch(_){ schedule(); }
    }
    function schedule(){ clearTimeout(timer); retry = Math.min(30000, (retry||1000)*1.7); timer=setTimeout(connect, retry); }
    function cleanup(){ try{ if(es){ es.close(); es=null; } }catch(_){} try{ if(ws){ ws.close(); ws=null; } }catch(_){} clearTimeout(timer); }

    window.LiveStadium = { test: handleEvent };
    if (document.readyState !== 'loading') connect(); else document.addEventListener('DOMContentLoaded', connect, { once:true });
    window.addEventListener('beforeunload', cleanup);
  })();
  </script>
  <script id="trivia-script">
  (function(){
    const playBtn = document.getElementById('playTriviaBtn');
    const modal = document.getElementById('triviaModal');
    const closeBtn = document.getElementById('closeTrivia');
    const winModal = document.getElementById('triviaWinModal');
    const closeWinBtn = document.getElementById('closeTriviaWin');
    const intro = document.getElementById('triviaIntro');
    const game = document.getElementById('triviaGame');
    const btnStart = document.getElementById('startTrivia');
    const qEl = document.getElementById('triviaQuestion');
    const optsEl = document.getElementById('triviaOptions');
    const progEl = document.getElementById('triviaProgress');
    const scoreEl = document.getElementById('triviaScore');
    const timerLabel = document.getElementById('triviaTimerLabel');
    const timerFill = document.getElementById('triviaTimerFill');

    if (!playBtn || !modal) return;

    const QUESTIONS = [
      { q: '¿En qué ciudad juega como local el América?', a: ['Cali','Bogotá','Medellín','Barranquilla'], c: 0 },
      { q: '¿Cómo se llama su estadio?', a: ['Pascual Guerrero','El Campín','Atanasio Girardot','Metropolitano'], c: 0 },
      { q: '¿Cuál es el color tradicional del América?', a: ['Rojo','Azul','Verde','Amarillo'], c: 0 },
      { q: '¿Cuál es su apodo más conocido?', a: ['Los Diablos Rojos','Los Embajadores','El Verdolaga','Los Tiburones'], c: 0 },
      { q: '¿Cuál es su clásico regional?', a: ['Deportivo Cali','Atlético Nacional','Junior','Santa Fe'], c: 0 },
      { q: '¿En qué país juega el América de Cali?', a: ['Colombia','Argentina','México','Ecuador'], c: 0 },
      { q: '¿En qué competición nacional compite?', a: ['Categoría Primera A','Serie A','Liga MX','MLS'], c: 0 },
      { q: '¿Cómo se le dice cariñosamente al equipo?', a: ['La Mechita','La Máquina','La Academia','El Rojo del Sur'], c: 0 },
      { q: '¿Qué figura aparece en el escudo del club?', a: ['Un diablo','Un león','Un águila','Un toro'], c: 0 },
      { q: '¿A qué departamento pertenece la ciudad de Cali?', a: ['Valle del Cauca','Antioquia','Cundinamarca','Atlántico'], c: 0 }
    ];

    // Estado del juego
    let idx = 0; let score = 0; let rewardGiven = false; let order = [];
    // Temporizador
    const TIME_LIMIT_MS = 10000;
    let timerInterval = null;
    let timerEndAt = 0;

    function stopTimer(){ if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
    function endGame(reason){
      stopTimer();
      if (timerFill) { timerFill.classList.remove('timer-warning'); timerFill.style.width = '100%'; }
      Array.from(optsEl.querySelectorAll('button')).forEach(b=>b.disabled=true);
      const msg = reason === 'timeout' ? 'Tiempo agotado. Juego terminado.' : 'Respuesta incorrecta. Juego terminado.';
      if (typeof showGlobalOverlay === 'function') {
        showGlobalOverlay({ type:'error', message: msg, duration: 1800, onDone: () => { close(); intro.classList.remove('hidden'); game.classList.add('hidden'); } });
      } else {
        close(); intro.classList.remove('hidden'); game.classList.add('hidden'); alert(msg);
      }
    }
    function startTimer(onTimeout){
      stopTimer();
      timerEndAt = Date.now() + TIME_LIMIT_MS;
      if (timerLabel) timerLabel.textContent = `${Math.ceil(TIME_LIMIT_MS/1000)}s`;
      if (timerFill) { timerFill.style.width = '100%'; timerFill.classList.remove('timer-warning'); }
      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(0, timerEndAt - now);
        const pct = remaining / TIME_LIMIT_MS;
        if (timerLabel) timerLabel.textContent = `${Math.ceil(remaining/1000)}s`;
        if (timerFill) {
          timerFill.style.width = `${pct*100}%`;
          if (remaining <= 3000) timerFill.classList.add('timer-warning'); else timerFill.classList.remove('timer-warning');
        }
        if (remaining <= 0){ stopTimer(); if (typeof onTimeout === 'function') onTimeout(); }
      }, 100);
    }
    

    function open(){ modal.classList.remove('hidden'); modal.classList.add('flex'); feather?.replace?.(); window.trapFocus?.(modal); }
    function close(){ modal.classList.add('hidden'); modal.classList.remove('flex'); window.releaseFocus?.(); }
    function start(){
      intro.classList.add('hidden');
      game.classList.remove('hidden');
      score = 0; idx = 0; rewardGiven = false;
      order = [...Array(QUESTIONS.length).keys()];
      // barajar
      for (let i=order.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [order[i],order[j]]=[order[j],order[i]]; }
      render();
    }

    function render(){
      if (idx >= QUESTIONS.length){
        const msg = `¡Terminaste! Aciertos: ${score}/${QUESTIONS.length}`;
        if (typeof showGlobalOverlay === 'function') showGlobalOverlay({ type:'info', message: msg, duration: 2500 });
        setTimeout(()=>{ close(); intro.classList.remove('hidden'); game.classList.add('hidden'); }, 2600);
        return;
      }
      const q = QUESTIONS[order[idx]];
      progEl.textContent = `Pregunta ${idx+1}/${QUESTIONS.length}`;
      scoreEl.textContent = `Aciertos: ${score}`;
      qEl.textContent = q.q;
      optsEl.innerHTML = '';
      // Baraja las opciones para que la correcta no siempre sea la primera
      const optIdx = [...Array(q.a.length).keys()];
      for (let i=optIdx.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [optIdx[i],optIdx[j]]=[optIdx[j],optIdx[i]]; }
      optIdx.forEach((origIdx, k)=>{
        const txt = q.a[origIdx];
        const letter = String.fromCharCode(65 + k);
        const b = document.createElement('button');
        b.className = 'option-btn w-full text-left bg-gray-900 hover:bg-gray-800 border border-gray-800 rounded-xl px-4 py-3';
        b.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class=\"option-letter\">${letter}</span><span class="option-text">${txt}</span></div><span class="option-mark ml-2 inline-flex items-center"></span></div>`;
        b.addEventListener('click', ()=> choose(origIdx === q.c, b));
        optsEl.appendChild(b);
      });

      // Inicia temporizador de 10s por pregunta (muerte súbita)
      startTimer(() => {
        if (typeof showToast === 'function') showToast('Tiempo agotado', 'error');
        endGame('timeout');
      });
    }

    function discountCode(){
      const ALPHA = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let out = 'DESC-';
      const arr = new Uint32Array(8);
      (window.crypto||{}).getRandomValues?.(arr);
      for (let i=0;i<8;i++){ out += ALPHA[(arr[i]||Math.floor(Math.random()*ALPHA.length))%ALPHA.length]; }
      return out;
    }

    function openCongrats(){
      if (!winModal) return;
      winModal.classList.remove('hidden');
      winModal.classList.add('flex');
    }

    async function choose(correct, btn){
      stopTimer();
      // Disable all
      Array.from(optsEl.querySelectorAll('button')).forEach(b=>b.disabled=true);
      if (correct){
        btn.classList.remove('bg-gray-900');
        btn.classList.add('option-correct');
        const mark = btn.querySelector('.option-mark');
        if (mark) {
          mark.innerHTML = `<svg class=\"w-5 h-5 text-green-400\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M20 6L9 17l-5-5\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>`;
        }
        score++;
        scoreEl.textContent = `Aciertos: ${score}`;
        if (score >= 5 && !rewardGiven){
          rewardGiven = true;
          const code = discountCode();
          // Copiar automáticamente el código
          let copied = false;
          try { await navigator.clipboard?.writeText(code); copied = true; } catch(e){}
          try { window.awardPoints?.(50, 'Trivia: 5 aciertos'); } catch(_){}
          try { window.FamilyStats?.incTriviaForCurrent?.(); } catch(_){}
          try { window.ActivityTracker?.add({ type:'redeem', title:'Canje', desc:`Código ${code} (Trivia)` }); } catch(_){}
          // Usa modal de canje si existe; si no, overlay
          if (typeof openRedeemModal === 'function'){ 
            openRedeemModal(code);
            const copyBtn = document.getElementById('copyRedeemCodeBtn');
            if (copied && copyBtn) copyBtn.textContent = 'Copiado';
          } else if (typeof showGlobalOverlay === 'function') {
            const msg = copied ? `Código de descuento: ${code} · Copiado` : `Código de descuento: ${code}`;
            showGlobalOverlay({ type:'success', message: msg, duration: 3400 });
          } else { 
            alert(`Código de descuento: ${code}`);
          }
        }
        if (score === QUESTIONS.length){
          openCongrats();
        }
      } else {
        btn.classList.remove('bg-gray-900');
        btn.classList.add('option-wrong');
        const mark = btn.querySelector('.option-mark');
        if (mark) {
          mark.innerHTML = `<svg class=\"w-5 h-5 text-red-400\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M18 6L6 18M6 6l12 12\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>`;
        }
        setTimeout(()=> endGame('wrong'), 700);
        return;
      }
      setTimeout(()=>{ idx++; render(); }, 900);
    }

    playBtn.addEventListener('click', open);
    closeBtn?.addEventListener('click', ()=>{ stopTimer(); close(); intro.classList.remove('hidden'); game.classList.add('hidden'); });
    modal.addEventListener('click', (e)=>{ if (e.target === modal){ stopTimer(); close(); intro.classList.remove('hidden'); game.classList.add('hidden'); }});
    btnStart.addEventListener('click', start);
    closeWinBtn?.addEventListener('click', ()=>{ winModal.classList.add('hidden'); winModal.classList.remove('flex'); });
    winModal?.addEventListener('click', (e)=>{ if (e.target === winModal){ winModal.classList.add('hidden'); winModal.classList.remove('flex'); }});
  })();
  </script>
  <script id="redeem-script">
  // Generador seguro de código único y binding de botones "Canjear"
  (function(){
    const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let redeemTimerId = null;
    let redeemExpiryAt = 0;
    function generateRandomCode(len = 15){
      let out = '';
      const cryptoObj = window.crypto || window.msCrypto;
      if (cryptoObj && cryptoObj.getRandomValues){
        const buf = new Uint32Array(len);
        cryptoObj.getRandomValues(buf);
        for (let i = 0; i < len; i++){ out += ALPHABET[buf[i] % ALPHABET.length]; }
      } else {
        for (let i = 0; i < len; i++){ out += ALPHABET.charAt(Math.floor(Math.random() * ALPHABET.length)); }
      }
      return out;
    }

    // Persistencia simple para evitar repetir códigos (por dispositivo)
    function loadIssued(){
      try {
        const raw = localStorage.getItem('redeemCodes');
        return new Set(raw ? JSON.parse(raw) : []);
      } catch(e){ return new Set(); }
    }
    function saveIssued(set){
      try { localStorage.setItem('redeemCodes', JSON.stringify(Array.from(set))); } catch(e){}
    }
    function generateUniqueCode(len = 15, maxTries = 10){
      const issued = loadIssued();
      let code = '';
      for (let i=0; i<maxTries; i++){
        code = generateRandomCode(len);
        if (!issued.has(code)){
          issued.add(code);
          saveIssued(issued);
          return code;
        }
      }
      // En caso extremadamente improbable de colisiones repetidas, devolver el último
      return code || generateRandomCode(len);
    }

    // ==== Modal de canje ====
    function formatMMSS(ms){
      const totalSec = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(totalSec/60)).padStart(2,'0');
      const s = String(totalSec%60).padStart(2,'0');
      return `${m}:${s}`;
    }
    function updateRedeemCountdown(){
      const lbl = document.getElementById('redeemCodeExpiry');
      const copyBtn = document.getElementById('copyRedeemCodeBtn');
      const shareBtn = document.getElementById('shareRedeemCodeBtn');
      if (!lbl) return;
      const now = Date.now();
      const remaining = redeemExpiryAt - now;
      if (remaining <= 0){
        lbl.textContent = 'Código expirado';
        if (copyBtn) { copyBtn.disabled = true; copyBtn.classList.add('opacity-50','pointer-events-none'); }
        if (shareBtn) { shareBtn.disabled = true; shareBtn.classList.add('opacity-50','pointer-events-none'); }
        if (redeemTimerId) { clearInterval(redeemTimerId); redeemTimerId = null; }
        return;
      }
      lbl.textContent = `Expira en ${formatMMSS(remaining)}`;
    }
    function startRedeemCountdown(ms){
      redeemExpiryAt = Date.now() + ms;
      if (redeemTimerId) { clearInterval(redeemTimerId); redeemTimerId = null; }
      updateRedeemCountdown();
      redeemTimerId = setInterval(updateRedeemCountdown, 1000);
    }
    function stopRedeemCountdown(){
      if (redeemTimerId) { clearInterval(redeemTimerId); redeemTimerId = null; }
    }
    function openRedeemModal(code){
      const modal = document.getElementById('redeemModal');
      const codeEl = document.getElementById('redeemCodeValue');
      const copyBtn = document.getElementById('copyRedeemCodeBtn');
      if (!modal || !codeEl) return false;
      codeEl.textContent = code;
      if (copyBtn) copyBtn.textContent = 'Copiar';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      window.trapFocus?.(modal);
      // Reiniciar estados y arrancar cuenta (15 minutos)
      if (copyBtn) { copyBtn.disabled = false; copyBtn.classList.remove('opacity-50','pointer-events-none'); }
      const shareBtn = document.getElementById('shareRedeemCodeBtn');
      if (shareBtn) { shareBtn.disabled = false; shareBtn.classList.remove('opacity-50','pointer-events-none'); }
      startRedeemCountdown(15 * 60 * 1000);
      return true;
    }
    function closeRedeemModal(){
      const modal = document.getElementById('redeemModal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      stopRedeemCountdown();
      window.releaseFocus?.();
    }
    function bindRedeemModalControls(){
      const modal = document.getElementById('redeemModal');
      const copyBtn = document.getElementById('copyRedeemCodeBtn');
      const closeBtn = document.getElementById('closeRedeemModal');
      const shareBtn = document.getElementById('shareRedeemCodeBtn');
      if (copyBtn && copyBtn.dataset.bound !== '1'){
        copyBtn.dataset.bound = '1';
        copyBtn.addEventListener('click', async () => {
          const code = document.getElementById('redeemCodeValue')?.textContent || '';
          try { await navigator.clipboard?.writeText(code); copyBtn.textContent = 'Copiado'; } catch(e){}
        });
      }
      if (shareBtn && shareBtn.dataset.bound !== '1'){
        shareBtn.dataset.bound = '1';
        shareBtn.classList.remove('hidden');
        shareBtn.addEventListener('click', async () => {
          const code = document.getElementById('redeemCodeValue')?.textContent || '';
          if (navigator.share) {
            try {
              await navigator.share({ title: 'Código de canje', text: `Mi código de canje es: ${code}` });
              return;
            } catch(e) { /* cancelado o no disponible */ }
          }
          try { await navigator.clipboard?.writeText(code); } catch(e){}
          if (typeof showGlobalOverlay === 'function') {
            showGlobalOverlay({ type: 'info', message: 'Código copiado para compartir', duration: 1800 });
          }
        });
      }
      if (closeBtn && closeBtn.dataset.bound !== '1'){
        closeBtn.dataset.bound = '1';
        closeBtn.addEventListener('click', closeRedeemModal);
      }
      if (modal && modal.dataset.bound !== '1'){
        modal.dataset.bound = '1';
        modal.addEventListener('click', (e)=>{ if(e.target === modal) closeRedeemModal(); });
      }
    }

    function bindBtn(btn){
      if(!btn) return;
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';
      btn.addEventListener('click', async () => {
        const code = generateUniqueCode(15);
        if (openRedeemModal(code)) {
          bindRedeemModalControls();
          try { await navigator.clipboard?.writeText(code); const copyBtn = document.getElementById('copyRedeemCodeBtn'); if (copyBtn) copyBtn.textContent = 'Copiado'; } catch(e){}
          try { window.ActivityTracker?.add({ type:'redeem', title:'Canje', desc:`Código ${code}` }); } catch(_){}
        } else if (typeof showGlobalOverlay === 'function') {
          showGlobalOverlay({ type: 'success', message: `Tu código es: ${code}`, duration: 3000 });
          try { window.ActivityTracker?.add({ type:'redeem', title:'Canje', desc:`Código ${code}` }); } catch(_){}
        } else if (typeof showToast === 'function') {
          showToast(`Tu código es: ${code}`, 'success');
          try { window.ActivityTracker?.add({ type:'redeem', title:'Canje', desc:`Código ${code}` }); } catch(_){}
        } else {
          alert(`Tu código es: ${code}`);
          try { window.ActivityTracker?.add({ type:'redeem', title:'Canje', desc:`Código ${code}` }); } catch(_){}
        }
      });
    }

    function bindRedeem(){
      bindBtn(document.getElementById('redeemComboBtn'));
      bindBtn(document.getElementById('redeemNavBtn'));
      // Bind genérico: cualquier botón cuyo texto contenga "Canjear"
      const btns = Array.from(document.querySelectorAll('button'));
      btns.forEach(b => {
        const text = (b.textContent||'').trim().toLowerCase();
        if (text.includes('canjear')) bindBtn(b);
      });
    }

    // Bind inmediato o en DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => { bindRedeem(); bindRedeemModalControls(); }, { once:true });
    } else {
      bindRedeem();
      bindRedeemModalControls();
    }
  })();
  </script>
  <script id="food-ordering-script">
  (function(){
    const foodModal = document.getElementById('foodModal');
    const openFoodBtn = document.getElementById('foodNavBtn');
    const closeFoodBtn = document.getElementById('closeFoodModal');
    const foodGrid = document.getElementById('foodGrid');
    const cartBar = document.getElementById('foodCartBar');
    const cartCountEl = document.getElementById('cartCount');
    const cartTotalBarEl = document.getElementById('cartTotalBar');
    const goToCheckoutBtn = document.getElementById('goToCheckout');
    const menuView = document.getElementById('foodMenuView');
    const checkoutView = document.getElementById('foodCheckoutView');
    const successView = document.getElementById('foodSuccessView');
    const cartList = document.getElementById('cartList');
    const cartSubtotal = document.getElementById('cartSubtotal');
    const cartService = document.getElementById('cartService');
    const cartTotal = document.getElementById('cartTotal');
    const payBtn = document.getElementById('confirmFoodPayment');
    const seatTribuna = document.getElementById('seatTribuna');
    const seatFila = document.getElementById('seatFila');
    const seatSilla = document.getElementById('seatSilla');
    const closeFoodSuccess = document.getElementById('closeFoodSuccess');
    const successMsg = document.getElementById('foodSuccessMsg');

    const SERVICE_FEE = 3000;
    const ITEMS = [
      { id:'hotdog', name:'Perro caliente', price:18000, emoji:'🌭' },
      { id:'burger', name:'Hamburguesa', price:24000, emoji:'🍔' },
      { id:'pizza', name:'Pizza (porción)', price:22000, emoji:'🍕' },
      { id:'nachos', name:'Nachos con queso', price:17000, emoji:'🧀' },
      { id:'popcorn', name:'Palomitas', price:12000, emoji:'🍿' },
      { id:'soda', name:'Gaseosa 500ml', price:9000, emoji:'🥤' },
      { id:'water', name:'Agua', price:7000, emoji:'💧' },
      { id:'coffee', name:'Café', price:8000, emoji:'☕️' },
      { id:'arepa', name:'Arepa rellena', price:15000, emoji:'🥙' }
    ];

    const cart = new Map(); // id -> qty

    function fmtCOP(n){ return `$${(Math.round(n)||0).toLocaleString('es-CO')}`; }

    function openFood(){ if (!foodModal) return; foodModal.classList.remove('hidden'); foodModal.classList.add('flex'); feather.replace(); window.trapFocus?.(foodModal); }
    function closeFood(){ if (!foodModal) return; foodModal.classList.add('hidden'); foodModal.classList.remove('flex'); showMenu(); clearSuccess(); window.releaseFocus?.(); }
    function showMenu(){ menuView.classList.remove('hidden'); checkoutView.classList.add('hidden'); successView.classList.add('hidden'); cartBar.classList.remove('hidden'); }
    function showCheckout(){ menuView.classList.add('hidden'); checkoutView.classList.remove('hidden'); successView.classList.add('hidden'); cartBar.classList.add('hidden'); feather.replace(); }
    function showSuccess(){ menuView.classList.add('hidden'); checkoutView.classList.add('hidden'); successView.classList.remove('hidden'); cartBar.classList.add('hidden'); }
    function clearSuccess(){ successMsg.textContent=''; }

    function qtyOf(id){ return cart.get(id) || 0; }
    function setQty(id, qty){
      if (qty <= 0) cart.delete(id); else cart.set(id, qty);
      renderCartBar();
    }

    function renderMenu(){
      if (!foodGrid) return;
      foodGrid.innerHTML = '';
      ITEMS.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-gray-900 rounded-xl p-4 border border-gray-800 flex flex-col gap-2';
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-gray-800 grid place-items-center text-2xl">${item.emoji}</div>
            <div class="min-w-0">
              <div class="font-semibold leading-tight">${item.name}</div>
              <div class="text-sm text-gray-400">${fmtCOP(item.price)}</div>
            </div>
          </div>
          <div class="flex items-center justify-end gap-2 mt-1">
            <button class="dec px-3 py-2 rounded-lg bg-gray-800 border border-gray-700">-</button>
            <span class="qty w-8 text-center">${qtyOf(item.id)}</span>
            <button class="inc px-3 py-2 rounded-lg bg-america-red hover:bg-red-700">+</button>
          </div>`;
        const inc = card.querySelector('.inc');
        const dec = card.querySelector('.dec');
        const qtyEl = card.querySelector('.qty');
        inc.addEventListener('click', ()=>{ const q=qtyOf(item.id)+1; setQty(item.id, q); qtyEl.textContent = q; });
        dec.addEventListener('click', ()=>{ const q=Math.max(0, qtyOf(item.id)-1); setQty(item.id, q); qtyEl.textContent = q; });
        foodGrid.appendChild(card);
      });
      feather.replace();
    }

    function totals(){
      let count = 0, subtotal = 0;
      cart.forEach((q, id) => {
        const it = ITEMS.find(i=>i.id===id); if (!it) return;
        count += q; subtotal += q * it.price;
      });
      return { count, subtotal, service: cart.size>0 ? SERVICE_FEE : 0, total: subtotal + (cart.size>0 ? SERVICE_FEE : 0) };
    }

    function renderCartBar(){
      const t = totals();
      cartCountEl.textContent = String(t.count);
      cartTotalBarEl.textContent = fmtCOP(t.total);
      goToCheckoutBtn.disabled = t.count === 0;
    }

    function renderCheckout(){
      const t = totals();
      cartList.innerHTML = '';
      if (cart.size === 0){
        cartList.innerHTML = '<p class="text-gray-400">No has agregado productos.</p>';
      } else {
        cart.forEach((q, id) => {
          const it = ITEMS.find(i=>i.id===id); if (!it) return;
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between';
          row.innerHTML = `<span class="text-gray-300">${it.name} × ${q}</span><span class="font-medium">${fmtCOP(q*it.price)}</span>`;
          cartList.appendChild(row);
        });
      }
      cartSubtotal.textContent = fmtCOP(t.subtotal);
      cartService.textContent = fmtCOP(t.service);
      cartTotal.textContent = fmtCOP(t.total);
      validateCheckout();
    }

    function getBalance(){
      const el = document.getElementById('balanceAmount');
      if (!el) return 0;
      const rawAttr = el.getAttribute('data-amount');
      const fromAttr = rawAttr ? parseInt(rawAttr,10) : NaN;
      if (!isNaN(fromAttr)) return fromAttr;
      const rawText = (el.textContent||'').replace(/[^0-9]/g,'');
      return parseInt(rawText||'0',10) || 0;
    }
    function setBalance(newVal){
      const el = document.getElementById('balanceAmount');
      if (!el) return;
      const v = Math.max(0, Math.round(newVal));
      el.setAttribute('data-amount', String(v));
      el.textContent = fmtCOP(v);
    }

    function validateCheckout(){
      const t = totals();
      const okSeat = !!seatTribuna.value && !!seatFila.value.trim() && !!seatSilla.value.trim();
      const okBal = getBalance() >= t.total && t.total > 0;
      payBtn.disabled = !(okSeat && okBal);
    }

    function bindCheckoutInputs(){
      [seatTribuna, seatFila, seatSilla].forEach(el => el?.addEventListener('input', validateCheckout));
    }

    function handlePayment(){
      const t = totals();
      if (cart.size === 0) return;
      if (!seatTribuna.value || !seatFila.value.trim() || !seatSilla.value.trim()) return;
      const bal = getBalance();
      if (bal < t.total){ if (window.showToast) showToast('Saldo insuficiente. Recarga para continuar', 'error'); return; }
      setBalance(bal - t.total);
      // Mensaje de éxito con tribuna, fila y silla
      successMsg.textContent = `Tu pedido llegará a tu tribuna ${seatTribuna.value}, fila ${seatFila.value}, silla ${seatSilla.value}. ¡Disfruta el partido!`;
      try {
        const items = [];
        cart.forEach((q, id) => { if (q>0) items.push(`${q}× ${id}`); });
        window.ActivityTracker?.add({
          type: 'order',
          title: 'Pedido de comida',
          total: t.total,
          desc: `-${fmtCOP(t.total)} · ${items.length? items.join(', ') : (t.count + ' ítems')}`
        });
      } catch(_){}
      showSuccess();
      cart.clear();
      renderCartBar();
    }

    // Bindings
    openFoodBtn?.addEventListener('click', () => { openFood(); renderMenu(); renderCartBar(); });
    // Exponer apertura para menú global
    window.openFoodModal = () => { openFood(); renderMenu(); renderCartBar(); };
    closeFoodBtn?.addEventListener('click', closeFood);
    foodModal?.addEventListener('click', (e)=>{ if (e.target === foodModal) closeFood(); });
    goToCheckoutBtn?.addEventListener('click', () => { showCheckout(); renderCheckout(); bindCheckoutInputs(); feather.replace(); });
    payBtn?.addEventListener('click', handlePayment);
    closeFoodSuccess?.addEventListener('click', closeFood);
  })();
  </script>
  <script id="ui-effects-script">
  // Efectos de ripple y tilt deshabilitados
  (function(){ /* no-op */ })();
  </script>
  <script id="activity-tracker-script">
  (function(){
    const LS_KEY = 'recentActivities:v1';
    const MAX_ITEMS = 30;

    function fmtCOP(n){ try { return `$${(Math.round(n)||0).toLocaleString('es-CO')}`; } catch(_) { return `$${Math.round(n)||0}`; } }
    function fmtDate(ts){
      const d = ts instanceof Date ? ts : new Date(ts);
      const opts = { day:'2-digit', month:'short'};
      const time = d.toLocaleTimeString('es-CO',{hour:'2-digit', minute:'2-digit'});
      const date = d.toLocaleDateString('es-CO', opts).replace('.', '');
      return `${date}, ${time}`;
    }

    const ICONS = {
      order: 'shopping-bag',
      topup: 'dollar-sign',
      points: 'award',
      redeem: 'gift',
      recycle: 'repeat',
      info: 'activity'
    };

    function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch(_) { return []; } }
    function save(list){ localStorage.setItem(LS_KEY, JSON.stringify(list.slice(0, MAX_ITEMS))); }

    function render(){
      const list = load();
      const box = document.getElementById('activityList');
      if (!box) return;
      const expanded = box.dataset.expanded === 'true';
      box.innerHTML = '';
      if (!list.length){
        const empty = document.createElement('div');
        empty.className = 'bg-gray-900 rounded-xl p-5 border border-gray-800 text-sm text-gray-400';
        empty.textContent = 'Aún no hay actividad. ¡Empieza recargando, pidiendo o jugando!';
        box.appendChild(empty);
        if (window.feather) feather.replace();
        return;
      }
      const shown = expanded ? list : list.slice(0,5);
      shown.forEach(evt => {
        const icon = ICONS[evt.type] || ICONS.info;
        const title = evt.title || (evt.type==='order'?'Compra':evt.type==='topup'?'Recarga':evt.type==='points'?'Puntos':'Actividad');
        const right = fmtDate(evt.ts || Date.now());
        const subtitle = evt.subtitle || (evt.type==='topup' && typeof evt.amount==='number' ? `+${fmtCOP(evt.amount)}` : (evt.type==='order' && typeof evt.total==='number'? `-${fmtCOP(evt.total)}` : (evt.type==='points' && evt.points ? `+${evt.points} pts` : '')));
        const card = document.createElement('div');
        card.className = 'bg-gray-900 rounded-xl p-5 border border-gray-800';
        card.innerHTML = `
          <div class="flex justify-between">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <i data-feather="${icon}" class="w-4 h-4 text-america-red"></i>
                <span class="font-medium">${title}</span>
              </div>
              <p class="text-sm text-gray-400">${evt.desc || subtitle || ''}</p>
            </div>
            <span class="text-sm text-gray-400">${right}</span>
          </div>`;
        box.appendChild(card);
      });
      // Toggle para ver más / ver menos
      if (list.length > 5){
        const wrap = document.createElement('div');
        wrap.className = 'mt-3 flex justify-center';
        const btn = document.createElement('button');
        btn.id = 'activityToggle';
        btn.className = 'px-3 py-2 rounded-xl';
        btn.textContent = expanded ? 'Ver menos' : 'Ver más';
        btn.addEventListener('click', ()=>{ box.dataset.expanded = expanded ? 'false' : 'true'; render(); });
        wrap.appendChild(btn);
        box.appendChild(wrap);
      }
      if (window.feather) feather.replace();
    }

    function add(evt){
      const entry = Object.assign({ ts: Date.now(), type:'info' }, evt||{});
      const list = load();
      list.unshift(entry);
      save(list);
      render();
    }

    // Exponer API global
    window.ActivityTracker = { add, render };
    // Render en carga si ya está el dashboard visible
    if (document.readyState !== 'loading') { render(); }
    else document.addEventListener('DOMContentLoaded', render, { once:true });
  })();
  </script>

  <script id="points-script">
  (function(){
    const LS_KEY = 'userPoints:v1';
    function getPoints(){
      try {
        const stored = localStorage.getItem(LS_KEY);
        if (stored != null) return Math.max(0, parseInt(stored,10)||0);
      } catch(_){}
      const el = document.getElementById('pointsValue');
      const attr = el?.getAttribute('data-amount');
      const base = attr ? parseInt(attr,10) : parseInt((el?.textContent||'').replace(/[^0-9]/g,''),10) || 0;
      try { localStorage.setItem(LS_KEY, String(base)); } catch(_){}
      return base;
    }
    function setPoints(v){
      const val = Math.max(0, Math.round(v||0));
      const el = document.getElementById('pointsValue');
      if (el){ el.setAttribute('data-amount', String(val)); el.textContent = (val).toLocaleString('es-CO'); }
      try { localStorage.setItem(LS_KEY, String(val)); } catch(_){}
    }
    function award(points, reason){
      const cur = getPoints();
      setPoints(cur + Math.max(0, Math.round(points||0)));
      if (window.ActivityTracker){
        window.ActivityTracker.add({ type:'points', points: Math.round(points||0), title:'Puntos', desc: reason || `Ganas ${Math.round(points||0)} puntos` });
      }
      if (window.showToast) showToast(`+${Math.round(points||0)} pts ${reason? '· '+reason : ''}`, 'success');
    }
    function spend(cost, reason){
      const cur = getPoints();
      const c = Math.max(0, Math.round(cost||0));
      if (cur < c){ if (window.showToast) showToast('Puntos insuficientes', 'error'); return false; }
      setPoints(cur - c);
      if (window.ActivityTracker){ window.ActivityTracker.add({ type:'points', points: -c, title:'Canje', desc: reason || `Canjeas ${c} puntos` }); }
      if (window.showToast) showToast(`-${c} pts ${reason? '· '+reason : ''}`, 'info');
      return true;
    }
    function init(){ setPoints(getPoints()); }
    window.awardPoints = award;
    window.spendPoints = spend;
    if (document.readyState !== 'loading') init();
    else document.addEventListener('DOMContentLoaded', init, { once:true });
  })();
  </script>
  <style id="show-mini-effects">
    #screenFlash { pointer-events: none; }
    #screenFlash.red-mode { background: #7f1d1d !important; opacity: 0.92 !important; }
    #screenFlash.pulse-red { animation: redPulse .6s ease-in-out infinite; }
    @keyframes redPulse { 0%{opacity:.35} 50%{opacity:.92} 100%{opacity:.35} }
  </style>
  <!-- Neutral, simple mobile UI skin (no color commitment) -->
  <style id="neutral-mobile-ui">
    :root{
      --ui-bg-1:#121212; /* cards */
      --ui-bg-2:#191919; /* buttons */
      --ui-bg-3:#0f0f0f; /* surfaces */
      --ui-stroke:#2b2b2b; /* borders */
      --ui-fg:#f3f4f6;     /* text */
      --ui-muted:#9ca3af;  /* secondary text */
    }
    /* Base text & surfaces */
    body[data-ui="neutral"]{ color:var(--ui-fg); }
    body[data-ui="neutral"] .bg-america-dark\/90,
    body[data-ui="neutral"] .bg-america-dark\/95,
    body[data-ui="neutral"] .bg-gray-900.rounded-xl,
    body[data-ui="neutral"] .glass-card{
      background:var(--ui-bg-1) !important;
      border-color:var(--ui-stroke) !important;
      box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03) !important;
    }
    /* Buttons: unify style without relying on a specific color */
    body[data-ui="neutral"] button,
    body[data-ui="neutral"] .btn{
      background:linear-gradient(180deg,var(--ui-bg-2),#131313) !important;
      border:1px solid var(--ui-stroke) !important;
      color:#fff !important;
      border-radius:14px !important;
      min-height:44px; min-width:44px;
      box-shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 6px 12px rgba(0,0,0,.35) !important;
      transition:background .18s ease, border-color .18s ease, transform .06s ease, box-shadow .18s ease !important;
    }
    body[data-ui="neutral"] button:hover,
    body[data-ui="neutral"] .btn:hover{
      background:linear-gradient(180deg,#1c1c1c,#141414) !important;
      border-color:#3a3a3a !important;
      box-shadow:0 0 0 2px rgba(255,255,255,.06) !important;
      transform:translateY(-1px);
    }
    body[data-ui="neutral"] button:active,
    body[data-ui="neutral"] .btn:active{ transform:translateY(1px); }
    /* Explicit red buttons become neutral without changing markup */
    body[data-ui="neutral"] button[class*="bg-america-red"],
    body[data-ui="neutral"] a[class*="bg-america-red"]{
      background:linear-gradient(180deg,var(--ui-bg-2),#131313) !important;
      border:1px solid var(--ui-stroke) !important;
      color:#fff !important;
    }
    /* Inputs & selects */
    body[data-ui="neutral"] input[type="text"],
    body[data-ui="neutral"] input[type="number"],
    body[data-ui="neutral"] input[type="tel"],
    body[data-ui="neutral"] input[type="email"],
    body[data-ui="neutral"] input[type="password"],
    body[data-ui="neutral"] select,
    body[data-ui="neutral"] textarea{
      background:rgba(26,26,26,.95) !important;
      border:1px solid var(--ui-stroke) !important;
      color:var(--ui-fg) !important;
      border-radius:12px !important;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    }
    body[data-ui="neutral"] input:focus,
    body[data-ui="neutral"] select:focus,
    body[data-ui="neutral"] textarea:focus{
      outline: none !important;
      border-color:#3a3a3a !important;
      box-shadow:0 0 0 3px rgba(255,255,255,.08) !important;
    }
    /* Chips / small pills */
    body[data-ui="neutral"] .chip,
    body[data-ui="neutral"] .promo-pill{
      background:#141414 !important;
      border:1px solid var(--ui-stroke) !important;
      color:var(--ui-fg) !important;
      border-radius:999px !important;
    }
    /* Toggles mimic simple flat style */
    body[data-ui="neutral"] .form-switch input[type="checkbox"]{ accent-color:#e5e7eb; }
    /* Neutral links */
    body[data-ui="neutral"] a{ color:#e5e7eb; }
    body[data-ui="neutral"] a:hover{ color:#fafafa; }
  </style>
  <script id="show-mini-script">
  (function(){
    const showBtn = document.getElementById('showNavBtn');
    const showModal = document.getElementById('showModal');
    const closeShow = document.getElementById('closeShowModal');
    const openFlashFromShow = document.getElementById('openFlashFromShow');
    const openTriviaFromShow = document.getElementById('openTriviaFromShow');
    const toggleRedBtn = document.getElementById('toggleRedFromShow');
    const toggleVibrateBtn = document.getElementById('toggleVibrateFromShow');
    const screenFlash = document.getElementById('screenFlash');

    function openShow(){ if(!showModal) return; showModal.classList.remove('hidden'); showModal.classList.add('flex'); feather?.replace?.(); try{ window.FamilyStats?.incMatchForCurrentUniqueToday?.(); window.ActivityTracker?.add?.({ type:'attendance', title:'Asistencia', desc:'Check-in por Show' }); if (typeof showGlobalOverlay==='function') showGlobalOverlay({ type:'success', message:'Check-in por Show', duration:1200 }); }catch(_){} }
    function closeShowModal(){ if(!showModal) return; showModal.classList.add('hidden'); showModal.classList.remove('flex'); }
    showBtn?.addEventListener('click', openShow);
    // Exponer para menú
    window.openShowModal = openShow;
    closeShow?.addEventListener('click', closeShowModal);
    showModal?.addEventListener('click', (e)=>{ if(e.target === showModal) closeShowModal(); });

    function openFlash(){ const m=document.getElementById('flashModal'); if(!m) return; m.classList.remove('hidden'); m.classList.add('flex'); feather?.replace?.(); }
    openFlashFromShow?.addEventListener('click', openFlash);
    function openTrivia(){ const m=document.getElementById('triviaModal'); if(!m) return; m.classList.remove('hidden'); m.classList.add('flex'); feather?.replace?.(); }
    openTriviaFromShow?.addEventListener('click', openTrivia);

    // Pantalla roja
    let redOn=false; function applyRed(on){ if(!screenFlash) return; screenFlash.classList.toggle('hidden', !on); screenFlash.classList.toggle('red-mode', on); screenFlash.classList.toggle('pulse-red', on); }
    toggleRedBtn?.addEventListener('click', ()=>{ document.getElementById('flashStopBtn')?.click(); redOn=!redOn; applyRed(redOn); toggleRedBtn.classList.toggle('ring-2', redOn); toggleRedBtn.classList.toggle('ring-america-red', redOn); });

    // Vibración robusta
    let vibOn=false, vibTimer=null; function stopV(){ vibOn=false; if(vibTimer){ clearTimeout(vibTimer); vibTimer=null;} try{navigator.vibrate(0);}catch(_){} }
    function startV(){ if(!('vibrate' in navigator)){ window.showToast?.('Vibración no soportada','error'); return; } vibOn=true; const period=600, short=90, gap=120, rest=Math.max(60,period-short-gap-short); const loop=()=>{ if(!vibOn) return; try{navigator.vibrate([short,gap,short,rest]);}catch(_){} vibTimer=setTimeout(loop, short+gap+short+rest); }; loop(); }
    toggleVibrateBtn?.addEventListener('click', ()=>{ if(vibOn){ stopV(); toggleVibrateBtn.classList.remove('ring-2','ring-america-red'); } else { startV(); toggleVibrateBtn.classList.add('ring-2','ring-america-red'); } });

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stopV(); if(redOn){ redOn=false; applyRed(false); } } });
    window.addEventListener('beforeunload', ()=>{ stopV(); applyRed(false); });
  })();
  </script>
  <script id="devils-canvas-script">
    (()=>{
      const TAU = Math.PI*2;
      let canvas, ctx, W, H, sprites=[];
      const MAX = 18;
      const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      function rand(a,b){ return a + Math.random()*(b-a); }
      function initSprites(){
        sprites = Array.from({length: MAX}, ()=>({
          x: rand(0, W), y: rand(0, H),
          vx: rand(-0.08, 0.08), vy: rand(0.02, 0.12),
          r: rand(-0.5, 0.5), vr: rand(-0.002, 0.002),
          s: rand(0.6, 1.8), a: rand(0.06, 0.16)
        }));
      }
      function resize(){
        if(!canvas) return;
        const {innerWidth, innerHeight} = window;
        W = innerWidth; H = innerHeight;
        canvas.width = Math.floor(W*DPR);
        canvas.height = Math.floor(H*DPR);
        canvas.style.width = W+'px';
        canvas.style.height = H+'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
        initSprites();
      }
      function drawDevil(size=24){
        ctx.strokeStyle = 'rgba(211,47,47,0.85)';
        ctx.fillStyle = 'rgba(211,47,47,0.18)';
        ctx.lineWidth = 1.5;
        ctx.shadowColor = 'rgba(211,47,47,0.35)';
        ctx.shadowBlur = 6;
        const r = size*0.4;
        ctx.beginPath(); ctx.arc(0,0,r,0,TAU); ctx.fill(); ctx.stroke();
        const hornW = r*0.9, hornH = r*0.8;
        ctx.beginPath();
        ctx.moveTo(-r*0.4,-r*0.2);
        ctx.lineTo(-r*0.4 - hornW*0.2, -r - hornH*0.2);
        ctx.lineTo(-r*0.1, -r*0.3);
        ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(r*0.4,-r*0.2);
        ctx.lineTo(r*0.4 + hornW*0.2, -r - hornH*0.2);
        ctx.lineTo(r*0.1, -r*0.3);
        ctx.closePath(); ctx.fill(); ctx.stroke();
        const h = size*1.6;
        ctx.beginPath();
        ctx.moveTo(r*0.2, r*0.6);
        ctx.lineTo(r*0.2, r*0.6 + h);
        const baseY = r*0.6; const tH = r*0.9;
        ctx.moveTo(r*0.2, baseY);
        ctx.lineTo(r*0.2 - r*0.35, baseY + tH);
        ctx.moveTo(r*0.2, baseY);
        ctx.lineTo(r*0.2 + r*0.35, baseY + tH);
        ctx.stroke();
        ctx.shadowBlur = 0;
      }
      function step(){
        ctx.clearRect(0,0,W,H);
        for(const sp of sprites){
          sp.x += sp.vx; sp.y += sp.vy; sp.r += sp.vr;
          if (sp.y > H + 40) { sp.y = -40; sp.x = rand(0, W); }
          if (sp.x < -40) sp.x = W + 40; else if (sp.x > W + 40) sp.x = -40;
          ctx.save();
          ctx.globalAlpha = sp.a;
          ctx.translate(sp.x, sp.y);
          ctx.rotate(sp.r);
          ctx.scale(sp.s, sp.s);
          drawDevil(22);
          ctx.restore();
        }
        requestAnimationFrame(step);
      }
      function start(){
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        canvas = document.getElementById('devilsCanvas');
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        resize();
        requestAnimationFrame(step);
        window.addEventListener('resize', resize, { passive: true });
        document.addEventListener('visibilitychange', ()=>{ if (document.hidden) ctx && ctx.clearRect(0,0,W,H); });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start); else start();
    })();
  </script>
  <script id="flash-script">
  (function(){
    let flashStream = null;
    let flashTrack = null;
    let flashTimer = null;
    let running = false;
    let pattern = 'strobe';

    const flashModal = document.getElementById('flashModal');
    const openBtn = document.getElementById('flashNavBtn');
    const closeBtn = document.getElementById('closeFlashModal');
    const bpmInput = document.getElementById('flashBpm');
    const hzLabel = document.getElementById('flashHz');
    const startBtn = document.getElementById('flashStartBtn');
    const stopBtn = document.getElementById('flashStopBtn');
    const screenFlash = document.getElementById('screenFlash');

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function bpmToHz(bpm){ return bpm/60; }
    function updateHz(){ if (!hzLabel || !bpmInput) return; hzLabel.textContent = bpmToHz(+bpmInput.value).toFixed(1); }
    updateHz(); bpmInput?.addEventListener('input', updateHz);

    function openModal(){ if(!flashModal) return; flashModal.classList.remove('hidden'); flashModal.classList.add('flex'); feather?.replace?.(); }
    function closeModal(){ if(!flashModal) return; flashModal.classList.add('hidden'); flashModal.classList.remove('flex'); stopFlash(); }
    openBtn?.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);
    flashModal?.addEventListener('click', (e)=>{ if(e.target === flashModal) closeModal(); });

    // Patrón selector
    Array.from(document.querySelectorAll('.flash-pattern')).forEach(btn=>{
      btn.addEventListener('click', ()=>{ pattern = btn.dataset.pattern || 'strobe'; showToast('Patrón: '+pattern, 'info'); });
    });

    async function getTorchTrack(){
      // Intenta reutilizar la cámara del QR si existe
      let track = null;
      try {
        if (window.qrStream && qrStream.getVideoTracks && qrStream.getVideoTracks().length){
          track = qrStream.getVideoTracks()[0];
        } else if (flashStream && flashStream.getVideoTracks().length){
          track = flashStream.getVideoTracks()[0];
        } else {
          flashStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
          track = flashStream.getVideoTracks()[0];
        }
      } catch(e){ throw e; }
      const caps = track.getCapabilities?.();
      if (!caps || !caps.torch){
        throw new Error('Este dispositivo/navegador no permite controlar el flash (torch).');
      }
      return track;
    }

    async function torch(track, on){
      try { await track.applyConstraints({ advanced: [{ torch: !!on }] }); }
      catch(e){ console.warn('No fue posible cambiar torch', e); }
    }

    function fallback(on){
      if (!screenFlash) return;
      screenFlash.classList.toggle('hidden', !on);
    }

    function schedule(fn, ms){ return setTimeout(fn, ms); }

    async function startFlash(){
      if (running) return; running = true;
      let usingFallback = false;
      try { flashTrack = await getTorchTrack(); }
      catch(e){ usingFallback = true; showToast(e.message || 'Flash no soportado, usando pantalla', 'info'); }

      const bpm = clamp(+bpmInput.value||120, 30, 180);
      const period = 60000 / bpm; // ms por beat

      const run = async () => {
        if (!running) return;
        if (pattern === 'strobe'){
          const onMs = clamp(Math.round(period*0.18), 30, 120);
          const offMs = Math.max(30, Math.round(period - onMs));
          if (usingFallback) { fallback(true); } else { await torch(flashTrack, true); }
          flashTimer = schedule(async ()=>{
            if (usingFallback) { fallback(false); } else { await torch(flashTrack, false); }
            flashTimer = schedule(run, offMs);
          }, onMs);
        }
        else if (pattern === 'pulse'){
          // doble pulso por beat
          const short = clamp(Math.round(period*0.12), 30, 90);
          const gap = clamp(Math.round(period*0.12), 30, 120);
          const rest = Math.max(60, Math.round(period - short - gap - short));
          const pulseOnce = async () => { if (usingFallback) { fallback(true); } else { await torch(flashTrack, true); } };
          const off = async () => { if (usingFallback) { fallback(false); } else { await torch(flashTrack, false); } };
          await pulseOnce();
          flashTimer = schedule(async ()=>{ await off(); flashTimer = schedule(async ()=>{ await pulseOnce(); flashTimer = schedule(async ()=>{ await off(); flashTimer = schedule(run, rest); }, short); }, gap); }, short);
        }
        else if (pattern === 'sos'){
          // ··· --- ···  (punto=200ms, raya=600ms, espacios 200ms, pausa entre letras 600ms, entre palabras 1400ms aprox)
          const u = 200; // unidad base
          const seq = [1,0,1,0,1,0, 3,0,3,0,3,0, 1,0,1,0,1]; // 1=punto, 3=raya, 0=espacio unidad
          let i=0;
          const step = async () => {
            if (!running) return;
            const val = seq[i];
            if (val>0){ if (usingFallback) { fallback(true); } else { await torch(flashTrack, true); } }
            const dur = (val>0 ? (val===1?u:3*u) : u);
            flashTimer = schedule(async ()=>{
              if (val>0){ if (usingFallback) { fallback(false); } else { await torch(flashTrack, false); } }
              i = (i+1) % seq.length;
              // pausa extra al final del patrón
              if (i===0) flashTimer = schedule(step, 7*u); else flashTimer = schedule(step, 0);
            }, dur);
          };
          step();
        }
      };
      run();
      showToast('Luces iniciadas', 'success');
    }

    function stopFlash(){
      running = false;
      if (flashTimer){ clearTimeout(flashTimer); flashTimer = null; }
      try { if (flashTrack) torch(flashTrack, false); } catch(e){}
      fallback(false);
    }

    startBtn?.addEventListener('click', startFlash);
    stopBtn?.addEventListener('click', stopFlash);

    // Apaga si cambia visibilidad o al cerrar sesión
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stopFlash(); });
    window.addEventListener('beforeunload', stopFlash);
  })();
  </script>
</body>
</html>